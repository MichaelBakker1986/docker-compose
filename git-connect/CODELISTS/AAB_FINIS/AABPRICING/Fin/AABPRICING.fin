{&&Language=English}
$>FiNiS Pricing<$

.ModelVersion          1.39.01
.FINANversion          3.2

.Period  MainPeriod,Title="main period",FormulaSet=NoTrend,FormulaSetTitle="hist",FormulaSet2=Trend,FormulaSet2Title="progn",FirstYear=2005,Years=4,MaxTsY=12,TsY=12,TsY2=12,DateAtFormulaSet2=DMYtoDate(1,1,ThisYear)

.Sheet   1,Title="main sheet",Period=MainPeriod
 
.Variables
PP       X     0               "$>FiNiS Pricing<$ v#CompactModelVersion#"                          \Root

.Variables
{&&TryInclude IncFesVars.fin}
{&&TryInclude IncFpsVars.fin}

.Variables
;===========================================================================================================================================
; Q_ROOT

PP      1N C 1 1               "$>FiNiS Pricing<$"                                                 \Q_ROOT

.Choices
Q_ROOT                         = "0:$>Complete<$.|1:$>Not complete<$."

.Formulas NoTrend
Q_ROOT                         = If( (Q_Map01[1]=1)  Or (Length(&scKnockoutsCombi[1])>0),1,0)


.Variables
;================================================================================================== MAP 1
PP      1N C   2               $>AAB Pricing<$                                                    	\Q_Map01
                                                                                                   	
;---------------                                                                                   	
; WARNING PANELS                                                                                   	
                                                                                                   	
PP      1A   1 3               $>Warning voor map<$                                                	\Q_Map01_WARNING
PP      1A     3               $>Info bij stap<$                                                   	\Q_Map01_INFO
PP      1A     3               $>Validatie stap<$                                                  	\Q_Map01_VALIDATION


;--------- Scenario (Agreement)          
.Variables                                                                                   						 
PP      1N     3               $>Agreement<$                                                        \Agreement
PP      1A     4               =AgreementNumber												        \=AgreementNumber
PI      1A     4               Agreement identifier                                                 \AgreementIdentifier
;=================================Test variabelen knop ==============================

PI      1N C   4               Show Test Variables                                                   \ShowTestVariables
PI      1N C   4               Target RaRoRaC Driven Calculation                                     \TargetRaRoRaCDriven

.Choices
ShowTestVariables = "1:Yes|0:No"
TargetRaRoRaCDriven = "1:Yes|0:No"

.Formulas Notrend
ShowTestVariables = 0
TargetRaRoRaCDriven = If(TupleSum(Facility_tpCustomerSpread2)=NA, 1, 0)
;====================================================================================

.Variables
;PP      1N     4               $>Kredietcomplex gegevens<$												                  \AgreementInput
; ---> Basis valuta
; ---> status

.Variable AgreementHiddenfields, Visible= ShowTestVariables 
PI      1X     4       -       $>Hidden fields for calculations<$                                   \AgreementHiddenfields
PI      1A     5               $>Agreement<$                                                        \AgreementNumber                          ;; wordt gevuld met Agreement Number vanuit Force
PI    2 1N %   5               $>Diversifivation Factor for Operational Risk<$                      \AgreementDiversificationOR                                                                                                     
PI    2 1N %   5               $>Diversifivation Factor for Business Risk<$                         \AgreementDiversificationBR
PI    2 1N %   5               $>Diversifivation Factor for Credit Risk<$                           \AgreementDiversificationCR
PI      1N     5       -       $>Maximum Remaining Tenor Agreement (months)<$	          	        \AgreementMaxRemainingTenor  

PI      1N     5       -       $>Number of Borrowers<$                                              \AgreementNumberOfBorrowers
PI    2 1N     5       +       $>Cost per Service Concept - Fixed Cost Operating Concept<$          \AgreementFixedCostOperatingConcept
PI    2 1N %   5               $>Percentage Service Concept<$                                       \AgreementPercentageOperatingConcept
PI    2 1N %   5               $>Subordinated Debt Capital Charge - Sub Debt Ratio (%)<$            \AgreementSubDebtRatio
PI    0 1N     5               $>Subordinated Debt Capital Charge - Cost of Subordination (bp)<$    \AgreementCostOfSubordination
PI      1N     5               $>Available Amount of Equity<$                                       \AgreementAvailableAmountOfEquity    ;#User#    wordt niet gebruikt in SONAR dus default op nul

.Formulas Visible
AgreementHiddenfields = ShowTestVariables

.Formulas NoTrend
AgreementMaxRemainingTenor		   	  	= TupleMax(Facility_tpRemainingTenor)
AgreementDiversificationOR          	= MatrixLookup("AAB_Parameters.xls","CalculationParameters","OPERATIONALRISK",2)
AgreementDiversificationBR          	= MatrixLookup("AAB_Parameters.xls","CalculationParameters","BUSINESSRISK",2)
AgreementDiversificationCR          	= MatrixLookup("AAB_Parameters.xls","CalculationParameters","CREDITRISK",2)
AgreementNumberOfBorrowers   	        = 1 ;TupleCount(Borrower_tpIncome)
AgreementFixedCostOperatingConcept	  = Borrower_tpAmountFixedCostOperatingConceptClientGroup ;TupleMax(Borrower_tpAmountFixedCostOperatingConceptClientGroup)
AgreementPercentageOperatingConcept   = Borrower_tpPercentageOperatingConcept                 ;TupleMax(Borrower_tpPercentageOperatingConcept)
AgreementSubDebtRatio                 = (MatrixLookup("AAB_Parameters.xls","CalculationParameters","SUBORDDEBTRATIOPERC",2))       
AgreementCostOfSubordination          = Matrixlookup("AAB_Parameters.xls","CalculationParameters","COSTOFSUBORDBP",2)    
AgreementAvailableAmountOfEquity      = 0  ;#User#    wordt niet gebruikt in SONAR dus default op nul  
                     
;--------- Agreement ---------
.Variables     

PP      1X     4               Profit and Losses																		 	   		     	  

;PP      1N     5               Profit and Losses - Credits                                          \AgreementProfitAndLoss  
;PP      1N     5               Profit and Losses - Cross Sell                                       \AgreementProfitAndLoss  
PP      1N     5       -       Profit and Losses - Clients                                          \AgreementProfitAndLoss                                                                                                                                 
PP    0 1N     6       +       Revenues                                                             \AgreementIncome 
PP      1N     7               Interest income                                                      \AgreementInterestIncome  
PP      1N     7               Credit related fees                                                  \AgreementCreditRelatedFee
PP     -1N     6               Indirect Liquidity Costs                                             \AgreementIndirectLiquidityCosts 
PP     -1N     6               Direct Liquidity Premium                                             \AgreementDirectLiquidityPremium 
PP     -1N     6               Subordinated Debt Capital Charge                                     \AgreementSubordinatedDebtCapitalCharge 
PP      1N     6               Equity Funding Adjustment                                            \AgreementEquityFundingAdjustment
PP     -1N     6               Operational Costs                                                    \AgreementOperationalCosts  
PP     -1N     6               Internal Expected Loss                                               \AgreementInternalExpectedLoss 
PP     -1N     6               Tax                                                                  \AgreementTax
PP    0 1N    -6               Risk adjusted return                                                 \AgreementRiskAdjustedReturn
                                                                                                    
PP    2 1N %   6               Return On Equity                                                     \AgreementReturnOnEquity
;PP      1N     7               &Facility_tpRiskAdjustedReturn                                       \AgreementRiskAdjustedReturn 
PP      1N     7               Risk Adjusted Capital                                                \AgreementRiskAdjustedCapital
;PP    2 1N %  -7               &Facility_tpReturnOnEquity                                           \AgreementReturnOnEquity
                                                                                                    
PP    2 1N %   6               RaRoRaC        																             				  \AgreementRaRoRaC
;PP      1N     7               &Facility_tpRiskAdjustedReturn                                       \AgreementRiskAdjustedReturn 
PP      1N     7               Economic Capital                                                     \AgreementEconomicCapital
PI      1N     8               $>Economic Capital - Operational Risk<$   					                 	\AgreementOperationalRisk
PI      1N     8               $>Economic Capital - Business Risk<$   					                  	\AgreementBusinessRisk
PI      1N     8               $>Economic Capital - Credit Risk<$   					                    	\AgreementCreditRisk
;PP    2 1N %  -7               &Facility_tpRaRoRaC        																			  	  \AgreementRaRoRaC
                                                                                                    
PP    0 1N     6               Regulatory Profit                                                    \AgreementRegulatoryProfit
;PP      1N     7               &Facility_tpRiskAdjustedReturn                                       \AgreementRiskAdjustedReturn
PP      1N     7               Equity Capital Charge                                                \AgreementEquityCapitalCharge   
;PP      1N    -7               &Facility_tpRegulatoryProfit                                         \AgreementRegulatoryProfit
                                                                                                    
PP    0 1N     6               Economic Profit                                                      \AgreementEconomicProfit
;PP      1N     7               &Facility_tpRiskAdjustedReturn                                       \AgreementRiskAdjustedReturn
;PP      1N     7               &Facility_tpEconomicCapital                                          \AgreementEconomicCapital 
PP      1N     7               Effective Cost Of Capital                                            \AgreementEffectiveCostOfCapital
;PP      1N    -7               &Facility_tpEconomicProfit                                           \AgreementEconomicProfit
                                                                                                    
PP      1N     6               Other Metrics        																           			\AgreementOtherMetrics
PP      1N     7               Principal Limit                                                      \AgreementPrincipalLimit             
PP      1N     7               Expected Average Outstanding                                         \AgreementExpectedAverageOutstanding  
;PP      1N     7               &Facility_tpInternalExpectedLoss                                     \AgreementInternalExpectedLoss  
PP      1N     7               RWA                                                                  \AgreementRWA  
PP      1N     8               RWA Credit Risk                                                      \AgreementRWACreditRisk     
PP      1N     8               RWA Operational Risk                                                 \AgreementRWAOperationalRisk
PP      1N     7               EAD                                                                  \AgreementEAD 
                                                                                
.Formulas NoTrend                                                                              
;Borrower_tpProfitAndLoss                  = 
AgreementIncome                         = (Borrower_tpIncome)                                                                                        ;TupleSum(Borrower_tpIncome)                                                                                
AgreementInterestIncome                 = (Borrower_tpInterestIncome)                                                                                ;TupleSum(Borrower_tpInterestIncome)                                                                        
AgreementCreditRelatedFee               = (Borrower_tpCreditRelatedFee)                                                                              ;TupleSum(Borrower_tpCreditRelatedFee)                                                                      
AgreementIndirectLiquidityCosts         = (Borrower_tpIndirectLiquidityCosts)                                                                        ;TupleSum(Borrower_tpIndirectLiquidityCosts)                                                                
AgreementDirectLiquidityPremium         = (Borrower_tpDirectLiquidityPremium)                                                                        ;TupleSum(Borrower_tpDirectLiquidityPremium)   ; C ---> pas op voor de weighted outstanding                 
AgreementOperationalCosts               = (Borrower_tpOperationalCosts)                                                                              ;TupleSum(Borrower_tpOperationalCosts)   ;C--> pas op voor de kosten van het bedieningsconcept              
AgreementSubordinatedDebtCapitalCharge  = (Borrower_tpSubordinatedDebtCapitalCharge)                                                                 ;TupleSum(Borrower_tpSubordinatedDebtCapitalCharge)                                                         
AgreementEquityFundingAdjustment        = (Borrower_tpEquityFundingAdjustment)                                                                       ;TupleSum(Borrower_tpEquityFundingAdjustment)                                                               
                                                                                                                                                             ;                                                                                                           
AgreementInternalExpectedLoss           = (Borrower_tpInternalExpectedLoss)                                                                          ;TupleSum(Borrower_tpInternalExpectedLoss)                                                                  
AgreementTax                            = (Borrower_tpTax)                                                                                           ;TupleSum(Borrower_tpTax)                                                                                   
                                                                                                                                                     ;                                                                                                           
AgreementRiskAdjustedReturn             = (Borrower_tpRiskAdjustedReturn)                                                                            ;TupleSum(Borrower_tpRiskAdjustedReturn)                                                                    
;AgreementRiskAdjustedCapital            = (Borrower_tpRiskAdjustedCapital)                                                                           ;TupleSum(Borrower_tpRiskAdjustedCapital)                                                                   
AgreementReturnOnEquity                 = OnER(AgreementRiskAdjustedReturn/AgreementRiskAdjustedCapital,NA)                                          ;OnER(AgreementRiskAdjustedReturn/AgreementRiskAdjustedCapital,NA)                                                                                                    
AgreementRaRoRaC                        = OnER(AgreementRiskAdjustedReturn/AgreementEconomicCapital,NA)                                              ;OnER(AgreementRiskAdjustedReturn/AgreementEconomicCapital,NA)                                        
                                                                                                                                                     ;                                                                                                           
AgreementEconomicCapital                = AgreementOperationalRisk+AgreementBusinessRisk+AgreementCreditRisk                                         ;AgreementOperationalRisk+AgreementBusinessRisk+AgreementCreditRisk                                
AgreementOperationalRisk                = (Borrower_tpOperationalRisk)                                                                               ;TupleSum(Borrower_tpOperationalRisk)                                                                       
AgreementBusinessRisk                   = (Borrower_tpBusinessRisk)                                                                                  ;TupleSum(Borrower_tpBusinessRisk)                                                                          
AgreementCreditRisk                     = (Borrower_tpCreditRisk)                                                                                    ;TupleSum(Borrower_tpCreditRisk)                                                                            
                                                                                                                                                                                                                                                               
AgreementRegulatoryProfit               = OnER(AgreementRiskAdjustedReturn-AgreementEquityCapitalCharge,NA)                                          ;OnER(AgreementRiskAdjustedReturn-AgreementEquityCapitalCharge,NA)                                    
AgreementEquityCapitalCharge            = (Borrower_tpEquityCapitalCharge)                                                                           ;TupleSum(Borrower_tpEquityCapitalCharge)                                                                   
AgreementEconomicProfit                 = OnER(Borrower_tpRiskAdjustedReturn-(AgreementEconomicCapital*Borrower_tpEffectiveCostOfCapital),NA)        ;OnER(Borrower_tpRiskAdjustedReturn-(AgreementEconomicCapital*Borrower_tpEffectiveCostOfCapital),NA)     
AgreementPrincipalLimit                 = (Borrower_tpPrincipalLimit)                                                                                ;TupleSum(Borrower_tpPrincipalLimit)                                                                        
AgreementExpectedAverageOutstanding     = (Borrower_tpExpectedAverageOutstanding)                                                                    ;TupleSum(Borrower_tpExpectedAverageOutstanding)                                                                           
AgreementRWA                            = (Borrower_tpRWA)                                                                                           ;TupleSum(Borrower_tpRWA)                                                                                   
AgreementRWACreditRisk                  = (Borrower_tpRWACreditRisk)                                                                                 ;TupleSum(Borrower_tpRWACreditRisk)                                                                         
AgreementRWAOperationalRisk             = (Borrower_tpRWAOperationalRisk)                                                                            ;TupleSum(Borrower_tpRWAOperationalRisk)                                                                    
AgreementEAD                            = (Borrower_tpEAD)                                                                                           ;TupleSum(Borrower_tpEAD)                                                                                   



;--------- Borrower (Customer)

.Variables
PI      1N     3               $>Borrower<$                                                             \Borrower
                                                                                                        

;====================================== Required Input ==========================

.Variables                                                                                                                                                                                                                                                                                                 
PP      1X     4       -       $>Client details<$												                                \Borrower_tpInput
PI      1A     5               $>Borrower Reference<$                                                   \Borrower_tpReferenceNumber              ;; Titel aangepast voor Compact Report
PI      1N C   5               $>Base Currency of Borrower<$                             		        \Borrower_tpBaseCurrencyChoice
PI      1A     5               $>Currency<$                                                             \Borrower_tpBaseCurrency                 ;; Titel aangepast voor Compact Report
PI      1A     5               $>Client Group Code<$                                                    \Borrower_tpClientGroup 
PI      1N C   5               $>Client Group<$                                                         \Borrower_tpClientGroupChoice
PI      1N C   5               $>Do you want to use an AGIC or SBI identification code?<$               \Borrower_tpAGICOrSBI
PI      1N C   5               $>AGIC Sector<$                                                          \Borrower_tpAGICChoice
PP      1A     5               $>AGIC Code<$                                                            \Borrower_tpAGIC                     
PP      1N C   5               $>Financial Institution Choice<$                                         \Borrower_tpFinancialInstitutionChoice
PI      1N C   5               $>Under Supervision<$                                                    \Borrower_tpUnderSupervision       
PI      1N C   5               $>Booking location<$                                                     \Borrower_tpBookingLocationChoice
PI      1N     5               $>Asset Size (mio)<$                                                     \Borrower_tpAssetSize2                     

;================================== Imported Data ====================

PP      1X     4       -       &"$>Imported Data<$"                                                     \Borrower_tpDataImportedFromForce    
PI      1A     5               $>UCR<$                                                                  \Borrower_tpMainBorrowerLabeledRating
;C Variable is used in pricing service. Variable name can therefore not be adjusted. 
PI      1A     5               $>Borrower Name<$                                                        \Borrower_tpName                         ;; Titel aangepast voor Compact Report
PI      1A     5               $>SBI branche code (Geen lijst)<$                                        \Borrower_tpSBI                           ;wordt nu doorgegeven via een service
PI      1A     5               $>PD Model<$                                                             \Borrower_tpPDModel                      ;; Titel aangepast voor Compact Report

;================================== Automatic Input =============================
                                                                                                        
PP      1X     4       -       $>Automatic Input<$  					                                \Borrower_tpAutomaticInput
PP      1A     5               $>Client Group<$                                                         \Borrower_tpClientGroupFullName
PI      1A     5               $>Sector type (SBI or AGIC)<$                                            \Borrower_tpSectorType
PI      1A     5               $>Sector code<$                                                          \Borrower_tpSectorCode
PI      1A     5               $>Booking location Tekst<$                                               \Borrower_tpBookingLocation
PI    2 1N %   5               $>Tax Rate<$                                                             \Borrower_tpTaxRate
PI      1A     5               $>UCR Rating<$                                                           \Borrower_tpRating                        ;; Titel aangepast voor Compact Report                                                                                                   
PI    4 1N %   5               $>Probability of Default (%)<$                                           \Borrower_tpPD
PI    4 1N %   5               $>Probability of Default  MoC (%)<$                                      \Borrower_tpPDMoC                                                                                                             
PI      1N     5               $>Asset Size (mio)<$                                                     \Borrower_tpAssetSize
PI      1A     5               $>PD Model<$                                                             \Borrower_tpPDModelFullName 
PI    4 1N     5               $>MoC Factor<$                                                           \Borrower_tpMoCFactor
PI    3 1N     5               $>ARC Add-on<$                                                           \Borrower_tpARCAddOn
PI    6 1N     5               $>Risk Weight<$                                                          \Borrower_tpRiskWeight
PI    5 1N     5               $>Rho<$                                                                  \Borrower_tpRho   
PI    0 1N     5               $>Equity Index<$                                                         \Borrower_tpEquityIndex
PI      1A     5               $>Financial Institution Description<$                                    \Borrower_tpFinancialInstitution
PI    6 1N     5               $>Calibration Factor<$                                                   \Borrower_tpCalibrationFactor
PI      1A     5               $>Calibration Factor ID<$                                                \Borrower_tpCalibrationFactorID			 
PI    0 1N     5       +       $>Exposure At Default<$                                                  \Borrower_tpEAD
PI      1N     5               $>Average EAD<$                                                          \Borrower_tpAverageEAD   
PI      1N     5               $>Total Expected Average Outstanding Borrower<$	      		            \Borrower_tpSumExpectedAverageOutstanding  
PI      1N     5       -       $>Number of Facilities<$											        \Borrower_tpNrOfFacilities
PI    2 1N %   5               $>Equity Ratio<$                                                         \Borrower_tpEquityRatio
PI    2 1N %   5               $>Cost of Equity<$                                                       \Borrower_tpCostofEquity
PI    2 1N %   5               $>Confidence Level<$                                                     \Borrower_tpConfidenceLevel
PI    2 1N %   5               $>Effective Cost of Capital (%)<$                                        \Borrower_tpEffectiveCostOfCapital
PI    2 1N     5               $>Fixed Cost Operating Concept<$                                         \Borrower_tpFixedCostOperatingConcept
PI    2 1N     5               $>Amount Fixed Cost Operating Concept for Client Group<$                 \Borrower_tpAmountFixedCostOperatingConceptClientGroup
PI      1N C   5               $>PL / NPL account<$                                                     \Borrower_tpPLorNPL                                
PI      1N     5               $>Cross Sell Total Income<$                                              \Borrower_tpNonCreditIncome_Total
PI      1N     5               $>Cross Sell Total Costs<$                                               \Borrower_tpNonCreditCosts_Total
PI      1N     5               $>Non Credit Costs - Cost Per Service Concept<$                          \Borrower_tpNonCreditCostsCostPerServiceConcept
PI    2 1N %   5               $>Credit Cost per Service Concept - Percentage Operating Concept<$       \Borrower_tpPercentageOperatingConcept
PP      1A     5               $>SBI branche naam<$                                                     \Borrower_tpSBIName

;------------------------------- Hidden variables for compact report ---------------------------------------------------------------------------------------------

X       1N     5               Hidden variables for Borrower section Compact Report                     \Borrower_tpHiddenVariablesBorrowerInformation
PI      1A     6               $>AGIC/SBI Code<$                                                        \Borrower_tpBrancheDescriptionCompactReport 
PI      1A     6               $>AGIC Sector Description<$                                              \Borrower_tpAGICChoiceName     
                                                                                                             

.Choices
Borrower_tpClientGroupChoice                   = file "Choice_BorrowerClientGroup.fib"
Borrower_tpAGICOrSBI                           = "0:AGIC|1:SBI"
Borrower_tpBookingLocationChoice               = file "Choice_BookingLocation.fib"
Borrower_tpAGICChoice                          = file "Choice_AGIC.fib"
Borrower_tpFinancialInstitutionChoice          = "1:Yes|0:No"
Borrower_tpUnderSupervision                    = "1:Yes|0:No"
Borrower_tpBaseCurrencyChoice                  = file "Choice_Currency.fib"
Borrower_tpPLorNPL                             = "1:PL|0:NPL"    
                                               
.Formulas InputRequired                      
Borrower_tpClientGroupChoice                   = 1
Borrower_tpAssetSize2                          = 1

                                               
.Formulas Visible
Borrower_tpBaseCurrency                        = 0                ;; invisible because: title including translation is needed + Compact Report needs ViewCurrency, and currently unknown how to read viewCurrency into variable value.
Borrower_tpClientGroup                         = ShowTestVariables
Borrower_tpDataImportedFromForce               = ShowTestVariables                             
Borrower_tpAutomaticInput                      = ShowTestVariables
Borrower_tpSBI                                 = Borrower_tpAGICOrSBI=1
Borrower_tpSBIName                             = Borrower_tpAGICOrSBI=1
Borrower_tpAGICChoice                          = Borrower_tpAGICOrSBI=0
Borrower_tpAGIC                                = Borrower_tpAGICOrSBI=0

.Formulas NoTrend
Borrower_tpName                                = &FPS_VAR_Naam
Borrower_tpReferenceNumber                     = &FPS_VAR_Relatienummer
Borrower_tpSectorCode                          = &FPS_VAR_BIK_CODE
Borrower_tpSectorType                          = &FPS_VAR_SECTOR_OF_INDUSTRY_CODE_TYPE
Borrower_tpBaseCurrencyChoice                  = 01
Borrower_tpBaseCurrency                        = &TableLookup("Choice_Currency",Borrower_tpBaseCurrencyChoice)
Borrower_tpClientGroupChoice                   = 18 ; Commercial Clients-RM_A3
Borrower_tpClientGroup                         = &SubStr(&TableLookup("Choice_BorrowerClientGroup",Borrower_tpClientGroupChoice),0,3)
Borrower_tpClientGroupFullName                 = &SubStr(&TableLookup("Choice_BorrowerClientGroup",Borrower_tpClientGroupChoice),7,99)
Borrower_tpAGICOrSBI                           = If(&Borrower_tpSectorType="AGIC",0,If(&Borrower_tpSectorType="SBI",1,NA))
Borrower_tpSBIName                             = &MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Borrower_tpSBI,1)
Borrower_tpSBI                                 = &If(&Borrower_tpSectorType="SBI",&Borrower_tpSectorCode,NA)
Borrower_tpAGIC                                = &SubStr(&TableLookup("Choice_AGIC",Borrower_tpAGICChoice),0,4) 
Borrower_tpAGICChoiceName                      = &SubStr(&TableLookup("Choice_AGIC",Val(&Borrower_tpAGIC)),8,99)       ;&SubStr(&TableLookup("Choice_AGIC",Borrower_tpAGICChoice),8,99)
Borrower_tpFinancialInstitutionChoice          = If(Borrower_tpAGICOrSBI=0,If(MatrixLookup("AAB_Parameters.xls","AGICMapping","@"&Borrower_tpAGIC,3)=1,1,0),If(MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Borrower_tpSBI,3)=1,1,0))
Borrower_tpUnderSupervision                    = 0
Borrower_tpRating                              = &Borrower_tpMainBorrowerLabeledRating ;&TableLookup("Choice_UCR",Borrower_tpRatingChoice)  
Borrower_tpBookingLocationChoice               = 20 ; Nederland
Borrower_tpBookingLocation                     = &TableLookup("Choice_BookingLocation",Borrower_tpBookingLocationChoice)    
Borrower_tpTaxRate                             = MatrixLookup("AAB_Parameters.xls","TaxRate",&Borrower_tpBookingLocation,1)             
Borrower_tpPDModelFullName                     = &MatrixLookup("AAB_Parameters.xls","VertaaltabelPDModel",Borrower_tpPDModel,1)
Borrower_tpAssetSize                           = Borrower_tpAssetSize2
Borrower_tpAssetSize2                          = MatrixLookup("AAB_Parameters.xls","CalculationParameters","DEFAULT_ASSET_SIZE",2) 
Borrower_tpPD                                  = MatrixLookup("AAB_Parameters.xls","PD",&Borrower_tpRating,1)
Borrower_tpPDMoC                               = Borrower_tpPD*Borrower_tpMoCFactor
Borrower_tpMoCFactor                           = MatrixLookup("AAB_Parameters.xls","MOCFactorPD",&Borrower_tpPDModel,1)            
Borrower_tpARCAddOn                            = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,2)        
Borrower_tpRiskWeight                          = CumNormal((InvNormal(Borrower_tpPDMoC)-((Borrower_tpRho^0.5)*(InvNormal(1-Borrower_tpConfidenceLevel))))/((1-Borrower_tpRho)^0.5))
Borrower_tpRho                                 = MatrixLookup("AAB_Parameters.xls","EquityIndex",Borrower_tpEquityIndex,4) 
Borrower_tpEquityIndex                         = If(Borrower_tpAGICOrSBI=0,MatrixLookup("AAB_Parameters.xls","AGICMapping","@"&Borrower_tpAGIC,2),MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Borrower_tpSBI,2))
Borrower_tpFinancialInstitution                = &If(Borrower_tpAGICOrSBI=0,&MatrixLookup("AAB_Parameters.xls","AGICMapping","@"&Borrower_tpAGIC,4),&MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Borrower_tpSBI,4)) 
Borrower_tpCalibrationFactor                   = MatrixLookup("AAB_Parameters.xls","CalibrationFactor",&Borrower_tpCalibrationFactorID,3)
Borrower_tpCalibrationFactorID                 = &Borrower_tpRating&"_"&Borrower_tpClientGroup
Borrower_tpSumExpectedAverageOutstanding       = TupleSum(Facility_tpExpectedAverageOutstanding)
Borrower_tpNrOfFacilities						         	 = TupleCount(Facility_tpID) 
Borrower_tpEquityRatio                         = Matrixlookup("AAB_Parameters.xls","CalculationParameters","AllocatedEquityRatio",2)
Borrower_tpCostofEquity                        = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,6)
Borrower_tpConfidenceLevel                     = MatrixLookup("AAB_Parameters.xls","CalculationParameters","ConfidenceLevel",2)
Borrower_tpEffectiveCostOfCapital              = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,8)
Borrower_tpFixedCostOperatingConcept           = AgreementFixedCostOperatingConcept/AgreementNumberOfBorrowers
Borrower_tpNonCreditIncome_Total               = TupleSum(Borrower_tpNonCredit_tpIncome_Amount)
Borrower_tpNonCreditCosts_Total                = TupleSum(Borrower_tpNonCredit_tpCosts)+Borrower_tpNonCreditCostsCostPerServiceConcept
Borrower_tpNonCreditCostsCostPerServiceConcept = (1-AgreementPercentageOperatingConcept)*Borrower_tpFixedCostOperatingConcept 
Borrower_tpPercentageOperatingConcept          = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,5)
Borrower_tpAmountFixedCostOperatingConceptClientGroup = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,4)
Borrower_tpBrancheDescriptionCompactReport     = &If(Borrower_tpAGICOrSBI=0,&Borrower_tpAGICChoiceName,&Borrower_tpSBIName) 
Borrower_tpPLorNPL                             = 1

;; ================== Borrower P/L Credit =========================================================================
.Variables     

PI      1X     4       -       Profit and Losses - Credit                                           \Borrower_tpProfitAndLossClient                                                                                                                                 
PI    0 1N     5       +       Revenues                                                             \Borrower_tpIncome 
PI      1N     6               Interest income                                                      \Borrower_tpInterestIncome  
PI      1N     6               Credit related fees                                                  \Borrower_tpCreditRelatedFee
PI     -1N     5               Option Costs/Ind. Liq. Premium                                       \Borrower_tpOptionCostsIndLiqPremium
PI     -1N     6               Indirect Liquidity Costs                                             \Borrower_tpIndirectLiquidityCosts
PI     -1N     6               Prepayment Costs                                                     \Borrower_tpPrepaymentCosts      
PI     -1N     6               Pipeline Risk                                                        \Borrower_tpPipelineRisk         
PI     -1N     5               Direct Liquidity Premium                                             \Borrower_tpDirectLiquidityPremium 
PI     -1N     5               Subordinated Debt Capital Charge                                     \Borrower_tpSubordinatedDebtCapitalCharge 
PI      1N     5               Equity Funding Adjustment                                            \Borrower_tpEquityFundingAdjustment
PI     -1N     5               Operational Costs                                                    \Borrower_tpOperationalCosts
PI     -1N     6               Cost per Contract                                                    \Borrower_tpCostPerContract
PI     -1N     6               Cost per Service Concept                                             \Borrower_tpCostPerServiceConcept
PI     -1N     6               Cost over Volume                                                     \Borrower_tpCostOverVolume
PI     -1N     5               Internal Expected Loss                                               \Borrower_tpInternalExpectedLoss 
PI     -1N     5               Tax                                                                  \Borrower_tpTax
PI    0 1N    -5       +       Risk Adjusted Return                                                 \Borrower_tpRiskAdjustedReturn

PI    2 1N %   5               Return On Equity                                                     \Borrower_tpReturnOnEquity
PI      1N     6               Required Amount of Equity                                            \Borrower_tpRequiredAmountOfEquity


PI    2 1N %   5               RaRoRaC                                                              \Borrower_tpRaRoRaC
PI      1N     6               Economic Capital                                                     \Borrower_tpEconomicCapital
PI      1N     7               $>Economic Capital - Operational Risk<$   					                  \Borrower_tpOperationalRisk
PI      1N     7               $>Economic Capital - Business Risk<$   					                    \Borrower_tpBusinessRisk
PI      1N     7               $>Economic Capital - Credit Risk<$   					                      \Borrower_tpCreditRisk

                               
PI    0 1N     5       +       Regulatory Profit                                                    \Borrower_tpRegulatoryProfit
PI      1N     6               Equity Capital Charge                                                \Borrower_tpEquityCapitalCharge   
                               
PI    0 1N     5       +       Economic Profit                                                      \Borrower_tpEconomicProfit
PI    0 1N     6               Risk Adjusted Return                                                 \=Borrower_tpRiskAdjustedReturn
PI     -1N     6               Cost of Economic Capital                                             \Borrower_tpCostOfEconomicCapital
PI      1N     7               Economic Capital                                                     \=Borrower_tpEconomicCapital
PI     x1N %   7               Effective Cost of Capital                                            \=Borrower_tpEffectiveCostOfCapital
                                
PI      1X     5       -       Other Metrics        											                          \Borrower_tpOtherMetrics
PI    0 1N     6       +       Principal Limit                                                      \Borrower_tpPrincipalLimit             
PI      1N     6               ExpectedAverageOutstanding                                           \Borrower_tpExpectedAverageOutstanding  

PI      1N     6               RWA                                                                  \Borrower_tpRWA
PI      1N     7               RWA Credit Risk                                                      \Borrower_tpRWACreditRisk
PI      1N     7               RWA Operational Risk                                                 \Borrower_tpRWAOperationalRisk
PI      1N     6               EAD                                                                  \=Borrower_tpEAD


; -------------------------- Hidden variables voor P/L calculations ------------------

X       1N     5               Hidden variables voor P/L Compact Report                              \Borrower_tpHiddenVariables
PI      1N     6               Total Facility Equity Funding Adjustment                              \Borrower_tpFacilityEquityFundingAdjustmentTotal
PI      1N     6               Total Facility RWA excl. X-sell                                       \Borrower_tpFacilityRWATotal
PI     -1N     6               Tax and Other                                                         \Borrower_tpTaxAndOther


.Formulas NoTrend
Borrower_tpIncome                                   = Borrower_tpInterestIncome+Borrower_tpCreditRelatedFee
Borrower_tpInterestIncome                           = TupleSum(Facility_tpInterestIncome)
Borrower_tpCreditRelatedFee                         = TupleSum(Facility_tpCreditRelatedFee)
Borrower_tpIndirectLiquidityCosts                   = TupleSum(Facility_tpIndirectLiquidityCosts)  
Borrower_tpOptionCostsIndLiqPremium                 = TupleSum(Facility_tpOptionCostsIndLiqPrem)
Borrower_tpPrepaymentCosts                          = TupleSum(Facility_tpPrepaymentCosts)
Borrower_tpPipelineRisk                             = TupleSum(Facility_tpPipelineRisk)
Borrower_tpDirectLiquidityPremium                   = TupleSum(Facility_tpDirectLiquidityPremium)   
Borrower_tpOperationalCosts                         = Borrower_tpCostPerContract+Borrower_tpCostOverVolume+Borrower_tpCostPerServiceConcept
Borrower_tpCostPerContract                          = TupleSum(Facility_tpCostPerContract)
Borrower_tpCostPerServiceConcept                    = Borrower_tpFixedCostOperatingConcept*AgreementPercentageOperatingConcept
Borrower_tpCostOverVolume                           = TupleSum(Facility_tpCostOverVolume)
Borrower_tpSubordinatedDebtCapitalCharge            = TupleSum(Facility_tpSubordinatedDebtCapitalCharge)
Borrower_tpEquityFundingAdjustment                  = TupleSum(Facility_tpEquityFundingAdjustment)
Borrower_tpFacilityRWATotal                         = TupleSum(Facility_tpRWA)
Borrower_tpInternalExpectedLoss                     = TupleSum(Facility_tpInternalExpectedLoss)
Borrower_tpTax                                      = (Borrower_tpIncome-Borrower_tpPrepaymentCosts-Borrower_tpPipelineRisk-Borrower_tpIndirectLiquidityCosts-Borrower_tpDirectLiquidityPremium-Borrower_tpOperationalCosts-Borrower_tpSubordinatedDebtCapitalCharge+Borrower_tpEquityFundingAdjustment-Borrower_tpInternalExpectedLoss)*Borrower_tpTaxRate
Borrower_tpTaxAndOTher                              = Borrower_tpSubordinatedDebtCapitalCharge+Borrower_tpEquityFundingAdjustment+Borrower_tpTax
Borrower_tpRiskAdjustedReturn                       = Borrower_tpIncome-Borrower_tpPrepaymentCosts-Borrower_tpPipelineRisk-Borrower_tpIndirectLiquidityCosts-Borrower_tpDirectLiquidityPremium-Borrower_tpOperationalCosts-Borrower_tpSubordinatedDebtCapitalCharge+Borrower_tpEquityFundingAdjustment-Borrower_tpInternalExpectedLoss-Borrower_tpTax 
Borrower_tpRequiredAmountOfEquity                   = TupleSum(Facility_tpRequiredAmountofEquity)
Borrower_tpReturnOnEquity                           = OnER(Borrower_tpRiskAdjustedReturn/Borrower_tpRequiredAmountOfEquity,NA)
Borrower_tpRaRoRaC                                  = OnER(Borrower_tpRiskAdjustedReturn/Borrower_tpEconomicCapital,NA)  
Borrower_tpEconomicCapital                          = Borrower_tpOperationalRisk+Borrower_tpBusinessRisk+Borrower_tpCreditRisk
Borrower_tpOperationalRisk                          = TupleSum(Facility_tpORCreditRisk)
Borrower_tpBusinessRisk                             = TupleSum(Facility_tpBRCreditRisk)
Borrower_tpCreditRisk                               = TupleSum(Facility_tpCreditRisk)
Borrower_tpRegulatoryProfit                         = OnER(Borrower_tpRiskAdjustedReturn-Borrower_tpEquityCapitalCharge,NA)
Borrower_tpEquityCapitalCharge                      = TupleSum(Facility_tpEquityCapitalCharge)
Borrower_tpEconomicProfit                           = OnER(Borrower_tpRiskAdjustedReturn-(Borrower_tpEconomicCapital*Borrower_tpEffectiveCostOfCapital),NA)
Borrower_tpCostOfEconomicCapital                    = Borrower_tpEconomicCapital*Borrower_tpEffectiveCostOfCapital
Borrower_tpPrincipalLimit                           = TupleSum(Facility_tpPrincipalLimit)
Borrower_tpExpectedAverageOutstanding               = TupleSum(Facility_tpExpectedAverageOutstanding) 
Borrower_tpRWA                                      = Borrower_tpRWACreditRisk+Borrower_tpRWAOperationalRisk
Borrower_tpRWACreditRisk                            = TupleSum(Facility_tpRWACreditRisk)
Borrower_tpRWAOperationalRisk                       = TupleSum(Facility_tpRWAOperationalRisk)
Borrower_tpEAD                                      = TupleSum(Facility_tpEAD)    



;; ================== Borrower P/L Cross Sell =========================================================================
.Variables     
PI      1X     4       -       Profit and Losses - Cross Sell                                       \Borrower_tpCrossSellProfitAndLossClient                                                                                                                                 
PI    0 1N     5       +       Revenues                                                             \Borrower_tpCrossSellIncome 
PI     -1N     5               Indirect Liquidity Costs                                             \Borrower_tpCrossSellIndirectLiquidityCosts 
PI     -1N     5               Direct Liquidity Premium                                             \Borrower_tpCrossSellDirectLiquidityPremium 
PI     -1N     5               Subordinated Debt Capital Charge                                     \Borrower_tpCrossSellSubordinatedDebtCapitalCharge 
PI      1N     5               Equity Funding Adjustment                                            \Borrower_tpCrossSellEquityFundingAdjustment
PI     -1N     5               Operational Costs                                                    \Borrower_tpCrossSellOperationalCosts
PI     -1N     5               Internal Expected Loss                                               \Borrower_tpCrossSellInternalExpectedLoss 
PI     -1N     5               Tax                                                                  \Borrower_tpCrossSellTax
PI    0 1N    -5       +       Risk Adjusted Return                                                 \Borrower_tpCrossSellRiskAdjustedReturn

PI    2 1N %   5               $>Return On Equity<$                                                 \Borrower_tpCrossSellReturnOnEquity
PI      1N     6               Required Amount of Equity                                            \Borrower_tpCrossSellRequiredAmountOfEquity

PI    2 1N %   5               $>RaRoRaC<$                                                          \Borrower_tpCrossSellRaRoRaC                  ;; is ingeschakeld voor rapportage
PI      1N     6               $>Economic Capital<$                                                 \Borrower_tpCrossSellEconomicCapital          ;; is ingeschakeld voor rapportage
PI      1N     7               $>Economic Capital - Operational Risk<$   					                 	\Borrower_tpCrossSellOperationalRisk
PI      1N     7               $>Economic Capital - Business Risk<$   					                  	\Borrower_tpCrossSellBusinessRisk

                              
PI    0 1N     5       +       $>Regulatory Profit<$                                                \Borrower_tpCrossSellRegulatoryProfit
PI      1N     6               Equity Capital Charge                                                \Borrower_tpCrossSellEquityCapitalCharge   

                               
PI    0 1N     5       +       Economic Profit                                                      \Borrower_tpCrossSellEconomicProfit
PI    0 1N     6               Risk Adjusted Return                                                 \=Borrower_tpCrossSellRiskAdjustedReturn
PI     -1N     6               Cost of Economic Capital                                             \Borrower_tpCrossSellCostOfEconomicCapital
PI      1N     7               Economic Capital                                                     \=Borrower_tpCrossSellEconomicCapital
PI     x1N %   7               Effective Cost of Capital                                            \=Borrower_tpEffectiveCostOfCapital                   
PI      1X     5       -       Other Metrics        																           			\Borrower_tpCrossSellOtherMetrics
  
PI      1N     6               RWA                                                                  \Borrower_tpCrossSellRWA
PI      1N     7               RWA Operational Risk                                                 \Borrower_tpCrossSellRWAOperationalRisk
PP      1N     6               Total Non Credit Net Income                                          \Borrower_tpCrossSellNonCreditNetIncome_Total

.Formulas NoTrend

Borrower_tpCrossSellIncome                         = OnNA(Borrower_tpNonCreditIncome_Total,0)
Borrower_tpCrossSellIndirectLiquidityCosts         = 0  
Borrower_tpCrossSellDirectLiquidityPremium         = 0   ; C ---> pas op voor de weighted outstanding
Borrower_tpCrossSellOperationalCosts               = OnNA(Borrower_tpNonCreditCosts_Total,0)   ;C--> pas op voor de kosten van het bedieningsconcept
Borrower_tpCrossSellSubordinatedDebtCapitalCharge  = OnNA(If(AgreementMaxRemainingTenor<12,(Borrower_tpCrossSellRWAOperationalRisk*AgreementSubDebtRatio*(AgreementCostOfSubordination/10000))*(AgreementMaxRemainingTenor/12),Borrower_tpCrossSellRWAOperationalRisk*AgreementSubDebtRatio*(AgreementCostOfSubordination/10000)),0)
Borrower_tpCrossSellEquityFundingAdjustment        = OnER(If(AgreementMaxRemainingTenor<12,((Borrower_tpCrossSellRWAOperationalRisk*Borrower_tpEquityRatio-AgreementAvailableAmountOfEquity)*(MatrixLookup("AAB_Parameters.xls","CalculationParameters","3MAANDSEURIBORBP",2)/10000))*(AgreementMaxRemainingTenor/12),((Borrower_tpCrossSellRWAOperationalRisk*Borrower_tpEquityRatio-AgreementAvailableAmountOfEquity)*(MatrixLookup("AAB_Parameters.xls","CalculationParameters","3MAANDSEURIBORBP",2)/10000))),NA)

Borrower_tpCrossSellInternalExpectedLoss           = 0
Borrower_tpCrossSellTax                            = (Borrower_tpNonCreditIncome_Total-Borrower_tpNonCreditCosts_Total)*Borrower_tpTaxRate
Borrower_tpCrossSellRiskAdjustedReturn             = Borrower_tpCrossSellIncome-Borrower_tpCrossSellIndirectLiquidityCosts-Borrower_tpCrossSellDirectLiquidityPremium-Borrower_tpCrossSellOperationalCosts-Borrower_tpCrossSellSubordinatedDebtCapitalCharge+Borrower_tpCrossSellEquityFundingAdjustment-Borrower_tpCrossSellInternalExpectedLoss-Borrower_tpCrossSellTax 

Borrower_tpCrossSellReturnOnEquity                 = OnER(Borrower_tpCrossSellRiskAdjustedReturn/Borrower_tpCrossSellRequiredAmountOfEquity,NA)        
Borrower_tpCrossSellRequiredAmountOfEquity         = OnNA(Borrower_tpCrossSellRWA*Borrower_tpEquityRatio,0)
Borrower_tpCrossSellRaRoRaC                        = OnER(Borrower_tpCrossSellRiskAdjustedReturn/Borrower_tpCrossSellEconomicCapital,NA)        
                
Borrower_tpCrossSellEconomicCapital                = OnNA(Borrower_tpCrossSellOperationalRisk+Borrower_tpCrossSellBusinessRisk,0)         
Borrower_tpCrossSellOperationalRisk                = OnNA(TupleSum(Borrower_tpNonCredit_tpORNonCreditRisk),0)
Borrower_tpCrossSellBusinessRisk                   = OnNA(TupleSum(Borrower_tpNonCredit_tpBRNonCreditRisk),0)

Borrower_tpCrossSellRegulatoryProfit               = OnER(Borrower_tpCrossSellRiskAdjustedReturn-Borrower_tpCrossSellEquityCapitalCharge,NA)
Borrower_tpCrossSellEquityCapitalCharge            = OnNA(TupleSum(Borrower_tpNonCredit_tpEquityCapitalCharge),0) 
Borrower_tpCrossSellEconomicProfit                 = OnER(Borrower_tpCrossSellRiskAdjustedReturn-(Borrower_tpCrossSellEconomicCapital*Borrower_tpEffectiveCostOfCapital),NA)
Borrower_tpCrossSellCostOfEconomicCapital          = Borrower_tpCrossSellEconomicCapital*Borrower_tpEffectiveCostOfCapital
Borrower_tpCrossSellRWA                            = OnNA(Borrower_tpCrossSellRWAOperationalRisk,0)
Borrower_tpCrossSellRWAOperationalRisk             = OnNA(TupleSum(Borrower_tpNonCredit_tpRWAORNonCredit),0)


Borrower_tpCrossSellNonCreditNetIncome_Total       = Borrower_tpNonCreditIncome_Total-Borrower_tpNonCreditCosts_Total




;; ================== Borrower P/L Client =========================================================================
.Variables
PP      1X     4       -       Profit and Losses - Client                                           \Borrower_tpClientProfitAndLossClient                                                                                                                                 
PP    0 1N     5       +       Revenues                                                             \Borrower_tpClientIncome 
PP      1N     6               Interest income                                                      \Borrower_tpClientInterestIncome  
PP      1N     6               Credit related fees                                                  \Borrower_tpClientCreditRelatedFee
PP      1N     6               Total Non Credit Income										        \Borrower_tpClientNonCreditIncome_Total
PP     -1N     5               Option Costs/Indirect Liquidity Costs                                \Borrower_tpClientOptionCostsIndLiqPremium
PP     -1N     6               Indirect Liquidity Costs                                             \Borrower_tpClientIndirectLiquidityCosts
PP     -1N     6               Prepayment Costs                                                     \Borrower_tpClientPrepaymentCosts  
PP     -1N     6               Pipeline Risk                                                        \Borrower_tpClientPipelineRisk           
PP     -1N     5               Direct Liquidity Premium                                             \Borrower_tpClientDirectLiquidityPremium 
PP     -1N     5               Subordinated Debt Capital Charge                                     \Borrower_tpClientSubordinatedDebtCapitalCharge 
PP      1N     5               Equity Funding Adjustment                                            \Borrower_tpClientEquityFundingAdjustment
PP     -1N     5               Operational Costs                                                    \Borrower_tpClientOperationalCosts
PP      1N     6               Cost per Service Concept                                             \Borrower_tpClientCostPerServiceConcept
PP      1N     6               Cost per Contract                                                    \Borrower_tpClientCostPerContract
PP      1N     6               Cost Over Volume                                                     \Borrower_tpClientCostOverVolume
PP      1N     6               Total Non Credit Costs 											                        \Borrower_tpClientNonCreditCosts_Total  
PP     -1N     5               Internal Expected Loss                                               \Borrower_tpClientInternalExpectedLoss 
PP     -1N     5               Tax                                                                  \Borrower_tpClientTax
PP    0 1N    -5       +       Risk Adjusted Return                                                 \Borrower_tpClientRiskAdjustedReturn

PP    2 1N %   5               Return On Equity                                                     \Borrower_tpClientReturnOnEquity
PP      1N     6               Required Amount Of Equity                                            \Borrower_tpClientRequiredAmountOfEquity

PP    2 1N %   5               RaRoRaC        														                          \Borrower_tpClientRaRoRaC
PP      1N     6               Economic Capital                                                     \Borrower_tpClientEconomicCapital
PI      1N     7               $>Economic Capital - Operational Risk<$   					                  \Borrower_tpClientOperationalRisk
PI      1N     7               $>Economic Capital - Business Risk<$   					                    \Borrower_tpClientBusinessRisk
PI      1N     7               $>Economic Capital - Credit Risk<$   					                      \Borrower_tpClientCreditRisk
                               
PP    0 1N     5       +       Regulatory Profit                                                    \Borrower_tpClientRegulatoryProfit
PP      1N     6               Equity Capital Charge                                                \Borrower_tpClientEquityCapitalCharge   
                               
PI    0 1N     5       +       Economic Profit                                                      \Borrower_tpClientEconomicProfit
PI    0 1N     6               Risk Adjusted Return                                                 \=Borrower_tpClientRiskAdjustedReturn
PI     -1N     6               Cost of Economic Capital                                             \Borrower_tpClientCostOfEconomicCapital
PI      1N     7               Economic Capital                                                     \=Borrower_tpClientEconomicCapital
PI     x1N %   7               Effective Cost of Capital                                            \=Borrower_tpEffectiveCostOfCapital
                                
PP      1X     5       -       Other Metrics        								                      			    \Borrower_tpClientOtherMetrics
PP      1N     6               Principal Limit                                                      \Borrower_tpClientPrincipalLimit             
PP      1N     6               ExpectedAverageOutstanding                                           \Borrower_tpClientOutstanding  
PP      1N     6               RWA                                                                  \Borrower_tpClientRWA
PP      1N     7               RWA Credit Risk                                                      \Borrower_tpClientRWACreditRisk
PP      1N     7               RWA Operational Risk                                                 \Borrower_tpClientRWAOperationalRisk
PP      1N     6               EAD                                                                  \Borrower_tpClientEAD
PP      1N     6               Total Non Credit Net Income                                          \Borrower_tpClientNonCreditNetIncome_Total

; -------------------------- Hidden variables voor P/L calculations ------------------

X       1N     5               Hidden variables voor P/L Compact Report                              \Borrower_tpClientHiddenVariables
PI      1N     6               Tax and Other                                                         \Borrower_tpClientTaxAndOther

.Formulas NoTrend
Borrower_tpClientIncome                         = Borrower_tpIncome+Borrower_tpCrossSellIncome  
Borrower_tpClientInterestIncome                 = Borrower_tpInterestIncome
Borrower_tpClientCreditRelatedFee               = Borrower_tpCreditRelatedFee
Borrower_tpClientNonCreditIncome_Total          = OnNA(Borrower_tpNonCreditIncome_Total,0)
Borrower_tpClientOptionCostsIndLiqPremium       = Borrower_tpOptionCostsIndLiqPremium
Borrower_tpClientNonCreditCosts_Total           = OnNA(Borrower_tpNonCreditCosts_Total,0)
Borrower_tpClientIndirectLiquidityCosts         = Borrower_tpIndirectLiquidityCosts+Borrower_tpCrossSellIndirectLiquidityCosts
Borrower_tpClientPrepaymentCosts                = Borrower_tpPrepaymentCosts
Borrower_tpClientPipelineRisk                   = Borrower_tpPipelineRisk
Borrower_tpClientDirectLiquidityPremium         = Borrower_tpDirectLiquidityPremium+Borrower_tpCrossSellDirectLiquidityPremium                                  ; C ---> pas op voor de weighted outstanding
Borrower_tpClientOperationalCosts               = Borrower_tpOperationalCosts+Borrower_tpCrossSellOperationalCosts    
Borrower_tpClientCostPerServiceConcept          = Borrower_tpCostPerServiceConcept  
Borrower_tpClientCostOverVolume                 = Borrower_tpCostOverVolume 
Borrower_tpClientCostPerContract                = Borrower_tpCostPerContract      
Borrower_tpClientSubordinatedDebtCapitalCharge  = Borrower_tpSubordinatedDebtCapitalCharge+Borrower_tpCrossSellSubordinatedDebtCapitalCharge
Borrower_tpClientEquityFundingAdjustment        = Borrower_tpEquityFundingAdjustment+Borrower_tpCrossSellEquityFundingAdjustment
Borrower_tpClientInternalExpectedLoss           = Borrower_tpInternalExpectedLoss+Borrower_tpCrossSellInternalExpectedLoss                                      ;; TupleSum(Facility_tpInternalExpectedLoss)
Borrower_tpClientTax                            = Borrower_tpTax+Borrower_tpCrossSellTax
Borrower_tpClientTaxAndOther                    = Borrower_tpClientSubordinatedDebtCapitalCharge+Borrower_tpClientEquityFundingAdjustment+Borrower_tpClientTax                        ;; -99 voor compact report. Is optelling van sub debt capital charge + equity funding adjustment + tax
Borrower_tpClientRiskAdjustedReturn             = Borrower_tpRiskAdjustedReturn+Borrower_tpCrossSellRiskAdjustedReturn                                          ;; -99 voor compact report  Borrower_tpIncome-Borrower_tpIndirectLiquidityCosts-Borrower_tpDirectLiquidityPremium-Borrower_tpOperationalCosts-Borrower_tpSubordinatedDebtCapitalCharge+Borrower_tpEquityFundingAdjustment-Borrower_tpInternalExpectedLoss-Borrower_tpTax 
Borrower_tpClientReturnOnEquity                 = OnER(Borrower_tpClientRiskAdjustedReturn/Borrower_tpClientRequiredAmountOfEquity,NA)                                           ;; -99 voor compact report OnER(Borrower_tpRiskAdjustedReturn/Borrower_tpRiskAdjustedCapital,NA)
Borrower_tpClientRequiredAmountOfEquity         = Borrower_tpRequiredAmountOfEquity+Borrower_tpCrossSellRequiredAmountOfEquity 
Borrower_tpClientRaRoRaC                        = OnER(Borrower_tpClientRiskAdjustedReturn/Borrower_tpClientEconomicCapital,NA)                                          ;; -99 voor compact report OnER(Borrower_tpRiskAdjustedReturn/Borrower_tpEconomicCapital,NA)  

Borrower_tpClientEconomicCapital                = Borrower_tpEconomicCapital+Borrower_tpCrossSellEconomicCapital                                                ;; -99 voor compact report Borrower_tpOperationalRisk+Borrower_tpBusinessRisk+Borrower_tpCreditRisk
Borrower_tpClientOperationalRisk                = Borrower_tpOperationalRisk+Borrower_tpCrossSellOperationalRisk
Borrower_tpClientBusinessRisk                   = Borrower_tpBusinessRisk+Borrower_tpCrossSellBusinessRisk
Borrower_tpClientCreditRisk                     = Borrower_tpCreditRisk
Borrower_tpClientRegulatoryProfit               = OnER(Borrower_tpClientRiskAdjustedReturn-Borrower_tpClientEquityCapitalCharge,NA)                                ;; -99 voor compact report OnER(Borrower_tpRiskAdjustedReturn-Borrower_tpEquityCapitalCharge,NA)
Borrower_tpClientEquityCapitalCharge            = Borrower_tpEquityCapitalCharge+Borrower_tpCrossSellEquityCapitalCharge
Borrower_tpClientEconomicProfit                 = OnER(Borrower_tpClientRiskAdjustedReturn-(Borrower_tpClientEconomicCapital*Borrower_tpEffectiveCostOfCapital),NA)
Borrower_tpClientCostOfEconomicCapital          = Borrower_tpClientEconomicCapital*Borrower_tpEffectiveCostOfCapital
Borrower_tpClientPrincipalLimit                 = Borrower_tpPrincipalLimit
Borrower_tpClientOutstanding                    = Borrower_tpExpectedAverageOutstanding
Borrower_tpClientRWA                            = Borrower_tpRWA+Borrower_tpCrossSellRWA                                                                        ;; -99 voor compact report Borrower_tpRWACreditRisk+Borrower_tpRWAOperationalRisk
Borrower_tpClientRWACreditRisk                  = Borrower_tpRWACreditRisk
Borrower_tpClientRWAOperationalRisk             = Borrower_tpRWAOperationalRisk+Borrower_tpCrossSellRWAOperationalRisk
Borrower_tpClientEAD                            = Borrower_tpEAD   
Borrower_tpClientNonCreditNetIncome_Total       = Borrower_tpCrossSellNonCreditNetIncome_Total



;----------------------------------------------------------

;--------------- Non Credit income
.Variables

PI      1T     4               $>A Cross Sell item<$                                                                           						\Borrower_tpNonCredit

PP      1X     5       -       &"$>Imported Data for Cross Sell Items<$"                                                                  \Borrower_tpNonCredit_tpDataImportedFromForce 
PI      1A     6               $>Cross Sell Item Category Code<$                                                                          \Borrower_tpNonCredit_tpCategoryCode   
PI      1A     6               $>Cross Sell Item Name<$                                                                                   \Borrower_tpNonCredit_tpCategoryName
PI      1N     6               $>Prognosed Income for the next 12 months<$                                                                \Borrower_tpNonCredit_tpPrognosedIncomeNext12MonthsAmount
;PI      1A     6               $>Prognosed Income currency<$                                                                              \Borrower_tpNonCredit_tpPrognosedIncomeNext12MonthsCurrency
PI      1N     6               $>Realized Income for the next 12 months<$                                                                 \Borrower_tpNonCredit_tpRealizedIncomePast12MonthsAmount
;PI      1A     6               $>Realized Income currency<$                                                                               \Borrower_tpNonCredit_tpRealizedIncomePast12MonthsCurrency


PP      1A     5               $>Item Description<$                                                                                       \Borrower_tpNonCredit_tpName
PI      1N     5               $>Expected Income Upcoming 12 months<$                                    						                      \Borrower_tpNonCredit_tpIncome_Amount
PP      1N     5               $>Costs<$                                                                                      						\Borrower_tpNonCredit_tpCosts
PP      1N     5               $>Net Income<$                                                                                      				\Borrower_tpNonCredit_tpNetIncome

PP      1A     5               $>Borrower Client Group<$                                                                         		  		\Borrower_tpNonCredit_tpIncome_ClientGroup -> Borrower_tpClientGroup
PI      1A     5               $>ID<$                                                                                          			      \Borrower_tpNonCredit_tpIncome_ID
PI      1A     5               $>ID Total<$                                                                                    						\Borrower_tpNonCredit_tpIncome_IDtotal
        
PI    2 1N %   5               $>Risk Adjusted Return - Other Expenses - Operational Costs - Non Credit Costs - Eff. ratio<$  						\Borrower_tpNonCredit_tpCosts_EffRatio
  
PI      1N     5               $>Non Credit Economic Capital<$                                                            				        \Borrower_tpNonCredit_tpEC
PI      1N     6               $>Risk Adjusted Return - Non Credit EC Business Risk<$                                       					    \Borrower_tpNonCredit_tpBRNonCreditRisk
PI      1N     6               $>Risk Adjusted Return - EC Business Risk factor<$                                                     	  \Borrower_tpNonCredit_tpECbusr
PI      1N     6               $>Risk Adjusted Return - Non Credit EC Operational Risk<$                                     					   	\Borrower_tpNonCredit_tpORNonCreditRisk
PI      1N     6               $>Risk Adjusted Return - EC Operational Risk factor<$                                                      \Borrower_tpNonCredit_tpECopr
PI      1N     5               $>Risk Weighted Assets - RWA OR Non Credit<$                                                 						  \Borrower_tpNonCredit_tpRWAORNonCredit
PI      1N     5               $>Equity Capital Charge<$                                                                                  \Borrower_tpNonCredit_tpEquityCapitalCharge


.Formulas Visible   
Borrower_tpNonCredit_tpDataImportedFromForce       = ShowTestVariables               
Borrower_tpNonCredit_tpIncome_ClientGroup          = ShowTestVariables
Borrower_tpNonCredit_tpIncome_ID                   = ShowTestVariables
Borrower_tpNonCredit_tpIncome_IDtotal              = ShowTestVariables
Borrower_tpNonCredit_tpCosts_EffRatio              = ShowTestVariables
Borrower_tpNonCredit_tpEC                          = ShowTestVariables
Borrower_tpNonCredit_tpRWAORNonCredit              = ShowTestVariables
Borrower_tpNonCredit_tpEquityCapitalCharge         = ShowTestVariables 
Borrower_tpNonCredit_tpName                        = ShowTestVariables


.Formulas NoTrend
Borrower_tpNonCredit_tpName                        = &Borrower_tpNonCredit_tpCategoryName
Borrower_tpNonCredit_tpIncome_ID                   = &SubStr(&Borrower_tpNonCredit_tpCategoryCode,0,2)
Borrower_tpNonCredit_tpIncome_IDtotal              = &Borrower_tpNonCredit_tpCategoryCode                     
Borrower_tpNonCredit_tpIncome_Amount               = Borrower_tpNonCredit_tpPrognosedIncomeNext12MonthsAmount

Borrower_tpNonCredit_tpCosts                       = Borrower_tpNonCredit_tpIncome_Amount*Borrower_tpNonCredit_tpCosts_EffRatio                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
Borrower_tpNonCredit_tpCosts_EffRatio              = (MatrixLookup("AAB_Parameters.xls","NonCreditIncomeEffRatio",&Borrower_tpNonCredit_tpIncome_IDtotal,3))
Borrower_tpNonCredit_tpNetIncome                   = Borrower_tpNonCredit_tpIncome_Amount-Borrower_tpNonCredit_tpCosts

Borrower_tpNonCredit_tpEC                          = Borrower_tpNonCredit_tpORNonCreditRisk+Borrower_tpNonCredit_tpBRNonCreditRisk
Borrower_tpNonCredit_tpORNonCreditRisk             = Borrower_tpARCAddOn*AgreementDiversificationOR*(Borrower_tpNonCredit_tpIncome_Amount*(Borrower_tpNonCredit_tpECopr/10000))
Borrower_tpNonCredit_tpBRNonCreditRisk             = Borrower_tpARCAddOn*AgreementDiversificationBR*(Borrower_tpNonCredit_tpCosts*(Borrower_tpNonCredit_tpECbusr/10000))
Borrower_tpNonCredit_tpECopr                       = MatrixLookup("AAB_Parameters.xls","NonCreditECoprECBusr",&Borrower_tpNonCredit_tpIncome_ID,2)
Borrower_tpNonCredit_tpECbusr                      = MatrixLookup("AAB_Parameters.xls","NonCreditECoprECBusr",&Borrower_tpNonCredit_tpIncome_ID,3)
Borrower_tpNonCredit_tpRWAORNonCredit              = Borrower_tpNonCredit_tpIncome_Amount*MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,7)   
Borrower_tpNonCredit_tpEquityCapitalCharge         = Borrower_tpNonCredit_tpRWAORNonCredit*Borrower_tpEquityRatio*Borrower_tpCostofEquity 
                                                                            

;--------- FACILITY
.Variables                                                                                                						 
                              
                                                                                                                                 
PI      1T     4               $>Facility<$                                                                                   \Facility
                                                                                                                        
                                                                                   

;===================================================
.Variables                                                                                                                               
PP      1X     5               &"$>Data for UserView<$"                                                                       \Facility_tpDataForUserView
PP      1A     6               &Facility_tpProductname[1]                                                                     \Facility_tpSummary
PP      1A     6               $>Required fields<$                                                                            \Facility_tpInputRequired
PP      1N     6               $>Profit and losses<$                                                                          \Facility_tpProfitAndLoss  
PP    2 1N %   6               $>RaRoRaC (%)<$                                                                                \Facility_tpRaRoRaC
PP    0 1N     6               $>Economic Profit<$                                                                            \Facility_tpEconomicProfit
PP    0 1N     7               $>Cost of Economic Capital<$                                                                   \Facility_tpCostOfEconomicCapital
PP      1N %   7               $>Effective Cost of Economic Capital<$                                                         \Facility_tpEffectiveCostOfCapital
PP    2 1N %   6               $>Return on Equity (%)<$                                                                       \Facility_tpReturnOnEquity
PP    0 1N     6               $>Regulatory Profit<$                                                                          \Facility_tpRegulatoryProfit 
PP      1N     6               $>Other Metrics<$                                  																						\Facility_tpOtherMetrics

.Formulas Visible
Facility_tpDataForUserView = ShowTestVariables                                                                                                                        

.Formulas NoTrend
Facility_tpSummary   	  				   = &"Margin "&Str((Facility_tpCustomerSpread+Facility_tpCustomerSpreadAddMargin),0,3)&"% (RaRoRaC "&Str(Facility_tpRaRoRaC,0,2)&"%)"
Facility_tpInputRequired		   = &If(Facility_tpPrincipalLimit<>NA,"Complete","Incomplete") 
Facility_tpRaRoRaC                 = OnER(Facility_tpRiskAdjustedReturn/Facility_tpEconomicCapital,NA)
Facility_tpEconomicProfit          = OnER(Facility_tpRiskAdjustedReturn-Facility_tpCostOfEconomicCapital,NA)
Facility_tpCostOfEconomicCapital   = OnER(Facility_tpEconomicCapital*Borrower_tpEffectiveCostOfCapital*Facility_tpDeannualize,NA)
Facility_tpEffectiveCostOfCapital  = OnER(Borrower_tpEffectiveCostOfCapital,NA)
Facility_tpReturnOnEquity          = OnER(Facility_tpRiskAdjustedReturn/(Facility_tpRWA*Borrower_tpEquityRatio*Facility_tpDeannualize),NA)
Facility_tpRegulatoryProfit        = OnER(Facility_tpRiskAdjustedReturn-Facility_tpEquityCapitalCharge,NA)

.Hints
Facility_tpCostOfEconomicCapital   = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year 


;===================================================
.Variables
                                                                                                                                  
PP      1X     5               &"$>Required Input<$"                                                                           \Facility_tpRequiredInput
PI      1A     6               $>Product Name<$                                                                                \Facility_tpProductname                ;; Titel aangepast voor Compact Report

PI      1N C   6               $>Base Currency of Facility<$                             		                                   \Facility_tpBaseCurrencyChoice
PI      1A     6               $>Base Currency<$                        		                                                   \Facility_tpBaseCurrency                   ;; Titel aangepast voor Compact Report
PI      1A     6               $>Interest Product<$                                                                               \Facility_tpProductinterestDetailsInterestProductName
PI      1N C   6               $>Fixed Interest Period<$                             		                                       \Facility_tpFixedInterestPeriodChoice
PP      1N     6       -       $>Fixed Interest Period<$                             		                                       \Facility_tpFixedInterestPeriod
PI      1N D   6               $>Date Last Review<$                                                                                \Facility_tpDateLastInterestReview
PI    0 1N %   6               $>Prepayment of limit amount (%)<$                             		                               \Facility_tpPrepaymentPrec
PI      1N C   6               $>Offer period<$                             		                                               \Facility_tpOfferPeriodChoice
C Default is set to two weeks
PI      1A     6               $>Offer period text<$                             		                                           \Facility_tpOfferPeriod
 PI    0 1N     6               $>Base Rate (Bps)<$                                       \Facility_tpBaseRate2
PI    0 1N     6               $>Customer Spread Additional Margin<$                                                               \Facility_tpCustomerSpreadAddMargin2
PI    3 1N     6       -       $>Remaining Average Tenor (Years)<$                                                                \Facility_tpRemainingAverageTenor
PI      1N     6               $>Expected Average Outstanding (For upcoming 12 months after Current Date)<$                    \Facility_tpExpectedAverageOutstanding      ;; Titel aangepast voor Compact Report

PI      1N C   6               $>Facility is uncommitted<$                                                                        \Facility_tpUncommitted2
PI      1N C   6               $>31 Dg Debet<$                                                                                    \Facility_tp31DgDebet

.Formulas Visible
Facility_tpBaseCurrency                = ShowTestVariables
Facility_tpFixedInterestPeriod         = ShowTestVariables
Facility_tpOfferPeriod                 = ShowTestVariables

.Formulas InputRequired
Facility_tpPrincipalLimit              = 1
Facility_tpBaseCurrencyChoice          = 1
Facility_tpFixedInterestPeriodChoice   = 1
Facility_tpPrepaymentPrec              = 1
Facility_tpOfferPeriodChoice           = 1
Facility_tpType                        = 1
Facility_tpStartDate                   = 1
Facility_tpCurrentDate                 = 1
Facility_tpOriginalTenor               = 1
Facility_tpRemainingTenor              = 1
Facility_tpOriginalAverageTenor        = 1

.Choices
Facility_tp31DgDebet                   = "1:Yes|0:No"
Facility_tpBaseCurrencyChoice          = file "Choice_Currency.fib"
Facility_tpFixedInterestPeriodChoice   = "1:Base rate|2:1 months|3:3 months|4:6 months"
Facility_tpOfferPeriodChoice           = file "Choice_OfferPeriod.fib"
Facility_tpUncommitted2                = "1:Yes|0:No"

.Formulas NoTrend
Facility_tp31DgDebet                   = 0
Facility_tpUncommitted2                = 0
Facility_tpProductname                 = &MatrixLookup("AAB_Parameters.xls","VertaaltabelProductType",&Facility_tpType,1)
Facility_tpBaseCurrencyChoice          = 01
Facility_tpBaseCurrency                = &TableLookup("Choice_Currency",Facility_tpBaseCurrencyChoice)
Facility_tpFixedInterestPeriod         = Facility_tpFixedInterestPeriodChoice
Facility_tpOfferPeriodChoice           = 04
Facility_tpOfferPeriod                 = &TableLookup("Choice_OfferPeriod",Facility_tpOfferPeriodChoice)
Facility_tpCustomerSpreadAddMargin2    = Facility_tpCustomerSpreadAddMargin
Facility_tpFixedInterestPeriodChoice   = Case(Val(&Facility_tpProductinterestDetailsFixedInterestPeriod),[1:2|3:3|6:4|99:1])
;C Translation of imported variable Facility_tpProductinterestDetailsFixedInterestPeriod to Fixedinterest period used in matrix
Facility_tpProductinterestDetailsInterestProductName  = &MatrixLookup("AAB_Parameters.xls","VertaaltabelInterestProductType",&Facility_tpInterestProductCode,1)

Facility_tpPrepaymentPrec              = 0
Facility_tpBaseRate2                   = 100
Facility_tpOneOffFeeAmount2            = 0


;============================ Imported Data Facility ===========================================================
.Variables

PP      1X     5       -       &"$>Imported Data<$"                                                                            \Facility_tpDataImportedFromForce
PI      1A     6               $>Abbreviated Facility Type<$                                                                   \Facility_tpType

PI      1A     6               $>Accountnumber<$                                                                               \Facility_tpID
PI      1A     6               $>Status<$                                                                                      \Facility_tpStatusName
PI      1A     6               $>Product Reference Number<$                                                                    \Facility_tpProductReferenceNumber
PI    0 1N     6       +       $>Facility<$ $>Limit<$                             		                                       \Facility_tpPrincipalLimit                 ;= total commitment/ orginal limit/ limiet/ pro resto limiet

PI      1N D   6               $>Start Date<$                                                                                  \Facility_tpProductstartDate
PI    0 1N     6               $>Product Duration/ Maturity (months)<$                                                         \Facility_tpProductduration            ;;-- Pas op er is ook een Facility Maturity!!
PI      1N D   6               $>End date<$                                                                                    \Facility_tpProductEndDate


PI      1A     6               $>Withdrawal - WithdrawalType<$                                                                 \Facility_tpProductuptakeDetailsUptakeType
C ONE_TIME,FIXED_TERMS,REVOLVING,IRREGULAR_SCHEDULE
PI      1A     6               $>Withdrawal - WithdrawalFrequency<$                                                             \Facility_tpProductuptakeDetailsUptakeFrequency
C Daily, WEEKLy,MONTHLY,Quarterly,YEARLY
PI      1A     6               $>Withdrawal - Last Possible Withdrawal Date<$                                                  \Facility_tpProductWithdrawalDetailsLastPossibleWithdrawalDate
C Can only be specified with choosing to withdraw at once
PI    0 1N %   6 1             $>Withdrawal - Percentage used of Limits<$                                                      \Facility_tpProductWithdrawalDetailsPercentageUsedOfLimit
PI      1A     6               $>Repayment - RepaymentType<$                                                                   \Facility_tpProductredemptionDetailsRedemptionType                   ; =  Facility_tpRepaymentType in required input
PI      1A     6               $>Repayment - Periodicity<$                                                                     \Facility_tpProductredemptionDetailsPeriodicity
PI    0 1N     6               $>Repayment - FirstRepaymentAfterXMonths<$                                                      \Facility_tpProductredemptionDetailsFirstRedemptionAfterXMonths
PI      1A     6               $>Interest - Interest Product Code<$                                                            \Facility_tpInterestProductCode
C This code is used to retrieve the right liquidity spread
PI      1A     6               $>Interest - Fixed Interest Period<$                                                            \Facility_tpProductinterestDetailsFixedInterestPeriod
C Period in months
PI    2 1N %   6               $>Loss Given Default (LGD) (%)<$                      		                                   \Facility_tpLGD
PI    2 1N %   6               $>Loss Given Default (LGD) MoC (%)<$                                                            \Facility_tpLGDMoC
PI    2 1N %   6               $>Loss Given Default Downturn (LGD) MoC (%)<$                                                   \Facility_tpDLGDMoC
PI      1A     6               $>Facility is revolving<$                                                                       \Facility_tpIsRevolving
PI    2 1N     6               $>Customer Spread (Bps)<$                                                                       \Facility_tpCustomerSpread2
PI    2 1N     6               $>Market Spread<$                                                                               \Facility_tpMarketSpread    ; placeholder so we can check that the import for this field is working
PI      1N     6               $>One Off Fee Amount<$                                                                          \Facility_tpOneOffFeeAmount2
PI      1N     6               $>Credit fee (Bp)<$                                                                             \Facility_tpCreditFeeBp
PI    0 1N     6               $>Commitment Fee (Bp)<$        		  	                                                       \Facility_tpCommitmentFeeBp    ;; Titel aangepast voor Compact Report
PI      1N %   6               $>Target RaRoRaC<$                                                                              \Facility_tpTargetRaRoRaC

.Formulas Visible
Facility_tpDataImportedFromForce = ShowTestVariables

.Formulas NoTrend
Facility_tpCommitmentFeeBp           = 0
Facility_tpOneOffFeeAmount2          = 0
Facility_tpCreditFeeBp               = 0

;============================== Automatic Input Facility ============
.Variables
PP      1X     5               &"$>Automatic Input Facility<$"                                                                 \Facility_tpAutomaticInput
PI      1N C   6               $>Non Revolving Product (Y/N)<$                             		                               \Facility_tpNonRevolvingProduct
PI      1N C   6               $>Revolving Product (Y/N)<$                                                                   \Facility_tpRevolvingProduct
PI      1N C   6               $>Revolving Credit (Y/N)<$                             		                                   \Facility_tpRevolvingCredit
PI      1N     6               $>Remaning Tenor Under 1 Year<$                             		                               \Facility_tpPDMultiplierUnder1Year
PI    4 1N %   6               $>Probability of Default of the Borrower Specific for Facility<$                                \Facility_tpBorrower_tpPD
PI    4 1N %   6               $>Probability of Default  MoC of the Borrower Specific for Facility<$                           \Facility_tpBorrower_tpPDMoC
PI    6 1N     6               $>Risk Weight of the Borrower Specific for Facility<$                                           \Facility_tpBorrower_tpRiskWeight
PI    3 1N     6       -       $>De-annualization fraction (years)<$                                                           \Facility_tpDeannualize
PI      1N C   6               $>PL / NPL account<$                                                                            \Facility_tpBorrower_tpPLorNPL


.Choices
Facility_tpNonRevolvingProduct    = "1:Yes|0:No"
Facility_tpRevolvingProduct       = "1:Yes|0:No"
Facility_tpRevolvingCredit        = "1:Yes|0:No"
Facility_tpBorrower_tpPLorNPL     = "1:PL|0:NPL"

.Formulas Visible
Facility_tpAutomaticInput         = ShowTestVariables

.Formulas NoTrend
Facility_tpNonRevolvingProduct    = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,9)=0,1,0)
Facility_tpRevolvingProduct       = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,9)<>0,1,0)
Facility_tpRevolvingCredit        = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,9)<>0,1,0)
Facility_tpPDMultiplierUnder1Year = If(Facility_tpRemainingTenor=NA,1,If(Facility_tpRemainingTenor<12,Facility_tpRemainingTenor/12,1))
Facility_tpBorrower_tpPD          = Borrower_tpPD*Facility_tpPDMultiplierUnder1Year
Facility_tpBorrower_tpPDMoC       = Borrower_tpPD*Borrower_tpMoCFactor*Facility_tpPDMultiplierUnder1Year
Facility_tpBorrower_tpRiskWeight  = CumNormal((InvNormal(Facility_tpBorrower_tpPDMoC)-((Borrower_tpRho^0.5)*(InvNormal(1-Borrower_tpConfidenceLevel))))/((1-Borrower_tpRho)^0.5))
Facility_tpDeannualize            = If(Facility_tpRemainingAverageTenor<1,Facility_tpRemainingAverageTenor,1)
Facility_tpBorrower_tpPLorNPL     = Borrower_tpPLorNPL

;============================== Repayment Scheme ====================
.Variables
PP      1X     5       -       Repayment Scheme                                                                                \Facility_RepaymentScheme

PI    0 1N     6       -       $>Original Tenor (using the start date) (Months)<$                                      			   \Facility_tpOriginalTenor                   ;== US requirement == is NIET hetzelfde als Facility_tpProductDuration!!!!
;PI    0 1N     6       -       $>Original Tenor (using the start date) (Months) Annuity<$                                      \Facility_tpOriginalTenorAnnuity
PI    3 1N     6       -       $>Original Tenor (using the start date) (Years)<$                                      			   \Facility_tpOriginalTenorYears
PI    0 1N     6       -       $>Remaining Tenor (using the current date) (Months)<$                                  			   \Facility_tpRemainingTenor                  ;== US requirement ==
PI    3 1N     6       -       $>Remaining Tenor (using the current date) (Years)<$                                    			   \Facility_tpRemainingTenorYears             ;== US requirement ==

PI    3 1N     6       -       $>Original Average Tenor (Years)<$                                                              \Facility_tpOriginalAverageTenor            ;== US requirement ==
PI    3 1N     7       -       $>Original Average Tenor - Bullet<$                                                             \Facility_tpOriginalAverageTenorBullet      ;== US requirement ==
PI    3 1N     7       -       $>Original Average Tenor - No Bullet<$                                                          \Facility_tpOriginalAverageTenorNoBullet     ;== US requirement ==
PI    2 1N     6       -       $>Original Average Tenor Teller<$                                                               \Facility_tpOriginalAverageTenorTHsum
PI    2 1N     6       -       $>Original Average Tenor Noemer<$                                                               \Facility_tpOriginalAverageTenorNHsum
PP    3 1N     6       -       $>Remaining Average Tenor (Years)<$                                                             \Facility_tpRemainingAverageTenor2           -> Facility_tpRemainingAverageTenor
PP    3 1N     7       -       $>Remaining Average Tenor - Bullet<$                                                            \Facility_tpRemainingAverageTenorBullet
PP    3 1N     7       -       $>Remaining Average Tenor - No Bullet<$                                                         \Facility_tpRemainingAverageTenorNoBullet
PI    2 1N     6       -       $>Remaining Average Tenor Teller<$                                                              \Facility_tpRemainingAverageTenorTHsum
PI    2 1N     6       -       $>Remaining Average Tenor Noemer<$                                                              \Facility_tpRemainingAverageTenorNHsum

PI    0 1N     6               $>Limit (For upcoming 12 months after Current Date)<$                                           \Facility_tpLimit
PI      1N     7       -       $>Limit annuity<$                                                                               \Facility_tpLimitAnnuity
PI      1N     7       -       $>Limit Linear<$                                                                                \Facility_tpLimitLinear
PI      1N     7       -       $>Limit Scheme<$                                                                                \Facility_tpLimitScheme
PI      1N     7       -       $>Limit Linear Repayment Amount<$                                                               \Facility_tpLimitLinearRepayment
PI      1N     7       -       $>Limit Annuity Repayment Amount<$                                                              \Facility_tpLimitAnnuityRepayment
PI      1N     7       -       $>Limit Scheme Repayment Amount<$                                                               \Facility_tpLimitSchemeRepayment

PI    0 1N     6       -       $>Number Of Periods<$                                                                           \Facility_tpNumberOfPeriods
PI    0 1N     6       -       $>Number Of Periods Without Grace<$                                                             \Facility_tpNumberOfPeriodsNoGrace                 ;== US requirement ==
PI      1N C   6               $>Withdrawal Type<$                                                                             \Facility_tpWithdrawalChoice
PI      1N C   6               $>Repayment Type<$                                                                              \Facility_tpRepaymentChoice
PI      1N C   6       -       $>Repayment frequency<$                                                                         \Facility_tpRepaymentFrequency
PI      1N C   6       -       $>Annuity Interest Rate (Default/Funding+Marge)<$                                               \Facility_tpAnnuityInterestRateDefault
PI    2 1N %   6 1             $>Annuity Interest Rate<$                                                                       \Facility_tpAnnuityInterestRate
PI      1N     6               $>Balloon ()<$                                                                                 \Facility_tpBalloon                        ; #User#
PI    0 1N     6       -       $>Grace Period (mnd)<$                                                                          \Facility_tpGracePeriod                    ; #User#

PI      1N D   6               Start date                                                                                      \Facility_tpStartDate                         -> Facility_tpProductstartDate
PI      1N D   6               Current date                                                                                    \Facility_tpCurrentDate
PI      1N D   6 1             End date                                                                                        \Facility_tpEndDate

PI      1N D   6 1             End date Maximum 10 years                                                                       \Facility_tpEndDateMax10

PP      1N     6               $>Expected Average Outstanding (For upcoming 12 months after Current Date)<$                    \Facility_tpExpectedAverageOutstanding2      -> Facility_tpExpectedAverageOutstanding
PP      1N     6               $>Expected Average Outstanding Scheme<$                                                         \=Facility_tpExpectedAverageOutstandingScheme
PI    0 1N %   6 1             $>Percentage used of the Expected Average Outstanding (Revolving Items)<$                       \Facility_tpPercentageUsedOfExpectedAverageOutstanding

; MANUAL WITHDRAWAL SCHEMES
PP      1X   1 6               Tuples Manual Scheme
PII     1T     7 1             $>Manual Scheme<$                                                                               \Facility_tpManual
PII     1A     8               $>Month Identifier<$                                                                            \Facility_tpManual_tpMonthIdentifier
PII     1N D   8               $>Date of Repayment / Withdrawel<$                                                              \Facility_tpManual_tpFirstDayMonth
PII     1N     8       -       $>Months Since StartDate<$                                                                      \Facility_tpManual_tpMonthsSinceStartDate
C This variabele is based on months - depending time frequency
PII     1N     8       -       $>Months Since CurrentDate<$                                                                    \Facility_tpManual_tpMonthsSinceCurrentDate
PII     1N     8 1     -       $>Months Since CurrentDate - Help var exp. avg outstanding<$                                    \Facility_tpManual_tpMonthsSinceCurrentDateHelpVarAvgOutstanding
C This variabele is based on months - depending time frequency

PII     1N     8               $>Repayment Amount<$                                                                            \Facility_tpManual_tpRepaymentAmount
PII     1N     8               $>Repayment Amount Rem<$                                                                        \Facility_tpManual_tpRepaymentAmountRem
C This variabele is based on months - depending time frequency
PII     1N     8               $>Repayment Weighted<$                                                                          \Facility_tpManual_tpRepaymentWeighted
PII     1N     8 1             $>Repayment Weighted Rem<$                                                                      \Facility_tpManual_tpRepaymentWeightedRem
PII     1N     8 1             $>Withdrawal Amount<$                                                                           \Facility_tpManual_tpWithdrawalAmount

PII     1N     8 1             $>Repayment Check for RAT<$                                                                     \Facility_tpManual_tpRepaymentAmountRemHelpVar
PII     1N     8 1             $>Repayment Check for Within RAT<$                                                              \Facility_tpManual_tpRepaymentAmountRemHelpVar1

PII     1N     8               $>Expected Average Outstanding Withdrawal<$                                                     \Facility_tpManual_ExpectedAverageOutstandingWithdrawal
PII     1N     8               $>Expected Average Outstanding Withdrawal Annuity<$                                             \Facility_tpManual_ExpectedAverageOutstandingWithdrawalAnnuity
PII     1N     8               $>Expected Average Outstanding Weighted Repayment<$                                             \Facility_tpManual_ExpectedAverageOutstandingRepayment
PII     1N     8               $>Outstanding Balance - Weight Repayment<$                                                      \Facility_tpManual_tpOutstandingBalanceWeightRepayment
PII     1N     8               $>Outstanding Balance - Weight Withdrawal<$                                                     \Facility_tpManual_tpOutstandingBalanceWeightWithdrawal
PII     1N     8 1             $>Outstanding Balance - Exp Avg Out<$                                                           \Facility_tpManual_tpOutstandingBalanceExpAvgOut
PII     1N     8 1             $>Liquidity Spread - Liquidity Spread Interpolated Bps<$                                        \Facility_tpManual_tpLiquiditySpreadBpsTRepayment
PII     1N     8 1             $>Liquidity Spread - Liquidity Spread - Repayment<$                                             \Facility_tpManual_tpLiquiditySpreadRepayment
PII     1N     8 1             $>Liquidity Spread - Weighted Funding - Repayment<$                                             \Facility_tpManual_tpWeightedFundingRepayment
PII     1N     8 1             $>Liquidity Spread - Liquidity Spread Interpolated Bps - Withdrawal<$                           \Facility_tpManual_tpLiquiditySpreadBpsTWithdrawal
PII     1N     8 1             $>Liquidity Spread - Liquidity Spread - Withdrawal<$                                            \Facility_tpManual_tpLiquiditySpreadWithdrawal
PII     1N     8 1             $>Liquidity Spread - Weighted Funding - Withdrawal<$                                            \Facility_tpManual_tpWeightedFundingWithdrawal
PII     1N     8 1             $>Limit - Weighted Repayment<$                                                                  \Facility_tpManual_LimitWeightedRepayment
PII     1N     8 1             $>Limit - Repayment Weight<$                                                                    \Facility_tpManual_tpLimitWeightRepayment  
; -------------------------------- End Tuples 
PII     1N     7       -       $>Sum of Weighted Repayment OAT Nominator<$                                                     \Facility_tpSumOfWeightedRepaymentOATNominator
PII     1N     7       -       $>Sum of Repayment OAT Denominator<$                                                            \Facility_tpSumOfRepaymentOATDenominator
PII     1N     7 1     -       $>Original Average Tenor<$                                                                      \Facility_tpOriginalAverageTenorScheme

PII     1N     7       -       $>Sum of Weighted Repayment RAT TupleSum<$                                                      \Facility_tpSumOfRepaymentRAT
PII     1N     7       -       $>Sum of Weighted Repayment RAT Weight<$                                                        \Facility_tpSumOfRepaymentRATWeight
PII     1N     7       -       $>Sum of Weighted Repayment RAT Nominator<$                                                     \Facility_tpSumOfWeightedRepaymentRATNominator
PII     1N     7 1     -       $>Remaining Average Tenor<$                                                                     \Facility_tpRemainingAverageTenorScheme

PII     1N     7       -       $>Expected Average Outstanding Withdrawal Help<$                                                \Facility_tpEAOWithdrawalScheme
PII     1N     7       -       $>Expected Average Outstanding Withdrawal Annuity Help<$                                        \Facility_tpExpectedAverageOutstandingWithdrawalAnnuityHelp
PII     1N     7       -       $>Expected Average Outstanding Rem Help<$                                                       \Facility_tpExpectedAverageOutstandingRemHelp
PII     1N     7       -       $>Expected Average Outstanding Count<$                                                          \Facility_tpExpectedAverageOutstandingCount
PII     1N     7       -       $>Expected Average Outstanding Count Max EAO<$                                                  \Facility_tpExpectedAverageOutstandingCountMaxEAO
PII     1N     7       -       $>Expected Average Outstanding Denom<$                                                          \Facility_tpOutstandingBalanceExpAvgOutDenom
PII     1N     7       -       $>Expected Average Outstanding<$                                                                \Facility_tpExpectedAverageOutstandingScheme
; -------------------------------- End Manual scheme
PP      1X     6               $>Annuity & Linear<$                                                                            \Facility_tpAnnuityLinear
PP      1X     7       -       $>Annuity Parameters<$                                                                          \Facility_tpAnnuityParameters
PII     1N D   7               $>Annuity Start Date<$                                                                          \=Facility_tpStartDate
PII     1N D   7               $>Annuity Current Date<$                                                                        \=Facility_tpCurrentDate
PII     1N D   7               $>Annuity End Date<$                                                                            \=Facility_tpEndDate
PII     1N D   7               $>Annuity Date of Repayment / Withdrawel<$                                                      \Facility_tpAnnuityFirstDayMonth
PII     1N     7       -       $>Annuity Months Since Start Date<$                                                             \Facility_tpAnnuityMonthsSinceStartDate
PII   0 1N     7       -       $>Annuity Months Since Current Date<$                                                           \Facility_tpAnnuityMonthsSinceCurrentDate
PII     1N     7       -       $>Annuity Months Since Current Date Help Var<$                                                  \Facility_tpAnnuityMonthsSinceCurrentDateHelpVar
PII     1N     7       -       $>Annuity Months RepaymentFreq Help Var<$                                                       \Facility_tpAnnuityRepaymentFreqHelpVar
PII     1N %   7               $>Rate<$                                                                                        \=Facility_tpAnnuityInterestRate
PII     1N     7               $>Period<$                                                                                      \=Facility_tpAnnuityMonthsSinceCurrentDate
PII     1N     7               $>Period For RAT Grace<$                                                                        \Facility_tpPeriodForRATGrace
PII     1N     7               $>Period For RAT Grace Difference<$                                                             \Facility_tpPeriodDifferenceGrace
PII     1N     7               $>N Period<$                                                                                    \=Facility_tpNumberOfPeriods
PII     1N     7               $>Principal Limit<$                                                                             \=Facility_tpPrincipalLimit
PII     1N     7 1             $>Balloon<$                                                                                     \=Facility_tpBalloon

PII     1N     7       -       $>Annuity Repayment Amount (PPMT)<$                                                             \Facility_tpAnnuityRepaymentAmount
PII     1N     7 1     -       $>Annuity Withdrawal Amount<$                                                                   \Facility_tpAnnuityWithdrawalAmount

PII     1N     7       -       $>Annuity PPMT RAT Total Periods<$                                                              \Facility_tpAnnuityPPMTRATTotalPeriods
PII     1N     7       -       $>Annuity PPMT RAT Total Periods Max<$                                                          \Facility_tpAnnuityPPMTRATTotalPeriodsMax
PII     1N     7       -       $>Annuity PPMT RAT Total Monthts<$                                                              \Facility_tpAnnuityPPMTRATTotalMonths
PII     1N     7 1     -       $>Annuity PPMT RAT Month<$                                                                      \Facility_tpAnnuityPPMTRATMonth

PII     1N     7       -       $>Annuity OAT per period SUM<$                                                                   \Facility_tpAnnuityOATHelpVarWeightSumWithGrace
PII     1N     7       -       $>Annuity OAT HelpVar Weight Sum No Grace<$                                                      \Facility_tpAnnuityOATHelpVarWeightSumGrace
PII     1N     7       -       $>Annuity OAT HelpVar Weight Sum With Grace<$                                                    \Facility_tpAnnuityOATHelpVar
PII     1N     7 1     -       $>Annuity OAT HelpVar<$                                                                          \Facility_tpAnnuityOAT

PII     1N     7       -       $>Annuity RAT HelpVar Weight Sum No Grace<$                                                      \Facility_tpAnnuityRATHelpVarWeightSumWithGrace
PII     1N     7       -       $>Annuity RAT HelpVar Sum Repayment<$                                                            \Facility_tpAnnuityRATHelpVarSumRepayment
PII     1N     7       -       $>Annuity RAT HelpVar Weight Sum With Grace<$                                                    \Facility_tpAnnuityRATHelpVar
PII     1N     7 1     -       $>Annuity RAT HelpVar<$                                                                          \Facility_tpAnnuityRAT

PII     1N     7       -       $>Annuity Outstanding Point in Time<$                                                           \Facility_tpAnnuityOutstandingPointInTime
PII     1N     7       -       $>Annuity Outstanding Repayment Sum<$                                                           \Facility_tpEAORepaymentAnnuity
PII     1N     7 1     -       $>Annuity Outstanding Withdrawal Sum<$                                                          \Facility_tpAnnuityOutstandingWithdrawalSum


PII     1N     7       -       $>Linear Repayment<$                                                                            \Facility_tpLinear
PII     1N     7 1     -       $>Linear Withdrawal<$                                                                           \Facility_tpLinearWithdrawal

PII     1N     7       -       $>Linear OAT HelpVar Weight Sum No Grace<$                                                      \Facility_tpLinearOATHelpVarWeightSumWithGrace
PII     1N     7       -       $>Linear OAT HelpVar Weight Sum With Grace<$                                                    \Facility_tpLinearOATHelpVarWeightSumGrace
PII     1N     7       -       $>Linear OAT HelpVar<$                                                                          \Facility_tpLinearOATHelpVar
PII     1N     7 1     -       $>Linear OAT<$                                                                                  \Facility_tpLinearOAT

PII     1N     7       -       $>Linear RAT HelpVar Weight Sum No Grace<$                                                      \Facility_tpLinearRATHelpVarWeightSumWithGrace
PII     1N     7       -       $>Linear RAT HelpVar Sum Repayment<$                                                            \Facility_tpLinearRATHelpVarSumRepayment
PII     1N     7       -       $>Linear RAT HelpVar Weight Sum With Grace<$                                                    \Facility_tpLinearRATHelpVar
PII     1N     7 1     -       $>Linear RAT<$                                                                                  \Facility_tpLinearRAT
PII     1N     7       -       $>Expected average outstanding Revolving<$                                                      \Facility_tpEAORevolving
PII     1N     7       -       $>Expected average outstanding for once withdrawal and linear repayment<$                       \Facility_tpEAOOnceLinear
PII     1N     7       -       $>Expected average outstanding for manual withdrawal and linear repayment<$                     \Facility_tpEAOSchemeLinear
PII     1N     7       -       $>Expected average outstanding for once withdrawal and annuity repayment<$                      \Facility_tpEAOOnceAnnuity
PII     1N     7       -       $>Expected average outstanding for manual withdrawal and annuity repayment<$                    \Facility_tpEAOSchemeAnnuity
PII     1N     7       -       $>Linear Outstanding Point in Time<$                                                            \Facility_tpLinearOutstandingPointInTime
PII     1N     7       -       $>Linear Outstanding Repayment Sum<$                                                            \Facility_tpEAORepaymentLinear
PII     1N     7       -       $>Linear Outstanding Repayment Sum<$                                                            \Facility_tpEAORepaymentLinearForSchemeWithdrawal
PII     1N     7 1     -       $>Linear Outstanding Withdrawal Sum<$                                                           \Facility_tpLinearOutstandingWithdrawalSum


.Formulas NoTrend
Facility_tpEndDateMax10                       = If(Facility_tpEndDate > AddMonth(DMYtoDate(DateToDay(Facility_tpStartDate),DateToMonth(Facility_tpStartDate),DateToYear(Facility_tpStartDate)),84), AddMonth(DMYtoDate(DateToDay(Facility_tpStartDate),DateToMonth(Facility_tpStartDate),DateToYear(Facility_tpStartDate)),120), Facility_tpEndDate)
;This variable was made to put a lock in the model itself so it will not exceed 132 columns(11 years) for all the trend columns

Facility_tpPeriodForRATGrace                  = Facility_tpAnnuityMonthsSinceStartDate - (Facility_tpNumberOfPeriodsNoGrace - Facility_tpNumberOfPeriods)
Facility_tpPeriodDifferenceGrace              = (Facility_tpNumberOfPeriodsNoGrace - Facility_tpNumberOfPeriods)

Facility_tpLinear                             = Facility_tpPrincipalLimit / Facility_tpNumberOfPeriods


;---
Facility_tpLinearOATHelpVarWeightSumWithGrace = FesExpression("SumFor(X, (Facility_tpNumberOfPeriodsNoGrace - Facility_tpNumberOfPeriods + 1) ,Facility_tpNumberOfPeriodsNoGrace,1, (X * Facility_tpLinear * Facility_tpAnnuityRepaymentFreqHelpVar ) ) ")
Facility_tpLinearRATHelpVarWeightSumWithGrace = FesExpression("SumFor(X, 1, Facility_tpAnnuityPPMTRATTotalPeriods,1, (X * Facility_tpLinear * Facility_tpAnnuityRepaymentFreqHelpVar ) ) ")

Facility_tpLinearOATHelpVarWeightSumGrace     = Facility_tpLinearOATHelpVarWeightSumWithGrace - ( Round( (Facility_tpGracePeriod / Facility_tpAnnuityRepaymentFreqHelpVar),0)  *  Facility_tpLinear  * Facility_tpAnnuityRepaymentFreqHelpVar )

Facility_tpLinearRATHelpVarSumRepayment       = FesExpression(SumFor(X, 1, Facility_tpAnnuityPPMTRATTotalPeriods,1, (Facility_tpLinear * ( (X - X)+1) ) ) )

Facility_tpLinearOATHelpVar                   = Facility_tpLinearOATHelpVarWeightSumWithGrace / (Facility_tpPrincipalLimit * Facility_tpOriginalTenor)
Facility_tpLinearRATHelpVar                   = Facility_tpLinearRATHelpVarWeightSumWithGrace / (Facility_tpLinearRATHelpVarSumRepayment * Facility_tpAnnuityPPMTRATTotalMonths)

Facility_tpLinearOAT                          = Facility_tpLinearOATHelpVar * Facility_tpOriginalTenor / 12
Facility_tpLinearRAT                          = Facility_tpLinearRATHelpVar * Facility_tpAnnuityPPMTRATTotalMonths / 12
;---
; C The repayment frequency EAO variable sets the repayment frequency at 'monthly' when the withdrawal mode is manual, for the expected average outstanding to use the correct weight 
Facility_tpLinearOutstandingPointInTime    = (Facility_tpPrincipalLimit - FesExpression("(SumFor(X,1,(Facility_tpAnnuityMonthsSinceStartDate - 1),1,Facility_tpLinear * ((X+1) - X)))"))
;Works!! Calculates Oustanding balance for point in time - Facility_tpAnnuityOutstanding         = (Facility_tpPrincipalLimit - FesExpression("(SumFor(X,0,(Facility_tpAnnuityMonthsSinceStartDate - 1),1,PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,X,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)))"))
Facility_tpEAORepaymentLinearForSchemeWithdrawal    = FesExpression("SumFor(X,(12/Facility_tpRepaymentFrequency)+Facility_tpGracePeriod,Facility_tpOriginalTenor,12/Facility_tpRepaymentFrequency, Facility_tpLinear * MinMax((12-(X-(Facility_tpOriginalTenor-Facility_tpRemainingTenor))),0,12))")
Facility_tpEAORevolving                    = Facility_tpPrincipalLimit * Facility_tpProductWithdrawalDetailsPercentageUsedOfLimit
Facility_tpEAORepaymentLinear              = FesExpression("SumFor(X,(Facility_tpPeriodDifferenceGrace + 1),Facility_tpNumberOfPeriodsNoGrace,1, Facility_tpLinear * Round(MinMax( (( (Facility_tpAnnuityMonthsSinceStartDate - 1) + Facility_tpRepaymentFrequency ) - X)*If(Facility_tpWithdrawalChoice = 3,Facility_tpAnnuityRepaymentFreqHelpVar,1),0,If(Facility_tpWithdrawalChoice = 3,12,Facility_tpRepaymentFrequency) ,0),0) )  " )
Facility_tpLinearOutstandingWithdrawalSum  = Facility_tpPrincipalLimit * Facility_tpRepaymentFrequency
Facility_tpEAOOnceLinear                   = (Facility_tpLinearOutstandingWithdrawalSum - Facility_tpEAORepaymentLinear) / MinMax(Facility_tpAnnuityPPMTRATTotalPeriods,1,Facility_tpRepaymentFrequency,NA) 
;- If(Facility_tpWithdrawalChoice=3, Facility_tpPrincipalLimit - (If(Facility_tpStartDate > Facility_tpCurrentDate,Facility_tpExpectedAverageOutstandingWithdrawalAnnuityHelp,Facility_tpEAOWithdrawalScheme)/Facility_tpAnnuityRepaymentFreqHelpVar),0)
Facility_tpEAOSchemeLinear                   = (Facility_tpEAOWithdrawalScheme - Facility_tpEAORepaymentLinearForSchemeWithdrawal)/MinMax(Facility_tpRemainingTenor,1,12,NA) 
;- If(Facility_tpWithdrawalChoice=3, Facility_tpPrincipalLimit - (If(Facility_tpStartDate > Facility_tpCurrentDate,Facility_tpExpectedAverageOutstandingWithdrawalAnnuityHelp,Facility_tpEAOWithdrawalScheme)/Facility_tpAnnuityRepaymentFreqHelpVar),0)
Facility_tpAnnuityFirstDayMonth          = Facility_tpCurrentDate
Facility_tpAnnuityRepaymentFreqHelpVar   = Case(Facility_tpRepaymentFrequency,[1:12|2:6|4:3|12:1])
Facility_tpAnnuityPPMTRATTotalPeriods    = RoundUp(Facility_tpNumberOfPeriodsNoGrace - Facility_tpAnnuityMonthsSinceCurrentDate)
Facility_tpAnnuityPPMTRATTotalPeriodsMax = MinMax(Facility_tpAnnuityPPMTRATTotalPeriods,0,(Facility_tpRepaymentFrequency),NA)
Facility_tpAnnuityPPMTRATMonth           = RoundUp(If(DMYtoDate(01,DateToMonth(Facility_tpAnnuityFirstDayMonth),DateToYear(Facility_tpAnnuityFirstDayMonth)) < DMYtoDate(01,(DateToMonth(Facility_tpCurrentDate)),DateToYear(Facility_tpCurrentDate)) ,NA, ( ( DateToYear(Facility_tpAnnuityFirstDayMonth) - DateToYear(Facility_tpCurrentDate)) * 12 + (DateToMonth(Facility_tpAnnuityFirstDayMonth)) - DateToMonth(Facility_tpCurrentDate)+1))/ Facility_tpAnnuityRepaymentFreqHelpVar,0)
Facility_tpAnnuityPPMTRATTotalMonths     = (Facility_tpAnnuityPPMTRATTotalPeriods) * Facility_tpAnnuityRepaymentFreqHelpVar

Facility_tpAnnuityRepaymentAmount             = PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,Facility_tpAnnuityMonthsSinceStartDate,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)
Facility_tpAnnuityWithdrawalAmount = If((Facility_tpAnnuityMonthsSinceStartDate = 1), Facility_tpPrincipalLimit, Facility_tpAnnuityWithdrawalAmount)

Facility_tpAnnuityOATHelpVarWeightSumWithGrace = FesExpression("SumFor(X, (Facility_tpNumberOfPeriodsNoGrace - Facility_tpNumberOfPeriods + 1) ,Facility_tpNumberOfPeriodsNoGrace,1, (X * PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,( X - (Facility_tpNumberOfPeriodsNoGrace - Facility_tpNumberOfPeriods + 1) + 1 ),Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon) * Facility_tpAnnuityRepaymentFreqHelpVar ) ) ")
Facility_tpAnnuityRATHelpVarWeightSumWithGrace = FesExpression("SumFor(X, 1, (Facility_tpNumberOfPeriods - (Facility_tpAnnuityMonthsSinceCurrentDate - Facility_tpPeriodDifferenceGrace)) ,1, (X * (PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,( (Facility_tpPeriodForRATGrace - 1) + X) ,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon) ) * Facility_tpAnnuityRepaymentFreqHelpVar ) ) ")
Facility_tpAnnuityRATHelpVarSumRepayment       = FesExpression("SumFor(X, 1, (Facility_tpNumberOfPeriods - (Facility_tpAnnuityMonthsSinceCurrentDate - Facility_tpPeriodDifferenceGrace)) ,1, (PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,( (Facility_tpPeriodForRATGrace - 1) + X ),Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)) ) ")
Facility_tpAnnuityOATHelpVar                   = Facility_tpAnnuityOATHelpVarWeightSumWithGrace / (Facility_tpPrincipalLimit * Facility_tpOriginalTenor)
Facility_tpAnnuityRATHelpVar                   = Facility_tpAnnuityRATHelpVarWeightSumWithGrace / (Facility_tpAnnuityRATHelpVarSumRepayment * Facility_tpAnnuityPPMTRATTotalMonths)
Facility_tpAnnuityOAT                          = Facility_tpAnnuityOATHelpVar * Facility_tpOriginalTenor / 12
Facility_tpAnnuityRAT                          = Facility_tpAnnuityRATHelpVar * Facility_tpAnnuityPPMTRATTotalMonths / 12


Facility_tpAnnuityOutstandingPointInTime = (Facility_tpPrincipalLimit - FesExpression("(SumFor(X,0,(Facility_tpAnnuityMonthsSinceStartDate - 1),1,PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,X,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)))"))
;Works!! Calculates Oustanding balance for point in time - Facility_tpAnnuityOutstanding         = (Facility_tpPrincipalLimit - FesExpression("(SumFor(X,0,(Facility_tpAnnuityMonthsSinceStartDate - 1),1,PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,X,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)))"))
Facility_tpEAORepaymentAnnuity   = FesExpression("SumFor(X,1,Facility_tpNumberOfPeriods,1,(PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,X,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)) * MinMax( (Facility_tpAnnuityMonthsSinceStartDate - 1) + Facility_tpRepaymentFrequency - Facility_tpPeriodDifferenceGrace - X ,0,Facility_tpRepaymentFrequency,0)  ) ")

Facility_tpEAORepaymentLinear              = FesExpression("SumFor(X,(Facility_tpPeriodDifferenceGrace + 1),Facility_tpNumberOfPeriodsNoGrace,1, Facility_tpLinear * Round(MinMax( (( (Facility_tpAnnuityMonthsSinceStartDate - 1) + Facility_tpRepaymentFrequency ) - X)*If(Facility_tpWithdrawalChoice = 3,Facility_tpAnnuityRepaymentFreqHelpVar,1),0,If(Facility_tpWithdrawalChoice = 3,12,Facility_tpRepaymentFrequency) ,0),0) )  " )

Facility_tpAnnuityOutstandingWithdrawalSum  = Facility_tpPrincipalLimit * Facility_tpRepaymentFrequency
Facility_tpEAOOnceAnnuity               = (Facility_tpAnnuityOutstandingWithdrawalSum - Facility_tpEAORepaymentAnnuity) / MinMax((Facility_tpNumberOfPeriods - Facility_tpAnnuityMonthsSinceStartDate),1,Facility_tpRepaymentFrequency,NA) 
Facility_tpEAOSchemeAnnuity                  = (Facility_tpExpectedAverageOutstandingScheme - Facility_tpEAORepaymentAnnuity) / MinMax(Facility_tpRemainingTenor,1,Facility_tpRepaymentFrequency,NA) 
;;- If(Facility_tpWithdrawalChoice=3, Facility_tpPrincipalLimit - (If(Facility_tpStartDate > Facility_tpCurrentDate,Facility_tpExpectedAverageOutstandingWithdrawalAnnuityHelp,Facility_tpEAOWithdrawalScheme)/Facility_tpAnnuityRepaymentFreqHelpVar),0)





Facility_tpAnnuityMonthsSinceStartDate    = OnZero(RoundUp((OnNeg((If(Facility_tpStartDate = NA ,NA, ( DateToYear(Facility_tpCurrentDate) - DateToYear(Facility_tpStartDate)) * 12 + DateToMonth(Facility_tpCurrentDate) - DateToMonth(Facility_tpStartDate)) + If(Facility_tpAnnuityMonthsSinceStartDate = NA, NA,1)),0)) / Facility_tpAnnuityRepaymentFreqHelpVar , 0), 1)
; This variabele is based on months - depending time frequency
Facility_tpAnnuityMonthsSinceCurrentDate  = OnNeg(Facility_tpAnnuityMonthsSinceStartDate - 1, 0) ;(Abs(If(DMYtoDate(01,DateToMonth(Facility_tpStartDate),DateToYear(Facility_tpStartDate)) > DMYtoDate(01,(DateToMonth(Facility_tpCurrentDate)),DateToYear(Facility_tpCurrentDate)) ,NA, ( ( DateToYear(Facility_tpStartDate) - DateToYear(Facility_tpCurrentDate)) * 12 + (DateToMonth(Facility_tpStartDate)) - DateToMonth(Facility_tpCurrentDate)))) / Facility_tpAnnuityRepaymentFreqHelpVar)
                                            ;If(Facility_tpRepaymentChoice=0,1,OnER(RoundUp((( DateToYear(Facility_tpEndDate-1)*12+DateToMonth(Facility_tpEndDate-1)+If((DateToDay(Facility_tpEndDate)>DateToDay(Facility_tpStartDate)) Or (DateToDay(Facility_tpEndDate)=1),1,0))-(DateToYear(Facility_tpStartDate)*12+DateToMonth(Facility_tpStartDate))-Facility_tpGracePeriod)*(Facility_tpRepaymentFrequency/12),0),NA))
; This variabele is based on months - depending time frequency
Facility_tpAnnuityMonthsSinceCurrentDateHelpVar = If(Facility_tpAnnuityMonthsSinceCurrentDate > 12, 0, If(Facility_tpAnnuityMonthsSinceCurrentDate = NA,0,1))

; ------------------------------------ Calculations for limit ----------------------------------------------------------------------------------------------
Facility_tpLimit                      = If((Facility_tpRepaymentChoice=4) Or (Facility_tpWithdrawalChoice=2),Facility_tpPrincipalLimit,If(Facility_tpRepaymentChoice=0,Facility_tpPrincipalLimit,If(Facility_tpRepaymentChoice=1,Facility_tpLimitLinear,If(Facility_tpRepaymentChoice=2,Facility_tpLimitAnnuity,If(Facility_tpRepaymentChoice=3,Facility_tpLimitScheme,Facility_tpPrincipalLimit)))))

Facility_tpLimitLinearRepayment                         = FesExpression("SumFor(X,(Facility_tpPeriodDifferenceGrace + 1),Facility_tpNumberOfPeriodsNoGrace,1, Facility_tpLinear * Round(MinMax( (( Facility_tpAnnuityMonthsSinceStartDate + Facility_tpRepaymentFrequency ) - X),0,Facility_tpRepaymentFrequency) ,0) )  " )
Facility_tpLimitAnnuityRepayment      = FesExpression("SumFor(X,1,Facility_tpNumberOfPeriods,1,(PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,X,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)) * MinMax( Facility_tpAnnuityMonthsSinceStartDate + Facility_tpRepaymentFrequency - Facility_tpPeriodDifferenceGrace - X ,0,Facility_tpRepaymentFrequency,0)  ) ")
Facility_tpLimitSchemeRepayment                         = TupleSum(Facility_tpManual_LimitWeightedRepayment)
Facility_tpManual_LimitWeightedRepayment                = Facility_tpManual_tpRepaymentAmount * Facility_tpManual_tpLimitWeightRepayment
Facility_tpManual_tpLimitWeightRepayment                = MinMax(13 - If(Facility_tpStartdate > Facility_tpCurrentDate, Facility_tpManual_tpMonthsSinceStartDate, Facility_tpManual_tpMonthsSinceCurrentDate) ,0,12,NA)

Facility_tpLimitLinear                = (Facility_tpPrincipalLimit * Facility_tpRepaymentFrequency - Facility_tpLimitLinearRepayment) / MinMax(Facility_tpAnnuityPPMTRATTotalPeriods,1,Facility_tpRepaymentFrequency,NA)
Facility_tpLimitAnnuity               = (Facility_tpPrincipalLimit * Facility_tpRepaymentFrequency - Facility_tpLimitAnnuityRepayment) / MinMax(Facility_tpAnnuityPPMTRATTotalPeriods,1,Facility_tpRepaymentFrequency,NA)
Facility_tpLimitScheme                = (Facility_tpPrincipalLimit * Facility_tpRepaymentFrequency - Facility_tpLimitAnnuityRepayment) / MinMax(Facility_tpAnnuityPPMTRATTotalPeriods,1,Facility_tpRepaymentFrequency,NA)

.Choices
Facility_tpWithdrawalChoice           = "0:ONCE|1:PERIODICAL|2:REVOLVING|3:SCHEME"
Facility_tpRepaymentChoice            = "0:BULLET|1:LINEAR|2:ANNUITY|3:SCHEME|4:REVOLVING"
Facility_tpRepaymentFrequency         = "1:$>YEARLY<$|2:$>HALF YEARLY<$|4:$>QUARTERLY<$|12:$>MONTHLY<$|"
Facility_tpAnnuityInterestRateDefault = "1:YES|0:NO"

.Formulas Visible
Facility_tpOriginalAverageTenorTHsum  = ShowTestVariables
Facility_tpOriginalAverageTenorNHsum  = ShowTestVariables
Facility_tpRemainingAverageTenorTHsum = ShowTestVariables
Facility_tpRemainingAverageTenorNHsum = ShowTestVariables

.Formulas InputRequired
Facility_tpStartDate                  = 1
Facility_tpCurrentDate                = 1
Facility_tpEndDate                    = 1
Facility_tpRepaymentFrequency         = 1
Facility_tpWithdrawalChoice           = 1
Facility_tpRepaymentChoice            = 1

.Formulas NoTrend
Facility_tpWithdrawalChoice           = If(&Facility_tpProductuptakeDetailsUptakeType="OneTime",0,If(&Facility_tpProductuptakeDetailsUptakeType="FixedTerms",1,If(&Facility_tpProductuptakeDetailsUptakeType="WithdrawalRevolving",2,If(&Facility_tpProductuptakeDetailsUptakeType="IrregularWithdrawalSchedule",3,If(&Facility_tpProductuptakeDetailsUptakeType="ConditionalWithdrawalSchedule",3,NA)))))
Facility_tpPercentageUsedOfExpectedAverageOutstanding = Facility_tpProductWithdrawalDetailsPercentageUsedOfLimit
Facility_tpRepaymentChoice            = If(&Facility_tpProductredemptionDetailsRedemptionType="InterestOnly",0,If(&Facility_tpProductredemptionDetailsRedemptionType="Linear",1,If(&Facility_tpProductredemptionDetailsRedemptionType="Annuity",2,If(&Facility_tpProductredemptionDetailsRedemptionType="IrregularRepaymentSchedule",3,If(&Facility_tpProductredemptionDetailsRedemptionType="RepaymentRevolving",4,NA)))))
Facility_tpAnnuityInterestRateDefault = 1
Facility_tpOriginalTenor              = OnNeg(OnER((DateToYear(Facility_tpEndDate-1)*12+DateToMonth(Facility_tpEndDate-1)+If((DateToDay(Facility_tpEndDate)>DateToDay(Facility_tpStartDate)) Or (DateToDay(Facility_tpEndDate)=1),1,0))-(DateToYear(Facility_tpStartDate)*12+DateToMonth(Facility_tpStartDate)),NA),NA)
;Facility_tpOriginalTenorAnnuity       = OnNeg((If(Facility_tpStartDate = NA ,NA, ( DateToYear(Facility_tpEndDate) - DateToYear(Facility_tpStartDate)) * 12 + DateToMonth(Facility_tpEndDate) - DateToMonth(Facility_tpStartDate))),0)
Facility_tpOriginalTenorYears         = OnNeg(OnER(Facility_tpOriginalTenor/12,NA),NA)
Facility_tpRemainingTenor             = OnNeg(OnER((DateToYear(Facility_tpEndDate-1)*12+DateToMonth(Facility_tpEndDate-1)+If((DateToDay(Facility_tpEndDate)>DateToDay(Facility_tpStartDate)) Or (DateToDay(Facility_tpEndDate)=1),1,0))-(DateToYear(If(Facility_tpCurrentDate<=Facility_tpStartDate,Facility_tpStartDate,Facility_tpCurrentDate))*12+DateToMonth(If(Facility_tpCurrentDate<=Facility_tpStartDate,Facility_tpStartDate,Facility_tpCurrentDate))),NA),NA)
Facility_tpRemainingTenorYears        = OnNeg(OnER(Facility_tpRemainingTenor/12,NA),NA)

.Formulas NoTrend,Trend
Facility_tpOriginalAverageTenor         = If(Facility_tpRevolvingCredit=0,If(Facility_tpRepaymentChoice=0,Facility_tpOriginalAverageTenorBullet,Facility_tpOriginalAverageTenorNoBullet),1)
Facility_tpOriginalAverageTenorBullet   = OnER(Facility_tpOriginalTenorYears,NA)
Facility_tpOriginalAverageTenorNoBullet = If((Facility_tpRepaymentChoice=3) ,Facility_tpOriginalAverageTenorScheme, If( (Facility_tpRepaymentChoice=2), Facility_tpAnnuityOAT , If( (Facility_tpRepaymentChoice=1), Facility_tpLinearOAT ,OnER(HSum(Facility_tpWeightedAmountRepayment,DateToT(Facility_tpStartDate,1),DateToT(Facility_tpEndDateMax10,1))/(12*HSum(Facility_tpRepayment,DateToT(Facility_tpStartDate,1),DateToT(Facility_tpEndDateMax10,1))),NA)) ) )

Facility_tpOriginalAverageTenorTHsum    = OnER(HSum(Facility_tpWeightedAmountRepayment,DateToT(Facility_tpStartDate,1),DateToT(Facility_tpEndDateMax10,1)),NA)
;C Sums the weighted repayments amounts from start date to the end date
Facility_tpOriginalAverageTenorNHsum    = OnER((12*HSum(Facility_tpRepayment,DateToT(Facility_tpStartDate,1),DateToT(Facility_tpEndDateMax10,1))),NA)
;C Sums the regular repayments amounts from start date to the end date

Facility_tpRemainingAverageTenor        = If(Facility_tpRevolvingCredit=0,If(Facility_tpRepaymentChoice=0,Facility_tpRemainingAverageTenorBullet,Facility_tpRemainingAverageTenorNoBullet),1)
;C If the facility is a Revolving Credit product the RAT is 1.
Facility_tpRemainingAverageTenorBullet   = OnER(Facility_tpRemainingTenorYears,NA)
Facility_tpRemainingAverageTenorNoBullet = If(Facility_tpRepaymentChoice=3,Facility_tpRemainingAverageTenorScheme,If((Facility_tpRepaymentChoice=2),Facility_tpAnnuityRAT,If((Facility_tpRepaymentChoice=1),Facility_tpLinearRAT ,OnER(HSum(Facility_tpWeightedAmountRepaymentRem,(DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1))),DateToT(Facility_tpEndDateMax10,1))/(12*HSum(Facility_tpRepayment,(DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1))),DateToT(Facility_tpEndDateMax10,1))),NA)) ) )
;C                                       =                      Facility_tpRemainingAverageTenorTHsum      /      Facility_tpRemainingAverageTenorNHsum

Facility_tpRemainingAverageTenorTHsum   = OnER(HSum(Facility_tpWeightedAmountRepaymentRem,(DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1))),DateToT(Facility_tpEndDateMax10,1)),NA)
;C Sums the weighted repayments amounts from the current date to the end date
Facility_tpRemainingAverageTenorNHsum   = OnER(12*HSum(Facility_tpRepayment,(DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1))),DateToT(Facility_tpEndDateMax10,1)),NA)
;C Sums the actual repayments amounts from the current date to the end date

Facility_tpRemainingAverageTenor2       = Facility_tpRemainingAverageTenor


.Formulas NoTrend
Facility_tpNumberOfPeriods            = If(Facility_tpRepaymentChoice=0,1,OnER(RoundUp(((DateToYear(Facility_tpEndDate-1)*12+DateToMonth(Facility_tpEndDate-1)+If((DateToDay(Facility_tpEndDate)>DateToDay(Facility_tpStartDate)) Or (DateToDay(Facility_tpEndDate)=1),1,0))-(DateToYear(Facility_tpStartDate)*12+DateToMonth(Facility_tpStartDate))-Facility_tpGracePeriod)*(Facility_tpRepaymentFrequency/12),0),NA))
;C it is calculated on a monthly basis and it is 1 for a Revolviong product
Facility_tpNumberOfPeriodsNoGrace     = If(Facility_tpRepaymentChoice=0,1,OnER(RoundUp(((DateToYear(Facility_tpEndDate-1)*12+DateToMonth(Facility_tpEndDate-1)+If((DateToDay(Facility_tpEndDate)>DateToDay(Facility_tpStartDate)) Or (DateToDay(Facility_tpEndDate)=1),1,0))-(DateToYear(Facility_tpStartDate)*12+DateToMonth(Facility_tpStartDate)))*(Facility_tpRepaymentFrequency/12),0),NA))
Facility_tpRepaymentFrequency         = OnER(Val(Facility_tpProductredemptionDetailsPeriodicity),NA)
Facility_tpAnnuityInterestRate        = If(Facility_tpAnnuityInterestRateDefault,0.05,(Facility_tpBaseRate2+Facility_tpCustomerSpread2+Facility_tpCustomerSpreadAddMargin2)*0.0001)
;C its a defaulted percentage
Facility_tpGracePeriod                = Facility_tpProductredemptionDetailsFirstRedemptionAfterXMonths
Facility_tpBalloon					          = 0
Facility_tpStartDate                  = Facility_tpProductstartDate
Facility_tpCurrentDate                = If(DataEntered(Facility_tpCurrentDate),Facility_tpCurrentDate,CurrentDate)
Facility_tpEndDate                    = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,9)=1,NA,Facility_tpProductEndDate) ;End date is nowcalculated in Force -> old;AddMonth(Facility_tpStartDate,Facility_tpProductduration)

Facility_tpExpectedAverageOutstanding2 = Facility_tpExpectedAverageOutstanding


;=========================== Repayment Scheme's ========================================

.Variables

X       1N     6 1             $>Hidden variables for repayment scheme<$                                                       \Facility_tpHiddenRepaymentScheme
PII   0-FN     7               $>Weighted Repayment Amount<$                                                                   \Facility_tpWeightedAmountRepayment
PII   0-FN     7 1     -       $>Weighted Repayment Amount Remaining<$                                                         \Facility_tpWeightedAmountRepaymentRem

PII   0 FN     7               $>Withdrawal<$                                                                                  \Facility_tpWithdrawal
PII   0-FN     7               $>Repayment<$                                                                                   \Facility_tpRepayment
PII   0=BN    -7 2             $>Outstanding Balance<$                                                                         \Facility_tpOutstandingBalance                 ;== US requirement ==
PII   0 BN     7               $>Outstanding Balance Hulp Average calculation<$                                                \Facility_tpOutstandingBalanceHulpVar
PII   0 BN     7 1             $>Hulp Var Tenors<$                                                                       	     \Facility_tpHulpVarFrequency


PII   0 BN     7               $>Withdrawal One Time<$                                                                         \Facility_tpWithdrawalOneTime
PII   0 BN     7               $>Withdrawal Fixed Terms<$                                                                      \Facility_tpWithdrawalFixedTerms
PII   0 BN     7               $>Withdrawal Revolving<$                                                                        \Facility_tpWithdrawalRevolving

PII   0 BN     7 1             $>Withdrawals Scheme<$                                                                          \Facility_tpWithdrawalsAmount
; PII   0 BN D   7               $>Withdrawals Date<$                                                                            \Facility_tpWithdrawalsDate
; PII     BA     7 1             $>Withdrawals Currency<$                                                                        \Facility_tpWithdrawalsCurrency

PII   0 FN     7               $>Repayment Scheme Linear<$                                                                     \Facility_tpRepaymentLinear
PII   0 FN     7               $>Repayment Scheme Annuity<$                                                                    \Facility_tpRepaymentAnnuity
PII   0 FN     7               $>Repayment Balloon<$                                                                           \Facility_tpRepaymentBalloon
PII   0 FN     7               $>Repayment Revolving<$                                                                         \Facility_tpRepaymentRevolving

; MANUAL RAPAYMENT SCHEMES
PII   0 BN     7 1             $>Repayments Scheme<$                                                                           \Facility_tpRepaymentsAmount
; PII   0 BN D   7               $>Repayments Date<$                                                                             \Facility_tpRepaymentsDate
; PII     BA     7 1             $>Repayments Currency<$                                                                         \Facility_tpRepaymentsCurrency

PII   0 BN     7               $>After Grace period (Y/N)<$                                                                    \Facility_tpAfterGraceperiod
PII   0 BN     7               $>Repayment At A Certain Time<$                                                                 \Facility_tpHulpVarRepayment
; = Deze hulp variabele zorgt voor het bepalen van de juiste kolom waarin een aflossing met een bepaalde frequency gedaan moet worden - ook als ondersteuning voor de weighted average orginal tenor
PII   0 BN     7               $>Repayment Term for weighted remaining tenor<$                                                 \Facility_tpHulpVarRemainingWeighted
; = Deze hulp variabele zorgt voor het bepalen van de juiste kolom waarin een aflossing met een bepaalde frequency gedaan moet worden - ook als ondersteuning voor de weighted average remaining tenor

PII   0 BN     7               $>Weight of repayment Original Tenor<$                                                          \Facility_tpHulpVarWeightOfRepayment
PII   0 BN     7 1             $>Weight of repayment Remaining Tenor<$                                                         \Facility_tpHulpVarWeightOfRepaymentRemaining


PII   0 BN     7               $>Repayment At A Certain Time via Scheme<$                                                      \Facility_tpHulpVarRepaymentScheme
; = Deze hulp variabele zorgt voor het bepalen van de juiste kolom waarin een aflossing met een bepaalde frequency gedaan moet worden - ook als ondersteuning voor de weighted average orginal tenor
PII   0 BN     7 1             $>Repayment Term for weighted remaining tenor via Scheme<$                                      \Facility_tpHulpVarRepaymentSchemeWeighted
; = Deze hulp variabele zorgt voor het bepalen van de juiste kolom waarin een aflossing met een bepaalde frequency gedaan moet worden - ook als ondersteuning voor de weighted average remaining tenor


;==== Direct Liquidity Premium

PII     FX    -7-1             $>Direct Liquidity Premium Per T<$                                                              \Facility_tpDirectLiquidityPremiumPerT
PII   0 BN     7 1             $>Funding Amount Per T<$                                                                        \Facility_tpFundingAmountPerT
PII   0 FN     7               $>Funding Weighted Amount Per T<$                                                               \Facility_tpWeightedFundingAmountPerT
PII   4 FN     7               $>Period of T into years<$                                                                      \Facility_tpPeriodPerT
PII   4 FN     7               $>Interpolated Bps for Liq. Sprd<$                                                              \Facility_tpLiquiditySpreadBpsT
PII     FN     7 1             $>Liq. Sprd. Amount Per T<$                                                                     \Facility_tpLiquiditySpread
;--------------------------------------------
;PII   4 1N     7               Liquidity Premium                                                                               \Facility_tpLiquidityPremium



.Formulas Trend
Facility_tpWeightedAmountRepayment    = Facility_tpRepayment*Facility_tpHulpVarWeightOfRepayment
; C it calculates the weighted repayment amount on each period => (Xn x Rx)
Facility_tpWeightedAmountRepaymentRem = Facility_tpRepayment*Facility_tpHulpVarWeightOfRepaymentRemaining
; C it calculates the weighted repayment amount on each period => (Xn x Rx) for the remaining tenor

.Formulas NoTrend
Facility_tpWithdrawal                             = If(Facility_tpWithdrawalChoice=0,Facility_tpWithdrawalOneTime,If(Facility_tpWithdrawalChoice=1,Facility_tpWithdrawalFixedTerms,If(Facility_tpWithdrawalChoice=2,Facility_tpWithdrawalRevolving,If(Facility_tpWithdrawalChoice=3,Facility_tpWithdrawalsAmount,NA))))
; C For the history the first term depends on its method.
Facility_tpWithdrawalRevolving                 = NA

; ====== MANUAL =======
Facility_tpManual_tpMonthsSinceStartDate    = If(Facility_tpManual_tpFirstDayMonth = NA ,NA, ( DateToYear(Facility_tpManual_tpFirstDayMonth) - DateToYear(Facility_tpStartDate)) * 12 + DateToMonth(Facility_tpManual_tpFirstDayMonth) - DateToMonth(Facility_tpStartDate)) + If(Facility_tpManual_tpMonthsSinceStartDate = NA, NA,1)
; This variabele is based on months - depending time frequency
Facility_tpManual_tpMonthsSinceCurrentDate  = If(Facility_tpManual_tpFirstDayMonth = NA, NA,(If(DMYtoDate(01,DateToMonth(Facility_tpManual_tpFirstDayMonth),DateToYear(Facility_tpManual_tpFirstDayMonth)) < DMYtoDate(01,(DateToMonth(Facility_tpCurrentDate)),DateToYear(Facility_tpCurrentDate)) ,NA, ( ( DateToYear(Facility_tpManual_tpFirstDayMonth) - DateToYear(Facility_tpCurrentDate)) * 12 + (DateToMonth(Facility_tpManual_tpFirstDayMonth)) - DateToMonth(Facility_tpCurrentDate)+1))))
; This variabele is based on months - depending time frequency
Facility_tpManual_tpMonthsSinceCurrentDateHelpVarAvgOutstanding = If(Facility_tpManual_tpMonthsSinceCurrentDate > 12, 0, If(Facility_tpManual_tpMonthsSinceCurrentDate = NA,0,1))
Facility_tpManual_tpRepaymentAmountRemHelpVar      = If(Facility_tpManual_tpMonthsSinceCurrentDate > 0,1,0)
Facility_tpManual_tpRepaymentAmountRemHelpVar1     = Facility_tpManual_tpRepaymentAmount * Facility_tpManual_tpRepaymentAmountRemHelpVar
Facility_tpManual_tpRepaymentAmountRem             = Facility_tpManual_tpRepaymentAmount * Facility_tpManual_tpMonthsSinceCurrentDate
; This variabele is based on months - depending time frequency
Facility_tpManual_tpRepaymentWeighted              = Facility_tpManual_tpMonthsSinceStartDate * Facility_tpManual_tpRepaymentAmount
Facility_tpManual_tpRepaymentWeightedRem           = Facility_tpManual_tpMonthsSinceCurrentDate * Facility_tpManual_tpRepaymentAmount
Facility_tpManual_tpWithdrawalAmount               = If((Facility_tpManual_tpMonthsSinceStartDate = 1), Facility_tpPrincipalLimit, Facility_tpManual_tpWithdrawalAmount)
; Start of elements for calculating the liquidity spread for repayment tuples
Facility_tpManual_tpLiquiditySpreadBpsTRepayment   = (MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpManual_tpMonthsSinceStartDate,1),Facility_tpFixedInterestPeriod)+(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",Facility_tpManual_tpMonthsSinceStartDate,1),Facility_tpFixedInterestPeriod)-MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpManual_tpMonthsSinceStartDate,1),Facility_tpFixedInterestPeriod))*OnER(((Facility_tpManual_tpMonthsSinceStartDate-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpManual_tpMonthsSinceStartDate,1))/(MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",Facility_tpManual_tpMonthsSinceStartDate,1)-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpManual_tpMonthsSinceStartDate,1))),0))
Facility_tpManual_tpWeightedFundingRepayment       = Facility_tpManual_tpRepaymentamount * Facility_tpManual_tpMonthsSinceStartDate / 12
Facility_tpManual_tpLiquiditySpreadRepayment       = Facility_tpManual_tpWeightedFundingRepayment * Facility_tpManual_tpLiquiditySpreadBpsTRepayment      
; Start of elements for calculating the liquidity spread for withdrawal tuples        
Facility_tpManual_tpLiquiditySpreadBpsTWithdrawal  = (MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",(Facility_tpManual_tpMonthsSinceStartDate-1),1),Facility_tpFixedInterestPeriod)+(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",(Facility_tpManual_tpMonthsSinceStartDate-1),1),Facility_tpFixedInterestPeriod)-MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",(Facility_tpManual_tpMonthsSinceStartDate-1),1),Facility_tpFixedInterestPeriod))*OnER((((Facility_tpManual_tpMonthsSinceStartDate-1)-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",(Facility_tpManual_tpMonthsSinceStartDate-1),1))/(MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",(Facility_tpManual_tpMonthsSinceStartDate-1),1)-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",(Facility_tpManual_tpMonthsSinceStartDate-1),1))),0))
Facility_tpManual_tpWeightedFundingWithdrawal      = Facility_tpManual_tpWithdrawalAmount * (Facility_tpManual_tpMonthsSinceStartDate - 1) / 12
Facility_tpManual_tpLiquiditySpreadWithdrawal      = Facility_tpManual_tpWeightedFundingWithdrawal * Facility_tpManual_tpLiquiditySpreadBpsTWithdrawal

;Original Average Tenor - Scheme
Facility_tpSumOfWeightedRepaymentOATNominator              = TupleSum(Facility_tpManual_tpRepaymentWeighted)
Facility_tpSumOfRepaymentOATDenominator                    = 12 * (TupleSum(Facility_tpManual_tpRepaymentAmount))
Facility_tpOriginalAverageTenorScheme                      = Facility_tpSumOfWeightedRepaymentOATNominator / Facility_tpSumOfRepaymentOATDenominator

;Remaining Average Tenor - Scheme
Facility_tpSumOfRepaymentRAT                               = (TupleSum(Facility_tpManual_tpRepaymentAmountRemHelpVar1))
Facility_tpSumOfWeightedRepaymentRATNominator              = TupleSum(Facility_tpManual_tpRepaymentWeightedRem)
Facility_tpSumOfRepaymentRATWeight                         = Facility_tpSumOfWeightedRepaymentRATNominator / ( Facility_tpSumOfRepaymentRAT * Facility_tpExpectedAverageOutstandingCount )
Facility_tpRemainingAverageTenorScheme                     = If(  ((Facility_tpSumOfRepaymentRATWeight * Facility_tpExpectedAverageOutstandingCount) / 12) >= Facility_tpOriginalAverageTenorScheme  , Facility_tpOriginalAverageTenorScheme , ((Facility_tpSumOfRepaymentRATWeight * Facility_tpExpectedAverageOutstandingCount) / 12)    )

;Expected Average Outstanding - Scheme
Facility_tpManual_ExpectedAverageOutstandingWithdrawal            = Facility_tpManual_tpWithdrawalAmount * Facility_tpManual_tpOutstandingBalanceWeightWithdrawal
Facility_tpManual_ExpectedAverageOutstandingWithdrawalAnnuity     = If(Facility_tpManual_tpMonthsSinceStartDate < 1,Facility_tpManual_tpWithdrawalAmount * Facility_tpManual_tpOutstandingBalanceWeightWithdrawal, Facility_tpManual_tpWithdrawalAmount * Facility_tpManual_tpOutstandingBalanceWeightWithdrawal * If(Facility_tpOriginalTenor - Facility_tpRemainingTenor >= Facility_tpManual_tpMonthsSinceStartDate,1,0)) ;If(Facility_tpManual_tpMonthsSinceStartDate <= 1,1,0) )
Facility_tpManual_ExpectedAverageOutstandingRepayment             = Facility_tpManual_tpRepaymentAmount * Facility_tpManual_tpOutstandingBalanceWeightRepayment
Facility_tpManual_tpOutstandingBalanceWeightRepayment             = MinMax(12 - If(Facility_tpStartdate > Facility_tpCurrentDate, Facility_tpManual_tpMonthsSinceStartDate, Facility_tpManual_tpMonthsSinceCurrentDate) ,0,12,NA)
Facility_tpManual_tpOutstandingBalanceWeightWithdrawal            = MinMax(If(Facility_tpCurrentDate > Facility_tpManual_tpFirstDayMonth ,12, 13 - If(Facility_tpStartdate > Facility_tpCurrentDate, Facility_tpManual_tpMonthsSinceStartDate, Facility_tpManual_tpMonthsSinceCurrentDate)),0,12)
Facility_tpManual_tpOutstandingBalanceExpAvgOut                   = (Facility_tpEAOWithdrawalScheme - Facility_tpExpectedAverageOutstandingRemHelp)
Facility_tpEAOWithdrawalScheme                             = If(Facility_tpWithdrawalChoice=0,(Facility_tpPrincipalLimit * 12),If(Facility_tpWithdrawalChoice=3,(TupleSum(Facility_tpManual_ExpectedAverageOutstandingWithdrawal)),0 ) )
Facility_tpExpectedAverageOutstandingWithdrawalAnnuityHelp = TupleSum(Facility_tpManual_ExpectedAverageOutstandingWithdrawalAnnuity)
Facility_tpExpectedAverageOutstandingRemHelp               = TupleSum(Facility_tpManual_ExpectedAverageOutstandingRepayment)
Facility_tpExpectedAverageOutstandingCount                 = If(Facility_tpEndDate < Facility_tpCurrentDate,NA ,( ( DateToYear(Facility_tpEndDate) - DateToYear(Facility_tpCurrentDate)) * 12 + (DateToMonth(Facility_tpEndDate)) - DateToMonth(Facility_tpCurrentDate)))
Facility_tpExpectedAverageOutstandingCountMaxEAO           = MinMax(Facility_tpExpectedAverageOutstandingCount,0,12,NA)
Facility_tpOutstandingBalanceExpAvgOutDenom                = MinMax((Facility_tpProductduration - Facility_tpExpectedAverageOutstandingCount),0,12,0)
Facility_tpExpectedAverageOutstandingScheme                = ((Facility_tpEAOWithdrawalScheme - Facility_tpExpectedAverageOutstandingRemHelp) / Facility_tpExpectedAverageOutstandingCountMaxEAO) 

.Formulas Trend
Facility_tpWithdrawal                 = If(Facility_tpWithdrawalChoice=0,Facility_tpWithdrawalOneTime,If(Facility_tpWithdrawalChoice=1,Facility_tpWithdrawalFixedTerms,If(Facility_tpWithdrawalChoice=2,Facility_tpWithdrawalRevolving,If(Facility_tpWithdrawalChoice=3,Facility_tpWithdrawalsAmount,NA))))
Facility_tpWithdrawalOneTime          = If(DateToT(Facility_tpStartDate,1)=T,Facility_tpPrincipalLimit,NA)
Facility_tpWithdrawalRevolving        = If(DateToT(Facility_tpStartDate,1)=T,Facility_tpPrincipalLimit,NA)
Facility_tpRepayment                  = If((Facility_tpRepaymentChoice=0) or (Facility_tpRepaymentChoice=4),Facility_tpRepaymentBalloon,If(Facility_tpRepaymentChoice=1,Facility_tpRepaymentLinear+Facility_tpRepaymentBalloon,If(Facility_tpRepaymentChoice=2,Facility_tpRepaymentAnnuity+Facility_tpRepaymentBalloon,If(Facility_tpRepaymentChoice=3,If(T=DateToT(Facility_tpEndDateMax10,1),Facility_tpOutstandingBalance[T-1],Facility_tpRepaymentsAmount[T-1])))))
Facility_tpRepaymentLinear            = If(Facility_tpAfterGraceperiod,OnZero(Min((Facility_tpHulpVarRepayment[T-1]<>Facility_tpHulpVarRepayment)*((Facility_tpPrincipalLimit-Facility_tpBalloon)/(Facility_tpNumberOfPeriods)),Facility_tpOutstandingBalance[T-1]),NA),NA)
;C This linear payment scheme is varies in frequency (Monthly, quaterly, semi-annual and annual) and is stated a specific T, based on the grace period and repayment frequency
Facility_tpRepaymentAnnuity           = If(Facility_tpAfterGraceperiod,If((Facility_tpHulpVarRepayment[T-1]<>Facility_tpHulpVarRepayment),(Facility_tpHulpVarRepayment[T-1]<>Facility_tpHulpVarRepayment)*(PPMT((Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency),Facility_tpHulpVarRepayment,Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)),NA),NA)      ;variabele aanmaken voor de rate
;C This Annuity payment scheme is varies in frequency (Monthly, quaterly, semi-annual and annual) and is stated a specific T, based on the grace period and repayment frequency. Hereby it considers only the capital part PPMT because we are focussing ourself on the downpayments on capital and not on the inclusion of the interest part
Facility_tpRepaymentBalloon           = If(T=(DateToT(Facility_tpEndDateMax10,1)),If(Facility_tpRepaymentChoice=0,Facility_tpOutstandingBalance[T-1],If((Facility_tpRepaymentChoice=1) Or (Facility_tpRepaymentChoice=2),Facility_tpOutstandingBalance[T-1]-If(Facility_tpRepaymentChoice=1,Facility_tpRepaymentLinear[T],If(Facility_tpRepaymentChoice=2,Facility_tpRepaymentAnnuity[T],NA)),NA)))
;C This is the interest-only option and the remainder at end-date for linear and annuity



;--- Hulp variabelen ---
Facility_tpAfterGraceperiod           = If((T<DateToT(Facility_tpStartDate,1)) Or (T>DateToT(Facility_tpEndDateMax10,1)),NA,If(T>=DateToT(AddMonth(Facility_tpStartDate,Facility_tpGracePeriod),1),1,0))
;C This a variable that conditions the repayments after the grace period

Facility_tpHulpVarRepayment           = If(T>(DateToT(Facility_tpEndDateMax10,1)+1),NA,OnNeg(OnZero(Min(Round((T-(DateToT(Facility_tpStartDate,1))-Facility_tpGracePeriod)/(TsY/Facility_tpRepaymentFrequency)+0.5,0)-1,Facility_tpOutstandingBalance[T-1]),NA),NA))
; OnNotPos vervangen door OnNeg(On Zero,NA),NA)
;C this variable assists the repaymentschemes on its frequency and its relation to time, because we need the combine exisiting facilities with new facilties in the total amounts.

Facility_tpHulpVarRemainingWeighted    = If((T>=(DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1)))) And (T>(DateToT(Facility_tpStartDate,1)+Facility_tpGracePeriod)),OnNeg(OnZero(Min(Round((T-(If((DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1)))>(DateToT(Facility_tpStartDate,1)+Facility_tpGracePeriod),(DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1))),(DateToT(Facility_tpStartDate,1)+Facility_tpGracePeriod+1))))/(TsY/Facility_tpRepaymentFrequency)+0.5,0),Facility_tpOutstandingBalance[T-1]),NA),NA),NA)
; OnNotPos vervangen door OnNeg(OnZero,NA),NA)
;C this variable assists the remainder of the repaymentschemes on its frequency and its relation to time, because we need the combine exisiting facilities with new facilties in the total amounts.

Facility_tpHulpVarWeightOfRepayment   = If((T>DateToT(Facility_tpEndDateMax10,1)) Or (T<DateToT(Facility_tpStartdate,1)),NA,T-DateToT(Facility_tpStartDate,1))
;C this variable counts the outstanding period of each rrepayment to the start date
Facility_tpHulpVarWeightOfRepaymentRemaining  = If((T>DateToT(Facility_tpEndDateMax10,1)) Or (T<DateToT(If(Facility_tpCurrentDate<=Facility_tpStartDate,Facility_tpStartDate,Facility_tpCurrentDate),1)),NA,T-DateToT(If(Facility_tpCurrentDate<=Facility_tpStartDate,Facility_tpStartDate,Facility_tpCurrentDate),1))
;C this variable counts the outstanding period of each rrepayment to the current date

Facility_tpHulpVarRepaymentScheme      = If((Facility_tpRepaymentChoice=3) And (Facility_tpRepayment[T]<>NA),T-DateToT(Facility_tpStartDate,1),NA)
;C this variable counts the outstanding period of each manual repayment to the start date
Facility_tpHulpVarRepaymentSchemeWeighted  = If((Facility_tpRepaymentChoice=3) And (Facility_tpRepayment[T]<>NA),If((T>=(DateToT(Facility_tpCurrentDate,1)+(If(DateToDay(Facility_tpCurrentDate)=1,0,1)))) And (T>(DateToT(Facility_tpStartDate,1)+Facility_tpGracePeriod)),T-DateToT(Facility_tpCurrentDate,1),NA),NA)
;C this variable counts the outstanding period of each manual rrepayment to the current date


; --- Outstanding amount variabelen ---
Facility_tpOutstandingBalance         = OnNeg(OnZero(HSum(Facility_tpWithdrawal,DateToT(Facility_tpStartDate,1),T)-HSum(Facility_tpRepayment,DateToT(Facility_tpStartDate,1),T),NA),NA)
; OnNotPos vervangen door OnNeg(OnZero,NA),NA)
;C This variable sums the general withdrawals and repayments on a monthly basis
Facility_tpOutstandingBalanceHulpVar  = If(Facility_tpRepaymentChoice=0,Facility_tpOutstandingBalance,If((Facility_tpHulpVarFrequency[T]<Facility_tpHulpVarFrequency[T+1]),Facility_tpOutstandingBalance,Facility_tpOutstandingBalance*NA))
;C the variable makes sure that the Outstanding balance it calculated correctly when the average is calculated when the frequency is smaller than monthly

Facility_tpHulpVarFrequency           =If(T>DateToT(Facility_tpEndDateMax10,1),NA,If(T=DateToT(Facility_tpEndDateMax10,1),Facility_tpHulpVarFrequency[T-1]+1,Round((T-(DateToT(Facility_tpStartDate,1))-Facility_tpGracePeriod)/(TsY/Facility_tpRepaymentFrequency)+0.5,0)-1))
; This variable provides the delta to expose the T's for each outstanding balance according to its repayment frequency

; Facility_tpRepaymentChoice            = "0:BULLET|1:LINEAR|2:ANNUITY|3:SCHEME|4:REVOLVING" 
; Facility_tpWithdrawalChoice           = "0:ONCE|1:PERIODICAL|2:REVOLVING|3:SCHEME" 
; Facility_tpFixedInterestPeriodChoice  = "1:Base rate|2:1 months|3:3 months|4:6 months"
; Facility_tpRepaymentFrequency         = "1:$>YEARLY<$|2:$>HALF YEARLY<$|4:$>QUARTERLY<$|12:$>MONTHLY<$|"

Facility_tpExpectedAverageOutstanding = If((Facility_tpRepaymentChoice=4) Or (Facility_tpWithdrawalChoice=2),Facility_tpEAORevolving,If((Facility_tpWithdrawalChoice=0) And (Facility_tpRepaymentChoice=0), Facility_tpPrincipalLimit, If((Facility_tpWithdrawalChoice=0) And (Facility_tpRepaymentChoice=1), Facility_tpEAOOnceLinear, If((Facility_tpWithdrawalChoice=0) And (Facility_tpRepaymentChoice=2), Facility_tpEAOOnceAnnuity, If((Facility_tpWithdrawalChoice=0) And (Facility_tpRepaymentChoice=3), Facility_tpExpectedAverageOutstandingScheme, If((Facility_tpWithdrawalChoice=3) And (Facility_tpRepaymentChoice=0),Facility_tpExpectedAverageOutstandingScheme, If((Facility_tpWithdrawalChoice=3) And (Facility_tpRepaymentChoice=1),Facility_tpEAOSchemeLinear,If((Facility_tpWithdrawalChoice=3) And (Facility_tpRepaymentChoice=2),Facility_tpEAOSchemeAnnuity,If((Facility_tpWithdrawalChoice=3) And (Facility_tpRepaymentChoice=3),Facility_tpExpectedAverageOutstandingScheme,Facility_tpEAORevolving)))))))))

;============================= Direct Liquidity Premium ===============================================

Facility_tpLiquiditySpreadBps            = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,4)=0,0,If(Facility_tpOriginalTenor<12,Facility_tpLiquiditySpreadBpsUnder1year,Facility_tpLiquiditySpreadBpsGeneral))
Facility_tpLiquiditySpreadBpsUnder1year  = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,9)=1,Facility_tpLiquiditySpreadRevolvingCredit,If((Facility_tpRepaymentChoice=0) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentBullet/Facility_tpExpectedAverageOutstanding),If((Facility_tpRepaymentChoice=1) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentLinear/Facility_tpExpectedAverageOutstanding),If((Facility_tpRepaymentChoice=2) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentAnnuity/Facility_tpExpectedAverageOutstanding),If((Facility_tpRepaymentChoice=3) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentScheme/Facility_tpExpectedAverageOutstanding),If((Facility_tpRepaymentChoice=0) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentBullet-Facility_tpLiquiditySpreadWithdrawalScheme)/Facility_tpExpectedAverageOutstanding,If((Facility_tpRepaymentChoice=1) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentLinear-Facility_tpLiquiditySpreadWithdrawalScheme)/Facility_tpExpectedAverageOutstanding,If((Facility_tpRepaymentChoice=2) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentAnnuity-Facility_tpLiquiditySpreadWithdrawalScheme)/Facility_tpExpectedAverageOutstanding,If((Facility_tpRepaymentChoice=3) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentScheme-Facility_tpLiquiditySpreadWithdrawalScheme)/Facility_tpExpectedAverageOutstanding,NA)))))))))
;C the liquidity spread must be weighted on ite funding amount and multiplied by corresponding term from its liquidity curve on its currency under 1 year needs to be de-annualized

Facility_tpLiquiditySpreadBpsGeneral    = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,9)=1,Facility_tpLiquiditySpreadRevolvingCredit,If((Facility_tpRepaymentChoice=0) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentBullet/Facility_tpWeightedFundingRepaymentBullet),If((Facility_tpRepaymentChoice=1) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentLinear/Facility_tpWeightedFundingRepaymentLinear),If((Facility_tpRepaymentChoice=2) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentAnnuity/Facility_tpWeightedFundingRepaymentAnnuity),If((Facility_tpRepaymentChoice=3) And (Facility_tpWithdrawalChoice=0),(Facility_tpLiquiditySpreadRepaymentScheme/Facility_tpWeightedFundingRepaymentScheme),If((Facility_tpRepaymentChoice=0) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentBullet-Facility_tpLiquiditySpreadWithdrawalScheme)/(Facility_tpWeightedFundingRepaymentBullet-Facility_tpWeightedFundingWithdrawalScheme),If((Facility_tpRepaymentChoice=1) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentLinear-Facility_tpLiquiditySpreadWithdrawalScheme)/(Facility_tpWeightedFundingRepaymentLinear-Facility_tpWeightedFundingWithdrawalScheme),If((Facility_tpRepaymentChoice=2) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentAnnuity-Facility_tpLiquiditySpreadWithdrawalScheme)/(Facility_tpWeightedFundingRepaymentAnnuity-Facility_tpWeightedFundingWithdrawalScheme),If((Facility_tpRepaymentChoice=3) And (Facility_tpWithdrawalChoice=3),(Facility_tpLiquiditySpreadRepaymentScheme-Facility_tpLiquiditySpreadWithdrawalScheme)/(Facility_tpWeightedFundingRepaymentScheme-Facility_tpWeightedFundingWithdrawalScheme),NA)))))))))
; ----------------------- Support variables for liquidity spread calculation ----------------------------------------------------
Facility_tpRepaymentFrequencyLiqSpread    = If((Facility_tpWithdrawalChoice = 3),12,Facility_tpRepaymentFrequency) 
; C The repayment frequency liq spread variable sets the repayment frequency at 'monthly' when the withdrawal mode is manual, for the liquidity spread to use the correct weight factor and interpolated bps (equal to the withdrawal terms).
Facility_tpConvertToMonths                = If((Facility_tpWithdrawalChoice = 3),12/Facility_tpRepaymentFrequency,1)
; C Facility_tpConvertToMonths converts the weight of the X for the SumFor function to months
Facility_tpGracePeriodInPeriods           = RoundUp(Facility_tpGracePeriod/(12/Facility_tpRepaymentFrequency),0)
; ---------------------- Partial variables for weighted funding and liquidity spread per modality ------------------------------
Facility_tpWeightedFundingRepaymentBullet = Facility_tpPrincipalLimit * Facility_tpOriginalTenor/12
Facility_tpLiquiditySpreadRepaymentBullet = Facility_tpPrincipalLimit * Facility_tpOriginalTenor/12*(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpOriginalTenor,1),Facility_tpFixedInterestPeriod)+(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",Facility_tpOriginalTenor,1),Facility_tpFixedInterestPeriod)-MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpOriginalTenor,1),Facility_tpFixedInterestPeriod))*OnER(((Facility_tpOriginalTenor-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpOriginalTenor,1))/(MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",Facility_tpOriginalTenor,1)-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",Facility_tpOriginalTenor,1))),0))
Facility_tpWeightedFundingRepaymentLinear  = FesExpression("SumFor(X,1+Facility_tpGracePeriodInPeriods,Facility_tpNumberOfPeriodsNoGrace,1,Facility_tpLinear*(X*Facility_tpConvertToMonths/Facility_tpRepaymentFrequencyLiqSpread))")
Facility_tpLiquiditySpreadRepaymentLinear  = FesExpression("SumFor(X,1+Facility_tpGracePeriodInPeriods,Facility_tpNumberOfPeriodsNoGrace,1,Facility_tpLinear*(X*Facility_tpConvertToMonths/Facility_tpRepaymentFrequencyLiqSpread)*(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1),Facility_tpFixedInterestPeriod)+(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",X*12/Facility_tpRepaymentFrequency,1),Facility_tpFixedInterestPeriod)-MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1),Facility_tpFixedInterestPeriod))*OnER(((X*12/Facility_tpRepaymentFrequency-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1))/(MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",X*12/Facility_tpRepaymentFrequency,1)-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1))),0)))")
Facility_tpWeightedFundingRepaymentAnnuity = FesExpression("SumFor(X,1+Facility_tpGracePeriodInPeriods,Facility_tpNumberOfPeriodsNoGrace,1,PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,(X-Facility_tpGracePeriodInPeriods),Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)*(X*Facility_tpConvertToMonths/Facility_tpRepaymentFrequencyLiqSpread))")
Facility_tpLiquiditySpreadRepaymentAnnuity  = FesExpression("SumFor(X,1+Facility_tpGracePeriodInPeriods,Facility_tpNumberOfPeriodsNoGrace,1,PPMT(Facility_tpAnnuityInterestRate/Facility_tpRepaymentFrequency,(X-Facility_tpGracePeriodInPeriods),Facility_tpNumberOfPeriods,-Facility_tpPrincipalLimit,Facility_tpBalloon)*(X*Facility_tpConvertToMonths/Facility_tpRepaymentFrequencyLiqSpread)*(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1),Facility_tpFixedInterestPeriod)+(MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",X*12/Facility_tpRepaymentFrequency,1),Facility_tpFixedInterestPeriod)-MatrixLookup("AAB_Parameters.xls",&If(&Facility_tpBaseCurrency="EUR","LiquidityPremiumEUR",&If(&Facility_tpBaseCurrency="GBP","LiquidityPremiumGBP",&If(&Facility_tpBaseCurrency="USD","LiquidityPremiumUSD","LiquidityPremiumOther"))),&MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1),Facility_tpFixedInterestPeriod))*OnER(((X*12/Facility_tpRepaymentFrequency-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1))/(MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorUpperBound",X*12/Facility_tpRepaymentFrequency,1)-MatrixLookup("AAB_Parameters.xls","LiquidityPremiumTenorLowerBound",X*12/Facility_tpRepaymentFrequency,1))),0)))")
Facility_tpWeightedFundingRepaymentScheme = TupleSum(Facility_tpManual_tpWeightedFundingRepayment)
Facility_tpLiquiditySpreadRepaymentScheme = TupleSum(Facility_tpManual_tpLiquiditySpreadRepayment)
Facility_tpWeightedFundingWithdrawalScheme = TupleSum(Facility_tpManual_tpWeightedFundingWithdrawal)
Facility_tpLiquiditySpreadWithdrawalScheme = TupleSum(Facility_tpManual_tpLiquiditySpreadWithdrawal)
Facility_tpLiquiditySpreadRevolvingCredit  = If(Facility_tpInterestRateIndexBasis=1,0,MatrixLookup("AAB_Parameters.xls","LiquidityPremiumRevolvingCredit",&Facility_tpProductinterestDetailsInterestProductName,If(&Facility_tpBaseCurrency="EUR",1,If(&Facility_tpBaseCurrency="GBP",2,If(&Facility_tpBaseCurrency="USD",3,4)))))
;C the liquidity spread must be weighted on ite funding amount and multiplied by corresponding term from its liquidity curve on its currency

;=============================== Guarantor ===========================================

.Variables
PP      1X     5               &"$>Third party Guarantees<$"                                             \Facility_tpGuarantor
PI      1N C   6               $>Do you want to use an AGIC or SBI identification code?<$                \Facility_tpGuarantorAGICOrSBI
PI      1A     6               $>SBI branche code (Geen lijst)<$                                         \Facility_tpGuarantorSBI                         ;Pas op nog geen lijst
PP      1A     6               $>SBI branche naam<$                                                      \Facility_tpGuarantorSBIName
PI      1N C   6               $>AGIC Sector<$                                                           \Facility_tpGuarantorAGICChoice
PP      1A     6               $>AGIC Code<$                                                             \Facility_tpGuarantorAGIC
PI    0 1N %   6               $>Percentage guanranteed<$                                                \Facility_tpGuarantorPercentageGuaranteed
PI      1N C   6               $>UCR Rating<$                                                            \Facility_tpGuarantorRatingChoice
PI      1A     6               $>UCR Rating Guarantor<$                                                  \Facility_tpGuarantorRating  ;; Titel aangepast voor Compact Report
PI      1N C   6               $>PD Model<$                                                              \Facility_tpGuarantorPDModelChoice
PI      1A     6               $>PD Model Tekst<$                                                        \Facility_tpGuarantorPDModel
PI    4 1N %   6               $>Probability of Default (%)<$                                            \Facility_tpGuarantorPD
PI    4 1N %   6               $>Probability of Default  MoC (%)<$                                       \Facility_tpGuarantorPDMoC
PI    3 1N     6               $>MoC Factor<$                                                            \Facility_tpGuarantorMoCFactor

.Choices
;Facility_tpGuarantorSBIChoice              = file "Choice_SBI.fib"
Facility_tpGuarantorAGICChoice             = file "Choice_AGIC.fib"
Facility_tpGuarantorRatingChoice           = file "Choice_UCR.fib"
Facility_tpGuarantorPDModelChoice          = file "Choice_PDModel.fib"
Facility_tpGuarantorAGICOrSBI              = "0:AGIC|1:SBI"


.Formulas Visible
Facility_tpGuarantorRating                 = ShowTestVariables
Facility_tpGuarantorPDModel                = ShowTestVariables
Facility_tpGuarantorAGIC                   = ShowTestVariables

.Formulas NoTrend
Facility_tpGuarantorAGICOrSBI              = 0
Facility_tpGuarantorSBIName                = &MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Facility_tpGuarantorSBI,1)
Facility_tpGuarantorAGIC                   = &SubStr(&TableLookup("Choice_AGIC",Facility_tpGuarantorAGICChoice),0,4)
Facility_tpGuarantorRating                 = &TableLookup("Choice_UCR",Facility_tpGuarantorRatingChoice)
Facility_tpGuarantorPDModel                = &SubStr(&TableLookup("Choice_PDModel",Facility_tpGuarantorPDModelChoice),0,4)
Facility_tpGuarantorPD                     = MatrixLookup("AAB_Parameters.xls","PD",&Facility_tpGuarantorRating,1)*Facility_tpPDMultiplierUnder1Year
Facility_tpGuarantorPDMoC                  = Facility_tpGuarantorPD*Facility_tpGuarantorMoCFactor
Facility_tpGuarantorMoCFactor              = MatrixLookup("AAB_Parameters.xls","MOCFactorPD",Facility_tpGuarantorPDModel,1)


;=============================== Profit and Losses - Facility ========================
.Variables
PP      1X     5               Profit and Losses - Facility

PP    0 1N     6               =Facility_tpCreditIncome                                             \=Facility_tpCreditIncome
PP      1N     7               =Facility_tpInterestIncome                                           \=Facility_tpInterestIncome
PP      1N     7               =Facility_tpCreditRelatedFee                                         \=Facility_tpCreditRelatedFee
PP    0 1N    -7               =Facility_tpCreditIncome                                             \=Facility_tpCreditIncome
PP     -1N     6               =Facility_tpIndirectLiquidityCosts                                   \=Facility_tpIndirectLiquidityCosts
PP     -1N     6               =Facility_tpDirectLiquidityPremium                                   \=Facility_tpDirectLiquidityPremium
PP     -1N     6               =Facility_tpSubordinatedDebtCapitalCharge                            \=Facility_tpSubordinatedDebtCapitalCharge
PP      1N     6               =Facility_tpEquityFundingAdjustment                                  \=Facility_tpEquityFundingAdjustment
PP     -1N     6               =Facility_tpOperationalCosts                                         \=Facility_tpOperationalCosts
PP     -1N     6               =Facility_tpInternalExpectedLoss                                     \=Facility_tpInternalExpectedLoss
PP     -1N     6               =Facility_tpTax                                                      \=Facility_tpTax
PP    0 1N    -6               =Facility_tpRiskAdjustedReturn                                       \=Facility_tpRiskAdjustedReturn

PP    2 1N %   6               =Facility_tpReturnOnEquity                                           \=Facility_tpReturnOnEquity
PP    0 1N     7               =Facility_tpRiskAdjustedReturn                                       \=Facility_tpRiskAdjustedReturn
PP    2 1N %  -7               =Facility_tpReturnOnEquity                                           \=Facility_tpReturnOnEquity

PP    2 1N %   6               =Facility_tpRaRoRaC        											\=Facility_tpRaRoRaC
PP    0 1N     7               =Facility_tpRiskAdjustedReturn                                       \=Facility_tpRiskAdjustedReturn
PP      1N     7               =Facility_tpEconomicCapital                                          \=Facility_tpEconomicCapital
PP    2 1N %  -7               =Facility_tpRaRoRaC        											\=Facility_tpRaRoRaC




PP    0 1N     6               =Facility_tpRegulatoryProfit                                         \=Facility_tpRegulatoryProfit
PP    0 1N     7               =Facility_tpRiskAdjustedReturn                                       \=Facility_tpRiskAdjustedReturn
PP     -1N     7               =Facility_tpEquityCapitalCharge                                      \=Facility_tpEquityCapitalCharge
PP    0 1N    -7               =Facility_tpRegulatoryProfit                                         \=Facility_tpRegulatoryProfit

PP    0 1N     6               =Facility_tpEconomicProfit                                           \=Facility_tpEconomicProfit
PP    0 1N     7               =Facility_tpRiskAdjustedReturn                                       \=Facility_tpRiskAdjustedReturn
PP    0-1N     7               =Facility_tpCostOfEconomicCapital                                    \=Facility_tpCostOfEconomicCapital
PP      1N     8               =Facility_tpEconomicCapital                                          \=Facility_tpEconomicCapital
PP     x1N %   8               =Facility_tpEffectiveCostOfCapital                                   \=Facility_tpEffectiveCostOfCapital
PP      1N     6               =Facility_tpOtherMetrics        									                    \=Facility_tpOtherMetrics
PP      1N     7               =Facility_tpPrincipalLimit                                           \=Facility_tpPrincipalLimit
PP      1N     7               =Facility_tpExpectedAverageOutstanding                               \=Facility_tpExpectedAverageOutstanding
PP      1N     7               =Facility_tpInternalExpectedLoss                                     \=Facility_tpInternalExpectedLoss
PP      1N     7               =Facility_tpRWA                                                      \=Facility_tpRWA
PP      1N     7               =Facility_tpEAD                                                      \=Facility_tpEAD

;;----------------------------- Target RaRoRaC Facility -------------------------------------------------------
.Variables
PPP   0 1N     5               "Target RaRoRaC"                            \Facility_tpTargetRaRoRaCSection
PPI   1 1N   1 6               "Goalseek RaRoRaC Outcome"                  \Facility_tpRequiredInterestMarginBps
PII   2 1N     6               "TargetVariable - Facility_tpRaRoRaC"       \Facility_tpTargetVariable
PII   2 1N     6               "TargetValue - Facility Target RaRoRaC"     \Facility_tpTargetValue
PII   2 1N     6               "RangeStartValue"                           \Facility_tpStartValue
PII   2 1N     6               "RangeEndValue"                             \Facility_tpEndValue
PII   2 1N     6               "SmallestDelta"                             \Facility_tpSmallestDelta
PII   2 1N     6               "MaxRuntimeMs"                              \Facility_tpMaxRuntimeMs

.Formulas NoTrend
Facility_tpStartValue            = 0
Facility_tpEndValue              = 5000
Facility_tpSmallestDelta         = 1
Facility_tpMaxRuntimeMs          = 6000
Facility_tpRequiredInterestMarginBps     = If(TargetRaRoRaCDriven,FesExpression("GoalSeek(Facility_tpRaRoRaC, Facility_tpTargetRaRoRac , Facility_tpCustomerSpread , Facility_tpStartValue, Facility_tpEndValue, Facility_tpSmallestDelta, Facility_tpMaxRuntimeMs)"),NA)

;;============================== Economic Capital ================================================================
.Variables

PI      1N     5               $>Economic Capital<$                                                                             \Facility_tpEconomicCapital

;=============================   $>Economic Capital - Operational Risk<$  ========================

PP      1N     6               $>Economic Capital - Operational Risk<$                                                          \Facility_tpOperationalRisk
PP      1N     7               $>Economic Capital - Operational Risk - Credit Risk<$                                            \Facility_tpORCreditRisk
PI    0 1N     8               $>Economic Capital - Operational Risk - OR EC<$                                                  \Facility_tpOREC


.Formulas NoTrend
Facility_tpEconomicCapital      = Facility_tpOperationalRisk+Facility_tpCreditRisk+Facility_tpBusinessRisk
Facility_tpOperationalRisk      = Facility_tpORCreditRisk
Facility_tpORCreditRisk         = Borrower_tpARCAddOn*AgreementDiversificationOR*(Facility_tpOREC/10000)*(Facility_tpCreditIncome-Facility_tpDirectLiquidityPremium)
Facility_tpOREC                 = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,3)



;=============================   $>Economic Capital - Business Risk<$  ========================

.Variables
PP      1N     6               $>Economic Capital - Business Risk<$                                                           \Facility_tpBusinessRisk
PP      1N     7               $>Economic Capital - Business Risk - Credit Risk<$                                             \Facility_tpBRCreditRisk
PI    0 1N     8               $>Economic Capital - Business Risk - BR EC<$                                                   \Facility_tpBREC

.Formulas NoTrend
Facility_tpBusinessRisk         = Facility_tpBRCreditRisk
Facility_tpBRCreditRisk         = Borrower_tpARCAddOn*AgreementDiversificationBR*(Facility_tpBREC/10000)*(Facility_tpCreditIncome-Facility_tpDirectLiquidityPremium)
Facility_tpBREC                 = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,9)


;=============================   $>Economic Capital - Credit Risk<$  ========================

.Variables
PI      1N     6               $>Economic Capital - Credit Risk<$                                                              \Facility_tpCreditRisk

PI      1N     7               $>Economic Capital - Credit Risk Unguaranteed<$                                                 \Facility_tpCreditRiskUnguaranteed
PI      1N     7               $>Economic Capital - Credit Risk Guaranteed<$                                                   \Facility_tpCreditRiskGuaranteed

PI    6 1N     8               $>Risk Weight Guarantor<$                                                                       \Facility_tpRiskWeightGuarantor
PI    5 1N     8               $>Rho Guarantor<$                                                                               \Facility_tpRhoGuarantor
PI    6 1N     8               $>Calibration Factor Guarantor<$                                                                \Facility_tpCalibrationFactorGuarantor
PI      1A     8               $>Calibration Factor ID Guarantor<$                                                             \Facility_tpCalibrationFactorIDGuarantor

;------------------

PI      1N     7               $>Exposure At Default<$                                                                         \Facility_tpEAD ;; Titel aangepast voor Compact Report

PI      1X     8               $>Economic Capital - Credit Risk - General<$                                                    \Facility_tpEADGeneral
PI      1N C   9               $>Economic Capital - Credit Risk - Headroom<$                                                   \Facility_tpHeadroom
PI      1N     9               $>Economic Capital - Credit Risk - Outstanding Unguaranteed<$                                   \Facility_tpOutstandingUnguaranteed
PI      1N     9               $>Economic Capital - Credit Risk - Outstanding Guaranteed<$                                     \Facility_tpOutstandingGuaranteed
PI      1N     9               $>Economic Capital - Credit Risk - Principal Limit Unguaranteed<$                               \Facility_tpPrincipalLimitUnguaranteed
PI      1N     9               $>Economic Capital - Credit Risk - Principal Limit Guaranteed<$                                 \Facility_tpPrincipalLimitGuaranteed

; ---------------------------------EAD Standard ---------------------------------------------
PI      1N     8               $>Economic Capital - Credit Risk - Exposure At Default Standard<$                               \Facility_tpEADUnguaranteed
PI      1N     9               $>Economic Capital - Credit Risk - Exposure At Default<$                                        \Facility_tpEADUnguaranteedHR
C When the headroom is greater than 0 Euro. NB: Negative values for UGD and PGO are not used in this pricing tool
PI      1N     9               $>Economic Capital - Credit Risk - Exposure At Default Zero Headroom<$                          \Facility_tpEADUnguaranteedHRZero
C When the headroom is less than or equal to 0 Euro. NB: Negative values for UGD and PGO are not used in this pricing tool


; ---------------------------------EAD Guaranteed---------------------------------------------
PI      1N     8               $>Economic Capital - Credit Risk - Exposure At Default Guaranteed<$                             \Facility_tpEADGuaranteed
PI      1N     9               $>Economic Capital - Credit Risk - Exposure At Default<$                                        \Facility_tpEADGuaranteedHR
C When the headroom is greater than 0 Euro. NB: Negative values for UGD and PGO are not used in this pricing tool
PI      1N     9               $>Economic Capital - Credit Risk - Exposure At Default Zero Headroom<$                          \Facility_tpEADGuaranteedHRZero
C When the headroom is less than or equal to 0 Euro. NB: Negative values for UGD and PGO are not used in this pricing tool


PI    2 1N %   8               $>Economic Capital - Credit Risk - LEF<$                                                        \Facility_tpLEF
PI    2 1N %   8               $>Economic Capital - Credit Risk - UGD (%)<$                                                    \Facility_tpUGD
PI    2 1N %   8               $>Economic Capital - Credit Risk - PGO (%)<$                                                    \Facility_tpPGO
PI    2 1N     8               $>Economic Capital - Credit Risk - MOCEAD<$                                                     \Facility_tpMOCEAD
PI    2 1N     8               $>Economic Capital - Credit Risk - AF<$                                                         \Facility_tpAF
PI      1A     9               $>Economic Capital - Credit Risk - Search ID LEFfactors<$                                       \Facility_tpIDLEFfactors
PI    0 1N     9               $>Economic Capital - Credit Risk - Search ID Lower limit<$                                      \Facility_tpLowerlimit
PI    0 1N     9               $>Economic Capital - Credit Risk - Search ID Usage limit<$                                      \Facility_tpUsageLimit
PI      1A     9               $>Economic Capital - Credit Risk - Search ID UGD/PGO<$                                          \Facility_tpUGDPGO

;; --------------------------------Internal Expected Loss for Credit Risk - Unguaranteed -----------------------------------------------------------------

PI    2 1N     7               $>Economic Capital Multiplier<$                                                                 \Facility_tpECMultiplier
PI    2 1N     7               $>Economic Capital Multiplier Guarantor<$                                                       \Facility_tpECMultiplierGuarantor
PI    2 1N     8               $>Economic Capital Multiplier Lower Tenor<$                                                     \Facility_tpECMultiplierTenorLowerBound
PI    2 1N     8               $>Economic Capital Multiplier Upper Tenor<$                                                     \Facility_tpECMultiplierTenorUpperBound
PI    2 1N     8               $>Economic Capital Multiplier Lower Bound<$                                                     \Facility_tpECMultiplierLowerBound
PI    2 1N     8               $>Economic Capital Multiplier Upper Bound<$                                                     \Facility_tpECMultiplierUpperBound
PI    2 1N     8               $>Economic Capital Multiplier Lower Bound Guarantor<$                                           \Facility_tpECMultiplierLowerBoundGuarantor
PI    2 1N     8               $>Economic Capital Multiplier Upper Bound Guarantor<$                                           \Facility_tpECMultiplierUpperBoundGuarantor

PI      1N     7               $>Economic Capital - Credit Risk - Internal Expected Loss<$                                     \Facility_tpIELMoC
PI      1N     8               $>Economic Capital - Credit Risk - Internal Expected Loss - Unguaranteed<$                      \Facility_tpIELMoCUnguaranteed
PI    4 1N     9               $>Expected Loss Multiplier<$                                                                    \Facility_tpELMultiplierECUnguaranteed
PI      1N     9               $>Expected Loss - Lower M<$                                                                     \Facility_tpELMultiplierLowerM
PI      1N     9               $>Expected Loss - Upper M<$                                                                     \Facility_tpELMultiplierUpperM
PI      1A     9               $>Expected Loss Multiplier ID Economic Capital - Unguaranteed<$                                 \Facility_tpELMultiplierIDECUnguaranteed
PI      1A     9               $>Expected Loss Multiplier ID Economic Capital - Unguaranteed - Lower M<$                       \Facility_tpELMultiplierIDLowerMECUnguaranteed
PI      1A     9               $>Expected Loss Multiplier ID Economic Capital - Unguaranteed - Upper M<$                       \Facility_tpELMultiplierIDUpperMECUnguaranteed

;; -------------------------------Internal Expected Loss for Credit Risk - Guaranteed -----------------------------------------------------------------------

PI      1N     8               $>Economic Capital - Credit Risk - Internal Expected Loss - Guaranteed<$                        \Facility_tpIELMoCGuaranteed
PI    8 1N     9               $>Expected Loss Multiplier Guaranteed<$                                                         \Facility_tpELMultiplierECGuaranteed
PI      1A     9               $>Expected Loss Multiplier ID Economic Capital - Guaranteed<$                                   \Facility_tpELMultiplierIDECGuaranteed
PI      1A     9               $>Expected Loss Multiplier ID Economic Capital - Guaranteed - Lower M<$                         \Facility_tpELMultiplierIDLowerMECGuaranteed
PI      1A     9               $>Expected Loss Multiplier ID Economic Capital - Guaranteed - Upper M<$                         \Facility_tpELMultiplierIDUpperMECGuaranteed
PI    4 1N %   9               $>Joint PD MoC<$                                                                                \Facility_tpJointPDMoC
PI      1N     9               $>Equity Index Borrower<$                                                                       \Facility_tpEquityIndexBorrower
PI      1N     9               $>Equity Index Guarantor<$                                                                      \Facility_tpEquityIndexGuarantor
PI    8 1N     9               $>Intrasector Correlation Borrower<$                                                            \Facility_tpIntraSectorCorrelationBorrower
PI    8 1N     9               $>Intrasector Correlation Guarantor<$                                                           \Facility_tpIntraSectorCorrelationGuarantor
PI      1A     9               $>Inter-sector Correlation Factor ID<$                                                          \Facility_tpEquityCorrelationID
PI    8 1N     9               $>Inter-sector Correlation Factor<$                                                        	   \Facility_tpEquityCorrelation
PI    8 1N     9               $>Inverse Normal Borrower<$                                                              	     \Facility_tpInvNormalBorrower
PI    8 1N     9               $>Inverse Normal Guarantor<$                                                              	     \Facility_tpInvNormalGuarantor


.Choices
Facility_tpHeadroom                           = "1:Yes|0:No"

.Formulas NoTrend
Facility_tpCreditRisk                         = Facility_tpCreditRiskUnguaranteed+Facility_tpCreditRiskGuaranteed


Facility_tpCreditRiskUnguaranteed             = OnER(Min(Facility_tpEADUnguaranteed,(Borrower_tpARCAddOn*Facility_tpEADUnguaranteed*Facility_tpLGDMoC*Facility_tpBorrower_tpRiskWeight*Borrower_tpCalibrationFactor*Facility_tpECMultiplier-Facility_tpIELMoCUnguaranteed)*AgreementDiversificationCR),NA)
Facility_tpCreditRiskGuaranteed               = OnER(Min(Facility_tpEADGuaranteed,(Borrower_tpARCAddOn*Facility_tpEADGuaranteed*Facility_tpLGDMoC*Facility_tpRiskWeightGuarantor*Facility_tpCalibrationFactorGuarantor*Facility_tpECMultiplierGuarantor-Facility_tpIELMoCGuaranteed)*AgreementDiversificationCR),NA)

Facility_tpRiskWeightGuarantor                = CumNormal((InvNormal(Facility_tpGuarantorPDMoC)-((Facility_tpRhoGuarantor^0.5)*(InvNormal(1-Borrower_tpConfidenceLevel))))/((1-Facility_tpRhoGuarantor)^0.5))
Facility_tpRhoGuarantor                       = MatrixLookup("AAB_Parameters.xls","EquityIndex",Facility_tpEquityIndexGuarantor,4)
Facility_tpCalibrationFactorGuarantor         = MatrixLookup("AAB_Parameters.xls","CalibrationFactor",&Facility_tpCalibrationFactorIDGuarantor,3)
Facility_tpCalibrationFactorIDGuarantor       = &Facility_tpGuarantorRating&"_"&Borrower_tpClientGroup

Facility_tpHeadroom                           = If((Facility_tpLimit-Facility_tpExpectedAverageOutstanding)>0,1,0)

Facility_tpOutstandingUnguaranteed            = Facility_tpExpectedAverageOutstanding*(1-Facility_tpGuarantorPercentageGuaranteed)
Facility_tpOutstandingGuaranteed              = Facility_tpExpectedAverageOutstanding*Facility_tpGuarantorPercentageGuaranteed
Facility_tpPrincipalLimitUnguaranteed         = Facility_tpPrincipalLimit*(1-Facility_tpGuarantorPercentageGuaranteed)
Facility_tpPrincipalLimitGuaranteed           = Facility_tpPrincipalLimit*Facility_tpGuarantorPercentageGuaranteed
Facility_tpEAD                                = If(Facility_tpHeadroom=1,Facility_tpEADUnguaranteedHR+Facility_tpEADGuaranteedHR,Facility_tpEADUnguaranteedHRZero+Facility_tpEADGuaranteedHRZero)

Facility_tpEADUnguaranteed                    = If(Facility_tpHeadroom=1,Facility_tpEADUnguaranteedHR,Facility_tpEADUnguaranteedHRZero)
Facility_tpEADUnguaranteedHR                  = Facility_tpLEF*(Facility_tpOutstandingUnguaranteed+(Facility_tpUGD*(1+(Facility_tpMOCEAD*Facility_tpAF))*(Max((Facility_tpPrincipalLimitUnguaranteed-Facility_tpOutstandingUnguaranteed),0))))
Facility_tpEADUnguaranteedHRZero              = Facility_tpLEF*(Facility_tpOutstandingUnguaranteed+(Facility_tpPGO*(1+(Facility_tpMOCEAD*Facility_tpAF))*Facility_tpOutstandingUnguaranteed))

Facility_tpEADGuaranteed                      = If(Facility_tpHeadroom=1,Facility_tpEADGuaranteedHR,Facility_tpEADGuaranteedHRZero)
Facility_tpEADGuaranteedHR                    = Facility_tpLEF*(Facility_tpOutstandingGuaranteed+(Facility_tpUGD*(1+(Facility_tpMOCEAD*Facility_tpAF))*(Max((Facility_tpPrincipalLimitGuaranteed-Facility_tpOutstandingGuaranteed),0))))
Facility_tpEADGuaranteedHRZero                = Facility_tpLEF*(Facility_tpOutstandingGuaranteed+(Facility_tpPGO*(1+(Facility_tpMOCEAD*Facility_tpAF))*Facility_tpOutstandingGuaranteed))

Facility_tpIDLEFfactors                       = &Facility_tpType&"_"&Facility_tpLowerlimit&"_"&Facility_tpUsageLimit&"_"&Facility_tpUGDPGO
Facility_tpLowerlimit   		      	          = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,8)=1,If(Facility_tpHeadroom,Case(Facility_tpLimit,[<=100000:0|<=350000:100000|<=1000000:350000|<=3000000:1000000|>3000000:3000000]),Case(Facility_tpPrincipalLimit,[<=70000:0|<=300000:70000|<=1000000:300000|>1000000:1000000])),0)
Facility_tpUsageLimit                         = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,10)=1,0,If(Facility_tpHeadroom,Case((Facility_tpExpectedAverageOutstanding/Facility_tpLimit)*100,[<=80:0|>80:81]),0))
Facility_tpUGDPGO                             = &If(Facility_tpHeadroom,"UGD","PGO")
Facility_tpLEF                                = If(Facility_tpBorrower_tpPLorNPL=1,MatrixLookup("AAB_Parameters.xls","LEFfactors",&Facility_tpIDLEFfactors,10),MatrixLookup("AAB_Parameters.xls","LEFfactors",&Facility_tpIDLEFfactors,8))
Facility_tpUGD                                = If(Facility_tpHeadroom,If(Facility_tpBorrower_tpPLorNPL=1,MatrixLookup("AAB_Parameters.xls","LEFfactors",&Facility_tpIDLEFfactors,9),MatrixLookup("AAB_Parameters.xls","LEFfactors",&Facility_tpIDLEFfactors,7)),NA)
Facility_tpPGO                                = If(Facility_tpHeadroom=0,If(Facility_tpBorrower_tpPLorNPL=1,MatrixLookup("AAB_Parameters.xls","LEFfactors",&Facility_tpIDLEFfactors,9),MatrixLookup("AAB_Parameters.xls","LEFfactors",&Facility_tpIDLEFfactors,7)),NA)
Facility_tpMOCEAD                             = If(Facility_tpPrincipalLimit>75000,MatrixLookup("AAB_Parameters.xls","CalculationParameters","MOC_EAD_NPL",2),MatrixLookup("AAB_Parameters.xls","CalculationParameters","MOC_EAD_PL",2))
Facility_tpAF                                 = MatrixLookup("AAB_Parameters.xls","CalculationParameters","AggregationFactor",2)

Facility_tpECMultiplier                       = Facility_tpECMultiplierLowerBound+((Facility_tpECMultiplierUpperBound-Facility_tpECMultiplierLowerBound)*(OnER((Facility_tpRemainingAverageTenor+1-Facility_tpECMultiplierTenorLowerBound)/(Facility_tpECMultiplierTenorUpperBound-Facility_tpECMultiplierTenorLowerBound),0)))

Facility_tpECMultiplierGuarantor              = Facility_tpECMultiplierLowerBoundGuarantor+((Facility_tpECMultiplierUpperBoundGuarantor-Facility_tpECMultiplierLowerBoundGuarantor)*(OnER((Facility_tpRemainingAverageTenor+1-Facility_tpECMultiplierTenorLowerBound)/(Facility_tpECMultiplierTenorUpperBound-Facility_tpECMultiplierTenorLowerBound),0)))

;General interpolation => Lower EC + ((Upper EC - Lower EC) *( OnER (( Actual - Lower Tenor) / (Upper Tenor - Lower Tenor)),0)))

Facility_tpECMultiplierTenorLowerBound        = MatrixLookup("AAB_Parameters.xls","ECMultiplierTenorLowerBound",&If(Facility_tpRemainingAverageTenor<=1,1,If(Facility_tpRemainingAverageTenor+1>16,16,Facility_tpRemainingAverageTenor+1)),1)
Facility_tpECMultiplierTenorUpperBound        = MatrixLookup("AAB_Parameters.xls","ECMultiplierTenorUpperBound",&If(Facility_tpRemainingAverageTenor<=1,1,If(Facility_tpRemainingAverageTenor+1>16,16,Facility_tpRemainingAverageTenor+1)),1)

Facility_tpECMultiplierLowerBound             = MatrixLookup("AAB_Parameters.xls","ECMultiplier","@"&Borrower_tpRating,Facility_tpECMultiplierTenorLowerBound)
Facility_tpECMultiplierUpperBound             = MatrixLookup("AAB_Parameters.xls","ECMultiplier","@"&Borrower_tpRating,Facility_tpECMultiplierTenorUpperBound)

Facility_tpECMultiplierLowerBoundGuarantor    = MatrixLookup("AAB_Parameters.xls","ECMultiplier","@"&Facility_tpGuarantorRating,Facility_tpECMultiplierTenorLowerBound)
Facility_tpECMultiplierUpperBoundGuarantor    = MatrixLookup("AAB_Parameters.xls","ECMultiplier","@"&Facility_tpGuarantorRating,Facility_tpECMultiplierTenorUpperBound)

Facility_tpIELMoC                             = Facility_tpIELMoCUnguaranteed+Facility_tpIELMoCGuaranteed
Facility_tpIELMoCUnguaranteed                 = Facility_tpEADUnguaranteed*Facility_tpBorrower_tpPDMoC*Facility_tpLGDMoC*Facility_tpELMultiplierECUnguaranteed*Facility_tpDeannualize
Facility_tpIELMoCGuaranteed                   = OnEr(Facility_tpEADGuaranteed*Facility_tpJointPDMoC*Facility_tpLGDMoC*Facility_tpELMultiplierECGuaranteed*Facility_tpDeannualize,NA)

Facility_tpELMultiplierLowerM                 = Case(Facility_tpRemainingAverageTenor,[<1:0|<2:1|<3:2|<4:3|<5:4|<6:5|<7:6|<8:7|<9:8|<10:9|<11:10|<12:11|<13:12|<14:13|<15:14|15])
Facility_tpELMultiplierUpperM                 = Case(Facility_tpRemainingAverageTenor,[<1:1|<2:2|<3:3|<4:4|<5:5|<6:6|<7:7|<8:8|<9:9|<10:10|<11:11|<12:12|<13:13|<14:14|<15:15|15])

; --------------------- Internal Expected Loss Economic Capital Unguaranteed -------------------------------------------------------------------------------------
Facility_tpELMultiplierECUnguaranteed         = If(Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM>0,MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMECUnguaranteed,1)+((Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM)*(MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDUpperMECUnguaranteed,1)-MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMECUnguaranteed,1))),MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDECUnguaranteed,1))
; interpolated
Facility_tpELMultiplierIDLowerMECUnguaranteed = &"@"&Borrower_tpRating&"_"&Str((If(Facility_tpELMultiplierLowerM+1>16,16,Facility_tpELMultiplierLowerM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGDMoC,2)*100,0,0)
Facility_tpELMultiplierIDUpperMECUnguaranteed = &"@"&Borrower_tpRating&"_"&Str((If(Facility_tpELMultiplierUpperM+1>16,16,Facility_tpELMultiplierUpperM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGDMoC,2)*100,0,0)
Facility_tpELMultiplierIDECUnguaranteed       = &"@"&Borrower_tpRating&"_"&Str((If(Facility_tpRemainingAverageTenor+1>16,16,Facility_tpRemainingAverageTenor+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGDMoC,2)*100,0,0)

; --------------------- Internal Expected Loss Economic Capital Guaranteed ---------------------------------------------------------------------------------------
Facility_tpELMultiplierECGuaranteed           = If(Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM>0,MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMECGuaranteed,1)+((Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM)*(MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDUpperMECGuaranteed,1)-MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMECGuaranteed,1))),MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDECGuaranteed,1))
Facility_tpELMultiplierIDLowerMECGuaranteed   = &"@"&Facility_tpGuarantorRating&"_"&Str((If(Facility_tpELMultiplierLowerM+1>16,16,Facility_tpELMultiplierLowerM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGDMoC,2)*100,0,0)
Facility_tpELMultiplierIDUpperMECGuaranteed   = &"@"&Facility_tpGuarantorRating&"_"&Str((If(Facility_tpELMultiplierUpperM+1>16,16,Facility_tpELMultiplierUpperM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGDMoC,2)*100,0,0)
Facility_tpELMultiplierIDECGuaranteed         = &"@"&Facility_tpGuarantorRating&"_"&Str((If(Facility_tpRemainingAverageTenor+1>16,16,Facility_tpRemainingAverageTenor+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGDMoC,2)*100,0,0)

;--------------------- Joint PD ------------------------------------------------------------------------------------------------------------------
Facility_tpEquityIndexBorrower                = If(Borrower_tpAGICOrSBI=0,MatrixLookup("AAB_Parameters.xls","AGICMapping","@"&Borrower_tpAGIC,2),MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Borrower_tpSBI,2))
Facility_tpEquityIndexGuarantor               = If(Facility_tpGuarantorAGICOrSBI=0,MatrixLookup("AAB_Parameters.xls","AGICMapping","@"&Facility_tpGuarantorAGIC,2),MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Facility_tpGuarantorSBI,2))
Facility_tpIntraSectorCorrelationBorrower     = MatrixLookup("AAB_Parameters.xls","EquityIndex",Facility_tpEquityIndexBorrower,3)
Facility_tpIntraSectorCorrelationGuarantor    = MatrixLookup("AAB_Parameters.xls","EquityIndex",Facility_tpEquityIndexGuarantor,3)
Facility_tpEquityCorrelationID                = &Str(Facility_tpEquityIndexBorrower)&"_"&Str(Facility_tpEquityIndexGuarantor)
Facility_tpEquityCorrelation                  = MatrixLookup("AAB_Parameters.xls","EquityCorrelation",&Facility_tpEquityCorrelationID,1)
Facility_tpJointPDMoC                         = BivarNormal(InvNormal(Facility_tpBorrower_tpPDMoC),InvNormal(Facility_tpGuarantorPDMoC),(Facility_tpIntraSectorCorrelationBorrower*Facility_tpIntraSectorCorrelationGuarantor*Facility_tpEquityCorrelation))
Facility_tpInvNormalBorrower                  = InvNormal(Facility_tpBorrower_tpPDMoC)
Facility_tpInvNormalGuarantor                 = InvNormal(Facility_tpGuarantorPDMoC)


;=============================   $>Risk Adjusted Return - Income<$  ========================


.Variables

PI    0 1N     5       +       $>Risk Adjusted Return<$                                                                        \Facility_tpRiskAdjustedReturn
PI    0 1N     6       +       $>Risk Adjusted Return - Income<$                                                               \Facility_tpCreditIncome

.Formulas NoTrend
Facility_tpRiskAdjustedReturn             = OnEr(Facility_tpCreditIncome-Facility_tpOtherExpenses-Facility_tpInterestExpenses-Facility_tpTax,NA)
Facility_tpCreditIncome                   = Facility_tpInterestIncome+Facility_tpCreditRelatedFee


.Hints
Facility_tpCreditIncome                   = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year

;;----------------------------- Credit Related Fee Income -------------------------------------------------------------------------------------------------

.Variables
PI      1N     7               $>Risk Adjusted Return - Income - Credit Related Fee<$                                          \Facility_tpCreditRelatedFee
PI      1N     8               $>Risk Adjusted Return - Income - Credit Related Fee - Commitment Fee<$                         \Facility_tpCommitmentFee
PI      1N     8               $>Risk Adjusted Return - Income - Credit Related Fee - Annual Fee<$                             \Facility_tpAnnualFee
PP      1N     8               $>Annual Fee (Bp)<$                                                                             \Facility_tpAnnualFeeBp         ;; Titel aangepast voor compact report
PI      1N     8               $>Risk Adjusted Return - Income - Credit Related Fee - One Off Fee ()<$                        \Facility_tpOneOffFee
PI      1N     9               $>Risk Adjusted Return - Income - Credit Related Fee - One Off Fee Amount ()<$                 \Facility_tpOneOffFeeAmount      ;#User# moet die zelf invoeren
PI      1N     8               $>One Off Fee (Bp)<$                                                                            \Facility_tpOneOffFeeBp


PP      1N     8               $>Utilisation Fee<$                                                                             \Facility_tpUtilisationFee  ;; Titel aangepast voor Compact Report
PI    0 1N     9       -       $>Utilisation Fee (Bps)<$       				                                                         \Facility_tpUtilisationFeeBp ;; Titel aangepast voor Compact Report
PI    2 1N %   9       -       $>Utilisation Fee - utilization limit 1<$                                           			  	   \Facility_tpUtilisationFeeBpLimit1
PI    2 1N %   9       -       $>Utilisation Fee - utilization limit 2<$                                           			  	   \Facility_tpUtilisationFeeBpLimit2
PI    2 1N %   9       -       $>Utilisation Fee - utilization limit 3<$                                           			  	   \Facility_tpUtilisationFeeBpLimit3
PI    2 1N %   9       -       $>Utilisation Fee - utilization limit 4<$                                           			  	   \Facility_tpUtilisationFeeBpLimit4
PI    0 1N     9       -       $>Utilisation Fee - utilization limit 1 - Bps<$                                      				   \Facility_tpUtilisationFeeBpLimit1Bp
PI    0 1N     9       -       $>Utilisation Fee - utilization limit 2 - Bps<$                                      				   \Facility_tpUtilisationFeeBpLimit2Bp
PI    0 1N     9       -       $>Utilisation Fee - utilization limit 3 - Bps<$                                      				   \Facility_tpUtilisationFeeBpLimit3Bp
PI    0 1N     9       -       $>Utilisation Fee - utilization limit 4 - Bps<$                                      				   \Facility_tpUtilisationFeeBpLimit4Bp


.Formulas NoTrend
Facility_tpCreditRelatedFee               = OnER(Facility_tpCommitmentFee+Facility_tpUtilisationFee+Facility_tpAnnualFee+Facility_tpOneOffFee,NA)
Facility_tpCommitmentFee                  = Facility_tpCommitmentFeeBp*(Facility_tpLimit-Facility_tpExpectedAverageOutstanding)*0.0001*Facility_tpDeannualize
Facility_tpUtilisationFeeBpLimit1         = 0
Facility_tpUtilisationFeeBpLimit2         = 0.3333
Facility_tpUtilisationFeeBpLimit3         = 0.50
Facility_tpUtilisationFeeBpLimit4         = 0.6667
Facility_tpUtilisationFeeBpLimit1Bp       = 0
Facility_tpUtilisationFeeBpLimit2Bp       = 0
Facility_tpUtilisationFeeBpLimit3Bp       = 0
Facility_tpUtilisationFeeBpLimit4Bp       = 0
Facility_tpUtilisationFeeBp               = If((Facility_tpExpectedAverageOutstanding)/Facility_tpLimit<=0,0,If((Facility_tpExpectedAverageOutstanding)/Facility_tpLimit<=Facility_tpUtilisationFeeBpLimit1,0,If((Facility_tpExpectedAverageOutstanding)/Facility_tpLimit<=Facility_tpUtilisationFeeBpLimit2,Facility_tpUtilisationFeeBpLimit1Bp,If((Facility_tpExpectedAverageOutstanding)/Facility_tpLimit<=Facility_tpUtilisationFeeBpLimit3,Facility_tpUtilisationFeeBpLimit1Bp+Facility_tpUtilisationFeeBpLimit2Bp,If((Facility_tpExpectedAverageOutstanding)/Facility_tpLimit<=Facility_tpUtilisationFeeBpLimit4,Facility_tpUtilisationFeeBpLimit1Bp+Facility_tpUtilisationFeeBpLimit2Bp+Facility_tpUtilisationFeeBpLimit3Bp,Facility_tpUtilisationFeeBpLimit1Bp+Facility_tpUtilisationFeeBpLimit2Bp+Facility_tpUtilisationFeeBpLimit3Bp+Facility_tpUtilisationFeeBpLimit4Bp)))))
Facility_tpUtilisationFee                 = If(Facility_tpRevolvingProduct,Facility_tpUtilisationFeeBp*Facility_tpExpectedAverageOutstanding*0.0001,0)*Facility_tpDeannualize
Facility_tpAnnualFee                      = OnER(If(&Facility_tpType="F1",Facility_tpCreditFeeBp/10000*Facility_tpExpectedAverageOutstanding,NA),NA)
Facility_tpAnnualFeeBp                    = Facility_tpAnnualFee/Facility_tpExpectedAverageOutstanding
Facility_tpOneOffFee                      = If(Facility_tpOriginalTenorYears<=1,Facility_tpOneOffFeeAmount,If(Facility_tpOriginalTenorYears<=5,Facility_tpOneOffFeeAmount/Facility_tpOriginalTenorYears,Facility_tpOneOffFeeAmount/5))
; In de US staat dat we de Weighted Average Tenor moeten gebruiken, maar die is uitgedrukt in maanden en niet in jaren
Facility_tpOneOffFeeAmount                = Facility_tpOneOffFeeAmount2
Facility_tpOneOffFeeBp                    = (Facility_tpOneOffFee/Facility_tpEAD)*10000


.Hints
Facility_tpCommitmentFee                  = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year
Facility_tpUtilisationFee                 = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year
Facility_tpOneOffFee                      = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year


;;-------------- Interest Income -----------------------------------------------------------------------------------------------------------------------------------
.Variables
PI      1N     7               $>Risk Adjusted Return - Income - Interest Income<$                                              \Facility_tpInterestIncome
PI    0 1N     8               $>Customer Spread (Bp)<$                                                                         \Facility_tpCustomerSpread                  ;; Titel aangepast voor Compact Report
PI    0 1N     8               $>Risk Adjusted Return - Income - Interest Income - Customer Spread Additional Margin (Bps)<$    \Facility_tpCustomerSpreadAddMargin

;============================  Variabelen ten behoeve van rapportage ===========================================================================

PI    0 1N     7               $>Commercial Margin (Bp)<$                                                                       \Facility_tpCommercialMargin           ;; Toegevoegd ten behoeve van compact report
PI    0 1N     7       +       $>Option Costs/Ind. Liq. Costs<$                                                                 \Facility_tpOptionCostsIndLiqPrem      ;; Toegevoegd ten behoeve van compact report


.Formulas NoTrend
Facility_tpInterestIncome			  = (((Facility_tpCustomerSpread+Facility_tpCustomerSpreadAddMargin)*Facility_tpExpectedAverageOutstanding)/10000)*Facility_tpDeannualize
Facility_tpCustomerSpread             = If(TargetRaRoRaCDriven, Round(Facility_tpRequiredInterestMarginBps,1), Facility_tpCustomerSpread2)
; When Force delivers a interest spread given by the user, this value will be used for the income calculation, else, the customer spread based on the target rarorac will be used. 
Facility_tpCustomerSpreadAddMargin    = MatrixLookup("AAB_Parameters.xls","CustomerSpreadAddMargin",&Facility_tpProductinterestDetailsInterestProductName,1)
Facility_tpCommercialMargin           = Facility_tpCustomerSpread-Facility_tpLiquiditySpreadBps
Facility_tpOptionCostsIndLiqPrem      = Facility_tpIndirectLiquidityCosts+Facility_tpPipelineRisk+Facility_tpPrepaymentCosts

.Hints
Facility_tpInterestIncome             = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year


;============================   $>Risk Adjusted Return - Other Expenses<$  ========================

.Variables
PI    0 1N     6       +       $>Risk Adjusted Return - Other Expenses<$                                                       \Facility_tpOtherExpenses
PI      1N     7               $>Risk Adjusted Return - Other Expenses - Internal Expected Loss<$                              \Facility_tpInternalExpectedLoss
PI    9 1N     8               $>Risk Adjusted Return - Other Expenses - Internal Expected Loss - Unguaranteed<$               \Facility_tpInternalExpectedLossUnguaranteed
PI      1N     9               $>Expected Loss Multiplier - Risk Adjusted Return - Unguaranteed<$                              \Facility_tpELMultiplierRARUnguaranteed
PI      1A     9               $>Expected Loss Multiplier ID - Risk Adjusted Return - Unguaranteed<$                           \Facility_tpELMultiplierIDRARUnguaranteed
PI      1A     9               $>Expected Loss Multiplier ID - Risk Adjusted Return - Unguaranteed - Lower M<$                 \Facility_tpELMultiplierIDLowerMRARUnguaranteed
PI      1A     9               $>Expected Loss Multiplier ID - Risk Adjusted Return - Unguaranteed - Upper M<$                 \Facility_tpELMultiplierIDUpperMRARUnguaranteed
PI      1N     8               $>Risk Adjusted Return - Other Expenses - Internal Expected Loss - Guaranteed<$                 \Facility_tpInternalExpectedLossGuaranteed
PI      1N     9               $>Expected Loss Multiplier - Risk Adjusted Return - Guaranteed<$                                \Facility_tpELMultiplierRARGuaranteed
PI      1A     9               $>Expected Loss Multiplier ID - Risk Adjusted Return - Guaranteed<$                             \Facility_tpELMultiplierIDRARGuaranteed
PI      1A     9               $>Expected Loss Multiplier ID - Risk Adjusted Return - Guaranteed - Lower M<$                   \Facility_tpELMultiplierIDLowerMRARGuaranteed
PI      1A     9               $>Expected Loss Multiplier ID - Risk Adjusted Return - Guaranteed - Upper M<$                   \Facility_tpELMultiplierIDUpperMRARGuaranteed
PI      1N     9               $>Joint PD<$                                                                                    \Facility_tpJointPD
;PI      1N     8              $>Risk Adjusted Return - Other Expenses - Internal Expected Loss - Exposure at Default<$         \Facility_tpEAD
;C is een verwijzing naar H4 -- Credit risk

.Formulas NoTrend
Facility_tpOtherExpenses                       = Facility_tpInternalExpectedLoss+Facility_tpOperationalCosts
Facility_tpInternalExpectedLoss                = (Facility_tpInternalExpectedLossUnguaranteed+Facility_tpInternalExpectedLossGuaranteed)*Facility_tpDeannualize
Facility_tpJointPD                             = BivarNormal(InvNormal(Facility_tpBorrower_tpPD),InvNormal(Facility_tpGuarantorPD),(Facility_tpIntraSectorCorrelationBorrower*Facility_tpIntraSectorCorrelationGuarantor*Facility_tpEquityCorrelation))

;;-------------------------- Internal Expected Loss RAR Unguaranteed --------------------------------------------------------------------------------------------
Facility_tpInternalExpectedLossUnguaranteed    = Facility_tpEADUnguaranteed*Facility_tpBorrower_tpPD*Facility_tpLGD*Facility_tpELMultiplierRARUnguaranteed
Facility_tpELMultiplierRARUnguaranteed         = If(Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM>0,MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMRARUnguaranteed,1)+((Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM)*(MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDUpperMRARUnguaranteed,1)-MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMRARUnguaranteed,1))),MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDRARUnguaranteed,1))
Facility_tpELMultiplierIDRARUnguaranteed       = &"@"&Borrower_tpRating&"_"&Str((If(Facility_tpRemainingAverageTenor+1>16,16,Facility_tpRemainingAverageTenor+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGD,2)*100,0,0)
Facility_tpELMultiplierIDLowerMRARUnguaranteed = &"@"&Borrower_tpRating&"_"&Str((If(Facility_tpELMultiplierLowerM+1>16,16,Facility_tpELMultiplierLowerM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGD,2)*100,0,0)
Facility_tpELMultiplierIDUpperMRARUnguaranteed = &"@"&Borrower_tpRating&"_"&Str((If(Facility_tpELMultiplierUpperM+1>16,16,Facility_tpELMultiplierUpperM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGD,2)*100,0,0)

;;------------------------------- Internal Expected Loss Guaranteed ---------------------------------------------------------------------------------------------
Facility_tpInternalExpectedLossGuaranteed      = Facility_tpEADGuaranteed*Facility_tpJointPD*Facility_tpLGD*Facility_tpELMultiplierRARGuaranteed
Facility_tpELMultiplierRARGuaranteed           = If(Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM>0,MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMRARGuaranteed,1)+((Facility_tpRemainingAverageTenor-Facility_tpELMultiplierLowerM)*(MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDUpperMRARGuaranteed,1)-MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDLowerMRARGuaranteed,1))),MatrixLookup("AAB_Parameters_ELMultiplier.xls","ELMultiplier",&Facility_tpELMultiplierIDRARGuaranteed,1))
Facility_tpELMultiplierIDRARGuaranteed         = &"@"&Facility_tpGuarantorRating&"_"&Str((If(Facility_tpRemainingAverageTenor+1>16,16,Facility_tpRemainingAverageTenor+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGD,2)*100,0,0)
Facility_tpELMultiplierIDLowerMRARGuaranteed   = &"@"&Facility_tpGuarantorRating&"_"&Str((If(Facility_tpELMultiplierLowerM+1>16,16,Facility_tpELMultiplierLowerM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGD,2)*100,0,0)
Facility_tpELMultiplierIDUpperMRARGuaranteed   = &"@"&Facility_tpGuarantorRating&"_"&Str((If(Facility_tpELMultiplierUpperM+1>16,16,Facility_tpELMultiplierUpperM+1)),0,0)&"_"&Str(RoundUp(Facility_tpLGD,2)*100,0,0)

.Hints
Facility_tpInternalExpectedLoss                = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year

;------------------------ Operational Costs ------------------------------------------------------------------------------------------------------------------
.Variables

PI      1N     7               $>Risk Adjusted Return - Other Expenses - Operational Costs<$                                                             \Facility_tpOperationalCosts
PI      1N     8               $>Risk Adjusted Return - Other Expenses - Operational Costs - Cost per Contract<$               					             		 \Facility_tpCostPerContract
PI      1A     9               $>Risk Adjusted Return - Other Expenses - Operational Costs - Cost per Contract ID<$               					           	 \Facility_tpCostPerContractID
PI      1N     8               $>Risk Adjusted Return - Other Expenses - Operational Costs - Cost over Volume<$                		 			             		 \Facility_tpCostOverVolume
PI    2 1N     9               $>Risk Adjusted Return - Other Expenses - Operational Costs - Cost over Volume (Bps)<$							                   		 \Facility_tpCostOverVolumeBp
PI      1N     8               $>Risk Adjusted Return - Other Expenses - Operational Costs - Cost per Service Concept<$                                  \Facility_tpCostPerServiceConcept
PI    2 1N %   9               $>Risk Adjusted Return - Other Expenses - Operational Costs - Cost per Service Concept - Percentage Operating Concept<$   \Facility_tpPercentageOperatingConcept

.Formulas NoTrend
Facility_tpOperationalCosts				    	= Facility_tpCostOverVolume+Facility_tpCostPerServiceConcept+Facility_tpCostPerContract
Facility_tpCostOverVolume				      	= Facility_tpExpectedAverageOutstanding*(Facility_tpCostOverVolumeBp/10000)*Facility_tpDeannualize
Facility_tpCostOverVolumeBp				    	= MatrixLookup("AAB_Parameters.xls","CostOverVolume",&Facility_tpType&"_"&Borrower_tpClientGroup,3)
Facility_tpPercentageOperatingConcept   = AgreementPercentageOperatingConcept
Facility_tpCostPerServiceConcept     	  = If(Borrower_tpSumExpectedAverageOutstanding=0,(Borrower_tpFixedCostOperatingConcept*Facility_tpPercentageOperatingConcept)/Borrower_tpNrOfFacilities,((Borrower_tpFixedCostOperatingConcept*Facility_tpPercentageOperatingConcept)/Borrower_tpSumExpectedAverageOutstanding)*Facility_tpExpectedAverageOutstanding)
;;Correctie voor tenor onder de 12 maanden: If(Borrower_tpSumExpectedAverageOutstanding=0,(Borrower_tpFixedCostOperatingConcept*Facility_tpPercentageOperatingConcept)/Borrower_tpNrOfFacilities,(((Borrower_tpFixedCostOperatingConcept*Facility_tpPercentageOperatingConcept)/Borrower_tpSumExpectedAverageOutstanding)*Facility_tpExpectedAverageOutstanding)/AgreementMaxRemainingTenor))
Facility_tpCostPerContract				    	= MatrixLookup("AAB_Parameters.xls","CostPerContract",&Facility_tpCostPerContractID,5)*Facility_tpDeannualize
Facility_tpCostPerContractID            = &Facility_tpType&"_"&Borrower_tpRating&"_"&Borrower_tpClientGroup

.Hints
Facility_tpCostOverVolume               = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year
Facility_tpCostPerContract              = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year

;------------------------ Tax ----------------------------------------------------------------------------------------------------------------------------------
.Variables
PI      1N     7               $>Risk Adjusted Return - Other Expenses - Tax<$                                                    	\Facility_tpTax


.Formulas NoTrend
Facility_tpTax								  = OnER((Facility_tpCreditIncome-Facility_tpInternalExpectedLoss-Facility_tpOperationalCosts-Facility_tpInterestExpenses)*Borrower_tpTaxRate,NA)



;=============================   $>Risk Adjusted Return - Interest Expenses<$  ==================================================================================


.Variables
PI      1N     6               $>Risk Adjusted Return - Interest Expenses<$                                                         \Facility_tpInterestExpenses
PI      1N     7               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing<$                                \Facility_tpFundsTransferPricing
PI      1N     8       -       $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Base Rate (Bps)<$              \Facility_tpBaseRate
PI      1N     8               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Direct Liquidity Premium<$     \Facility_tpDirectLiquidityPremium
PI    2 1N     9       -       $>Liquidity Spread (Bp) <$                                                                           \Facility_tpLiquiditySpreadBps                ;; Titel aangepast voor Compact Report
PI    2 1N     9       -       $>Liquidity Spread (Bp) Under 1 Year<$                                                               \Facility_tpLiquiditySpreadBpsUnder1year
PI    2 1N     9       -       $>Liquidity Spread (Bp) On Weighted Funding Amount<$                                                 \Facility_tpLiquiditySpreadBpsGeneral
PI    2 1N     9       -       $>Repayment Frequency for liquidity spread calc<$                                                    \Facility_tpRepaymentFrequencyLiqSpread
PI    2 1N     9       -       $>Convert X to months for scheme withdrawal and repayment<$                                          \Facility_tpConvertToMonths
PI    2 1N     9       -       $>Grace period expressed in periods (rounded up)<$                                                   \Facility_tpGracePeriodInPeriods
PI    2 1N     9       -       $>Weighted Funding Repayment Bullet<$                                                                \Facility_tpWeightedFundingRepaymentBullet
PI    2 1N     9       -       $>Liquidity Spread Repayment Bullet<$                                                                \Facility_tpLiquiditySpreadRepaymentBullet
PI    2 1N     9       -       $>Weighted Funding Repayment Linear<$                                                                \Facility_tpWeightedFundingRepaymentLinear
PI    2 1N     9       -       $>Liquidity Spread Repayment Linear<$                                                                \Facility_tpLiquiditySpreadRepaymentLinear
PI    2 1N     9       -       $>Weighted Funding Repayment Annuity<$                                                               \Facility_tpWeightedFundingRepaymentAnnuity
PI    2 1N     9       -       $>Liquidity Spread Repayment Annuity<$                                                               \Facility_tpLiquiditySpreadRepaymentAnnuity
PI    2 1N     9       -       $>Weighted Funding Repayment Scheme<$                                                                \Facility_tpWeightedFundingRepaymentScheme
PI    2 1N     9       -       $>Liquidity Spread Repayment Scheme<$                                                                \Facility_tpLiquiditySpreadRepaymentScheme
PI    2 1N     9       -       $>Weighted Funding Withdrawal Scheme<$                                                               \Facility_tpWeightedFundingWithdrawalScheme
PI    2 1N     9       -       $>Liquidity Spread Withdrawal Scheme<$                                                               \Facility_tpLiquiditySpreadWithdrawalScheme
PI    2 1N     9       -       $>Liquidity Spread Withdrawal Scheme<$                                                               \Facility_tpLiquiditySpreadRevolvingCredit

PI      1N     8               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Prepayment Costs<$             \Facility_tpPrepaymentCosts
PI    3 1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Prepayment Premium (Bps)<$     \Facility_tpPrepaymentPremium
;PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Prepayment (%)<$               \=Facility_tpPrepaymentPrec
;PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Principal Limit (%)<$          \=Facility_tpPrincipalLimit

PI      1N     8               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Pipeline Risk<$                \Facility_tpPipelineRisk
PI    6 1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Offer Option Premium (Bps)<$   \Facility_tpOfferOptionPremium
PI    2 1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Lower M<$                      \Facility_tpPipelineRiskLowerM
PI    2 1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Upper M<$                      \Facility_tpPipelineRiskUpperM
PI    6 1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Lower Premium (Bps)<$          \Facility_tpPipelineRiskLowerPremium
PI    6 1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Upper Premium (Bps)<$          \Facility_tpPipelineRiskUpperPremium
PI      1A     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Upper Premium ID <$            \Facility_tpPipelineRiskUpperPremiumID


;PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Funds Transfer Pricing - Principal Limit (%)<$          \=Facility_tpPrincipalLimit

.Formulas NoTrend
Facility_tpInterestExpenses              = Facility_tpFundsTransferPricing+Facility_tpIndirectLiquidityCosts+Facility_tpSubordinatedDebtCapitalCharge-Facility_tpEquityFundingAdjustment
Facility_tpFundsTransferPricing          = Facility_tpDirectLiquidityPremium+Facility_tpPrepaymentCosts+Facility_tpPipelineRisk
Facility_tpBaseRate                      = Facility_tpBaseRate2
Facility_tpDirectLiquidityPremium        = If(MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,4)=0,0,(Facility_tpExpectedAverageOutstanding*Facility_tpLiquiditySpreadBps)/10000)

Facility_tpPrepaymentCosts               = ((Facility_tpPrepaymentPremium*Facility_tpPrepaymentPrec*Facility_tpPrincipalLimit)/10000)*Facility_tpDeannualize
Facility_tpPrepaymentPremium             = MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,1)

Facility_tpPipelineRisk                  = ((Facility_tpOfferOptionPremium*Facility_tpPrincipalLimit)/10000)*Facility_tpDeannualize

Facility_tpOfferOptionPremium            =  If((Facility_tpPipelineRiskUpperM-Facility_tpPipelineRiskLowerM)=0,Facility_tpPipelineRiskLowerPremium,Facility_tpPipelineRiskLowerPremium +((Facility_tpPipelineRiskUpperPremium-Facility_tpPipelineRiskLowerPremium)*((Facility_tpRemainingAverageTenor-Facility_tpPipelineRiskLowerM)/(Facility_tpPipelineRiskUpperM-Facility_tpPipelineRiskLowerM))))

Facility_tpPipelineRiskLowerM            = Case(Facility_tpRemainingAverageTenor,[<1:0|<2:1|<3:2|<5:3|<10:5|<50:10|50])
Facility_tpPipelineRiskUpperM            = Case(Facility_tpRemainingAverageTenor,[<1:1|<2:2|<3:3|<5:5|<10:10|<50:50|50])
Facility_tpPipelineRiskLowerPremium      = MatrixLookup("AAB_Parameters.xls","OfferOptionPremium",&Facility_tpOfferPeriod&"_"&Str(Facility_tpPipelineRiskLowerM,0,0),5)
Facility_tpPipelineRiskUpperPremium      = MatrixLookup("AAB_Parameters.xls","OfferOptionPremium",&Facility_tpOfferPeriod&"_"&Str(Facility_tpPipelineRiskUpperM,0,0),5)
Facility_tpPipelineRiskUpperPremiumID    = &Facility_tpOfferPeriod&"_"&Str(Facility_tpPipelineRiskUpperM,0,0)

.Hints
Facility_tpDirectLiquidityPremium        = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year
Facility_tpPrepaymentCosts               = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year
Facility_tpPipelineRisk                  = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year

.Variables
PI      1N     7               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs<$                         \Facility_tpIndirectLiquidityCosts

PP      1X     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs - General<$               \Facility_tpIndirectLiquidityCostsGeneral
PI    0 1N     9               $>Risk Adjusted Return - Interest Expenses - Buffer Cost Per Year BP<$                          \Facility_tpBufferCostPerYearBP
PI      1N C   9               $>Risk Adjusted Return - Interest Expenses - Financial Institution<$                            \Facility_tpFI
PI      1N C   9               $>Risk Adjusted Return - Interest Expenses - Can be redrawn<$                                   \Facility_tpRedrawable
PI      1N C   9               $>Risk Adjusted Return - Interest Expenses - 31dg Debet<$                                       \Facility_tp31DgDebet2
PI      1N C   9               $>Risk Adjusted Return - Interest Expenses - Combined<$                                         \Facility_tpCombined
PI      1N C   9               $>Risk Adjusted Return - Interest Expenses - Uncommitted<$                                      \Facility_tpUncommitted
PI      1A     9               $>Risk Adjusted Return - Interest Expenses - Credit or liquidity facility<$                     \Facility_tpCreditOrLiquidity


.Choices
Facility_tpFI                  = "1:Yes|0:No"
Facility_tpUncommitted         = "1:Yes|0:No"
Facility_tpRedrawable          = "1:Yes|0:No"
Facility_tpCombined            = "1:Yes|0:No"
Facility_tp31DgDebet2          = "1:Yes|0:No"



.Formulas NoTrend
Facility_tpIndirectLiquidityCosts            = (Facility_tpIndirectLiquidityCostsFI+Facility_tpIndirectLiquidityCostsComRe+Facility_tpIndirectLiquidityCostsUncomRe+Facility_tpIndirectLiquidityCostsComCom+Facility_tpIndirectLiquidityCostsUncomCom+Facility_tpIndirectLiquidityCostsNotRe+Facility_tpIndirectLiquidityCostsCom31dt+Facility_tpIndirectLiquidityCostsUncom31dt)*Facility_tpDeannualize
Facility_tpOriginalLimit                     = Facility_tpPrincipalLimit
Facility_tpBufferCostPerYearBP               = MatrixLookup("AAB_Parameters.xls","CalculationParameters","BUFFERCOSTPERJAARBP",2)
Facility_tpFI                                = If(Borrower_tpAGICOrSBI=0,MatrixLookup("AAB_Parameters.xls","AGICMapping","@"&Borrower_tpAGIC,3),MatrixLookup("AAB_Parameters.xls","SBIMapping","@"&Borrower_tpSBI,3))
Facility_tpUncommitted                       = Facility_tpUncommitted2
Facility_tpRedrawable                        = MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,5)
Facility_tp31DgDebet2                        = Facility_tp31DgDebet
Facility_tpCombined                          = MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,2)
Facility_tpCreditOrLiquidity                 = &MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,3)

.Hints
Facility_tpIndirectLiquidityCosts            = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year

.Variables
; Knock out 1: FI Y/N
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Financial Institution<$      \Facility_tpIndirectLiquidityCostsFI
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow FI<$                                           \Facility_tpOutflowFI

.Formulas NoTrend
Facility_tpIndirectLiquidityCostsFI          = If(Facility_tpFI,(Facility_tpOriginalLimit-Facility_tpExpectedAverageOutstanding)*Facility_tpOutflowFI*(Facility_tpBufferCostPerYearBP/10000),NA)
Facility_tpOutflowFI                         = MatrixLookup("AAB_Parameters.xls","OutflowPercFinancialInstitutions",&Borrower_tpFinancialInstitution&"_"&Facility_tpCreditOrLiquidity,3)

; Knock out 2: Redrawble Y/N
.Variables
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Committed + re-drawn<$       \Facility_tpIndirectLiquidityCostsComRe
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow Percentage Committed and Redrawable<$          \Facility_tpOutflowCommittedRedraw
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Uncomitted + re-drawn<$      \Facility_tpIndirectLiquidityCostsUncomRe
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow Percentage Uncommitted and Redrawable<$        \Facility_tpOutflowUncommittedRedraw

.Formulas NoTrend
Facility_tpIndirectLiquidityCostsComRe       =If((Facility_tpFI=0) And (Facility_tpRedrawable=1) And (Facility_tp31DgDebet=0) And (Facility_tpCombined=0) And (Facility_tpUncommitted=0),(Facility_tpOriginalLimit-Facility_tpExpectedAverageOutstanding)*Facility_tpOutflowCommittedRedraw*(Facility_tpBufferCostPerYearBP/10000),NA)
Facility_tpOutflowCommittedRedraw            = MatrixLookup("AAB_Parameters.xls","OutflowPercCommitted",&Borrower_tpClientGroup,2)

Facility_tpIndirectLiquidityCostsUncomRe     =If((Facility_tpFI=0) And (Facility_tpRedrawable=1) And (Facility_tp31DgDebet=0) And (Facility_tpCombined=0) And (Facility_tpUncommitted=1),(Facility_tpOriginalLimit-Facility_tpExpectedAverageOutstanding)*Facility_tpOutflowUncommittedRedraw*(Facility_tpBufferCostPerYearBP/10000),NA)
Facility_tpOutflowUncommittedRedraw          = MatrixLookup("AAB_Parameters.xls","OutflowPercUncommitted",&Borrower_tpClientGroup,1)

; Knock out 3: 31 dt Y/N
.Variables
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Committed +31dt<$           \Facility_tpIndirectLiquidityCostsCom31dt
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow Percentage Committed and 31 Dgn<$             \Facility_tpOutflowCommitted31Dgn
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Uncomitted + 31 dt<$        \Facility_tpIndirectLiquidityCostsUncom31dt
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow Percentage Uncommitted and 31 Dgn<$           \Facility_tpOutflowUncommitted31Dgn

.Formulas NoTrend
Facility_tpIndirectLiquidityCostsCom31dt       =If((Facility_tpFI=0) And (Facility_tpRedrawable=0) And (Facility_tp31DgDebet=1) And (Facility_tpCombined=0) And (Facility_tpUncommitted=0),(Facility_tpOriginalLimit-Facility_tpExpectedAverageOutstanding)*Facility_tpOutflowCommitted31Dgn*(Facility_tpBufferCostPerYearBP/10000),NA)
Facility_tpOutflowCommitted31Dgn             = MatrixLookup("AAB_Parameters.xls","OutflowPercCommitted",&Borrower_tpClientGroup,4)

Facility_tpIndirectLiquidityCostsUncom31dt     =If((Facility_tpFI=0) And (Facility_tpRedrawable=0) And (Facility_tp31DgDebet=1) And (Facility_tpCombined=0) And (Facility_tpUncommitted=1),(Facility_tpOriginalLimit-Facility_tpExpectedAverageOutstanding)*Facility_tpOutflowUncommitted31Dgn*(Facility_tpBufferCostPerYearBP/10000),NA)
Facility_tpOutflowUncommitted31Dgn           = MatrixLookup("AAB_Parameters.xls","OutflowPercUncommitted",&Borrower_tpClientGroup,3)


; Knock out 4: Combined Y/N
.Variables
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Committed + combined<$      \Facility_tpIndirectLiquidityCostsComCom
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow Percentage Committed and Combined Product<$   \Facility_tpOutflowCommittedCombined

PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Uncomitted + combined<$     \Facility_tpIndirectLiquidityCostsUncomCom
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow Percentage Uncommitted and Combined<$         \Facility_tpOutflowUncommittedCombined

.Formulas NoTrend
Facility_tpIndirectLiquidityCostsComCom      =If((Facility_tpFI=0) And (Facility_tpRedrawable=0) And (Facility_tp31DgDebet=0) And (Facility_tpCombined=1) And (Facility_tpUncommitted=0),(Facility_tpOriginalLimit-Facility_tpExpectedAverageOutstanding)*Facility_tpOutflowCommittedCombined*(Facility_tpBufferCostPerYearBP/10000),NA)
Facility_tpOutflowCommittedCombined          = MatrixLookup("AAB_Parameters.xls","OutflowPercCommitted",&Borrower_tpClientGroup,3)

; lange formule 9.2.2.5
Facility_tpIndirectLiquidityCostsUncomCom    =If((Facility_tpFI=0) And (Facility_tpRedrawable=0) And (Facility_tp31DgDebet=0) And (Facility_tpCombined=1) And (Facility_tpUncommitted=1),Facility_tpTermLoanYearlyIndirectLiqCosts,NA)
Facility_tpOutflowUncommittedCombined        = MatrixLookup("AAB_Parameters.xls","OutflowPercUncommitted",&Borrower_tpClientGroup,2)

; Knock out 5: Not redrawble
.Variables
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs- Not redrawable<$            \Facility_tpIndirectLiquidityCostsNotRe
PI    2 1N %   9               $>Risk Adjusted Return - Interest Expenses - Outflow Percentage Committed and Nonredrawable<$      \Facility_tpOutflowCommittedNotRedraw


.Formulas NoTrend
; lange formule 9.2.2.8
Facility_tpIndirectLiquidityCostsNotRe       =If((Facility_tpFI=0) And (Facility_tpRedrawable=0) And (Facility_tp31DgDebet=0) And (Facility_tpCombined=0),Facility_tpTermLoanYearlyIndirectLiqCosts,NA)
Facility_tpOutflowCommittedNotRedraw         = MatrixLookup("AAB_Parameters.xls","OutflowPercCommitted",&Borrower_tpClientGroup,1)


.Variables
PP      1N     8               $>Risk Adjusted Return - Interest Expenses - Indirect Liquidity Costs - Uitgebreide calc<$      \Facility_tpIndirectLiquidityCostsExtended

PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Absolute Buffer Cost ()<$                         \Facility_tpAbsoluteBufferCosts
PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Yearly Indirect Liq. Costs (Bps)<$                 \Facility_tpYearlyIndirectLiqCosts
PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Yearly Indirect Liq. Costs (Bps) Bullet<$          \Facility_tpYearlyIndirectLiqCostsBullet
PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Yearly Indirect Liq. Costs (Bps) Lin/Annuity<$     \Facility_tpYearlyIndirectLiqCostsLinearAnnuity
PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Yearly Indirect Liq. Costs (Bps) Scheme<$          \Facility_tpYearlyIndirectLiqCostsScheme
PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Term Loan Yearly Indirect Liq. Costs ()<$         \Facility_tpTermLoanYearlyIndirectLiqCosts

PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Original Limit ()<$                               \Facility_tpOriginalLimit
;PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Original Loan Maturity (Months)<$                  \Facility_tpOriginalTenor                 ; #Force# uit force??
;PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Original Loan Maturity (Years)<$                   \Facility_tpOriginalLoanMaturityYears      ; #Force# moet uitgerekend worden obv gegevens uit Force
PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Weighted Limited Outstanding<$                     \Facility_tpWeightedLimitOutstanding       ; #Repayment Scheme# Moet nog uitgerekend worden met aflossingsschema
; Additional question AABP-1523 - 11-10-2015 - Replaced by Expected Average Outstanding
;PI      1N     9               $>Risk Adjusted Return - Interest Expenses - Remaining Loan Maturity (Years)<$                  \Facility_tpRemainingLoanMaturity          ; #Force# moet uitgerekend worden obv gegevens uit Force




.Formulas NoTrend

;9.2.2.5 en 9.2.2.8

;Step 1
Facility_tpAbsoluteBufferCosts  = (Facility_tpOriginalLimit*(If((Facility_tpFI=0) And (Facility_tpRedrawable=0) And (Facility_tp31DgDebet=0) And (Facility_tpCombined=1) And (Facility_tpUncommitted=1),Facility_tpOutflowUncommittedCombined,Facility_tpOutflowCommittedNotRedraw))*(Facility_tpBufferCostPerYearBP/10000))/12

;Step 2
Facility_tpYearlyIndirectLiqCosts = Round(If(&Facility_tpProductredemptionDetailsRedemptionType="InterestOnly",Facility_tpYearlyIndirectLiqCostsBullet,If((&Facility_tpProductredemptionDetailsRedemptionType="Linear") Or (&Facility_tpProductredemptionDetailsRedemptionType="Annuity"),Facility_tpYearlyIndirectLiqCostsLinearAnnuity,If(&Facility_tpProductredemptionDetailsRedemptionType="IrregularRepaymentSchedule",Facility_tpYearlyIndirectLiqCostsScheme,NA))),0)

;Bullet
Facility_tpYearlyIndirectLiqCostsBullet    = If(&Facility_tpProductredemptionDetailsRedemptionType="InterestOnly",((Facility_tpAbsoluteBufferCosts/Facility_tpOriginalTenorYears)/Facility_tpOriginalLimit)*10000,NA)
;Linear or Annuity
Facility_tpYearlyIndirectLiqCostsLinearAnnuity  = If((&Facility_tpProductredemptionDetailsRedemptionType="Linear") Or (&Facility_tpProductredemptionDetailsRedemptionType="Annuity"),(Facility_tpAbsoluteBufferCosts*10000)/((((Facility_tpOriginalTenor)*Facility_tpOriginalLimit)/12)-((0.5*((Facility_tpOriginalTenor-Facility_tpGracePeriod)/12)*(Facility_tpOriginalLimit-Facility_tpBalloon)))),NA)
;Scheme
Facility_tpYearlyIndirectLiqCostsScheme  = If(&Facility_tpProductredemptionDetailsRedemptionType="IrregularRepaymentSchedule",(Facility_tpAbsoluteBufferCosts/Facility_tpWeightedLimitOutstanding)*10000,NA)


;Step 3
Facility_tpTermLoanYearlyIndirectLiqCosts =If(Facility_tpOriginalTenor>12,Facility_tpYearlyIndirectLiqCosts*0.0001*Facility_tpExpectedAverageOutstanding,Facility_tpYearlyIndirectLiqCosts*0.0001*Facility_tpExpectedAverageOutstanding*(Facility_tpOriginalTenor/12))

;Needs to be discussed with SPW 06112015
Facility_tpWeightedLimitOutstanding = Facility_tpPrincipalLimit


.Variables
PI      1N     7               $>Risk Adjusted Return - Interest Expenses - Subordinated Debt Capital Charge<$                                  \Facility_tpSubordinatedDebtCapitalCharge
PI      1N %   8               $>Risk Adjusted Return - Interest Expenses - Subordinated Debt Capital Charge - Subordinated Debt Ratio (%)<$    \Facility_tpSubDebtRatio
PI      1N     8       -       $>Risk Adjusted Return - Interest Expenses - Subordinated Debt Capital Charge - Cost of Subordination (Bps)<$    \Facility_tpCostOfSubordination

.Formulas NoTrend
Facility_tpSubordinatedDebtCapitalCharge    = OnER(Facility_tpRWA*Facility_tpSubDebtRatio*(Facility_tpCostOfSubordination/10000)*Facility_tpDeannualize,NA)
Facility_tpSubDebtRatio                     = AgreementSubDebtRatio
Facility_tpCostOfSubordination              = AgreementCostOfSubordination

.Hints
Facility_tpSubordinatedDebtCapitalCharge    = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year

.Variables
PI      1N     7               $>Risk Adjusted Return - Interest Expenses - Equity Funding Adjustment<$                                         \Facility_tpEquityFundingAdjustment
;PI      1N     8               $>Risk Adjusted Return - Interest Expenses - Equity Funding Adjustment - Equity Ratio<$                         \Borrower_tpEquityRatio
;C wordt ook gebruikt in Equity Capital Charge
PI      1N     8       -       $>Risk Adjusted Return - Interest Expenses - Equity Funding Adjustment - Adjustment Rate<$                       \Facility_tpEquityFundingAdjustmentRate
PI      1N C   9               $>Risk Adjusted Return - Interest Expenses - Equity Funding Adjustment - Interest Rate Index Basis<$             \Facility_tpInterestRateIndexBasis


.Choices
Facility_tpInterestRateIndexBasis = "1:Yes|0:No"

.Formulas NoTrend
Facility_tpEquityFundingAdjustment       = OnER((Facility_tpRWA*Borrower_tpEquityRatio-AgreementAvailableAmountOfEquity)*(Facility_tpEquityFundingAdjustmentRate/10000),NA)

Facility_tpEquityFundingAdjustmentRate   = MatrixLookup("AAB_Parameters.xls","CalculationParameters","3MAANDSEURIBORBP",2)+Facility_tpLiquiditySpreadBps

Facility_tpInterestRateIndexBasis        = OnEr(MatrixLookup("AAB_Parameters.xls","CustomerSpreadAddMargin",&Facility_tpProductinterestDetailsInterestProductName,2),NA)  ; 1/0


;=============================   $>Regulatory Profit - Equity Capital Charge<$   ========================

.Variables
PI      1N     6               $>Regulatory Profit - Equity Capital Charge<$                                                   \Facility_tpEquityCapitalCharge
PI      1N     7               $>Regulatory Profit - Equity Capital Charge - Required Amount of Equity<$                       \Facility_tpRequiredAmountofEquity

.Formulas NoTrend
Facility_tpEquityCapitalCharge     = OnER(Facility_tpRequiredAmountofEquity*Borrower_tpCostofEquity*Facility_tpDeannualize,NA)
Facility_tpRequiredAmountofEquity  = OnER(Facility_tpRWA*Borrower_tpEquityRatio,NA)

.Hints
Facility_tpEquityCapitalCharge     = The outcome will be multiplied by the fraction of the remaining average tenor when < 1 year

;=============================   $>Risk Weighted Assets<$    ========================
.Variables

PI      1N     5               $>Risk Weighted Assets<$                                                                        \Facility_tpRWA
PI      1N     6               $>Risk Weighted Assets - Credit Risk<$                                                          \Facility_tpRWACreditRisk
PI      1N     7               $>Risk Weighted Assets - Credit Risk - Standard/Ungaranteed<$                                   \Facility_tpRWACreditRiskUnguaranteed

PI    2 1N     8               $>Risk Weighted Assets - Max Maturity RWA<$                                                     \Facility_tpMaxMaturityRWA
PI    2 1N     8               $>Risk Weighted Assets - Min Maturity RWA<$                                                     \Facility_tpMinMaturityRWA
PI      1N C   8               $>Risk Weighted Assets - Short Term Exception<$                                                 \Facility_tpShortTermException

PI    2 1N     8               $>Risk Weighted Assets - Correlation Factor (R)<$                                               \Facility_tpR
PI    2 1N     9               $>Risk Weighted Assets - Correlation Factor (R1)<$                                              \Facility_tpR1
PI    2 1N     9               $>Risk Weighted Assets - Correlation Factor (R2)<$                                              \Facility_tpR2
PI    2 1N     8               $>Risk Weighted Assets - Maturity Adjustment Factor (b)<$                                       \Facility_tpb
PI    2 1N     8               $>Risk Weighted Assets - MWRA Factor<$                                                          \Facility_tpMWRA
PI    2 1N     8               $>Risk Weighted Assets - Capital Requirement (K)<$                                              \Facility_tpK
PI    2 1N     8               $>Risk Weighted Assets - Risk Weight Factor (RW)<$                                              \Facility_tpRW

PI      1N     7               $>Risk Weighted Assets - Credit Risk - Guarantees<$                                             \Facility_tpRWACreditRiskGuaranteed

PI    4 1N %   8               $>Risk Weighted Assets - PD Moc Min<$                                                           \Facility_tpPDMoCGuaranteed
PI    2 1N %   8               $>Risk Weighted Assets - D LGD MoC Min<$                                                        \Facility_tpDLGDMoCGuaranteed

PI    2 1N     8               $>Risk Weighted Assets - Correlation Factor (R)<$                                               \Facility_tpRGuaranteed
PI    2 1N     9               $>Risk Weighted Assets - Correlation Factor (R1)<$                                              \Facility_tpR1Guaranteed
PI    2 1N     9               $>Risk Weighted Assets - Correlation Factor (R2)<$                                              \Facility_tpR2Guaranteed
PI    2 1N     8               $>Risk Weighted Assets - Maturity Adjustment Factor (b)<$                                       \Facility_tpbGuaranteed
PI    2 1N     8               $>Risk Weighted Assets - MWRA Factor<$                                                          \Facility_tpMWRAGuaranteed
PI    2 1N     8               $>Risk Weighted Assets - Capital Requirement (K)<$                                              \Facility_tpKGuaranteed
PI    2 1N     8               $>Risk Weighted Assets - Risk Weight Factor (RW)<$                                              \Facility_tpRWGuaranteed



PI      1N     6               $>Risk Weighted Assets - Operational Risk<$                                                     \Facility_tpRWAOperationalRisk
PI    3 1N %   7               $>Risk Weighted Assets - RWA OpR (%)<$                                                          \Facility_tpRWAOpR
.Choices
Facility_tpShortTermException            = "1:Yes|0:No"

.Formulas NoTrend

Facility_tpRWA                           = OnER(Facility_tpRWACreditRisk+Facility_tpRWAOperationalRisk,NA)
Facility_tpRWACreditRisk                 = OnER(Facility_tpRWACreditRiskGuaranteed+Facility_tpRWACreditRiskUnguaranteed,NA)
Facility_tpRWACreditRiskUnguaranteed     = Facility_tpRW*Facility_tpEADUnguaranteed

Facility_tpMaxMaturityRWA                = MatrixLookup("AAB_Parameters.xls","CalculationParameters","MAX_MATURITY_RWA",2)
Facility_tpMinMaturityRWA                = MatrixLookup("AAB_Parameters.xls","CalculationParameters","MIN_MATURITY_RWA",2)
Facility_tpShortTermException            = MatrixLookup("AAB_Parameters.xls","ProductType",&Facility_tpType,7)

; ----------------------- Std/Unguaranteed part --------------------------


Facility_tpR                             = If((Facility_tpFI=0),Facility_tpR2,If((Facility_tpFI=1) And (Borrower_tpAssetSize<=70000) And (Borrower_tpUnderSupervision=1),Facility_tpR2,Facility_tpR1))
Facility_tpR1                            = (((0.12*(1-Exp(-50*Facility_tpBorrower_tpPDMoC)))/(1-Exp(-50)))+(0.24*((1-(1-Exp(-50*Facility_tpBorrower_tpPDMoC)))/(1-Exp(-50)))))*1.25
Facility_tpR2                            = ((0.12*(1-Exp(-50*Facility_tpBorrower_tpPDMoC)))/(1-Exp(-50)))+(0.24*(((1-(1-Exp(-50*Facility_tpBorrower_tpPDMoC))))/(1-Exp(-50))))-0.04*(1-(((MAX(5,(MIN(50,Borrower_tpAssetSize)))-5)/45)))
Facility_tpb                             = OnER((0.11852-0.05478*LN(Facility_tpBorrower_tpPDMoC))^2,NA)
Facility_tpMWRA                          = OnER(IF(Facility_tpShortTermException,Max(Min(Facility_tpMaxMaturityRWA,Facility_tpRemainingAverageTenor),1/365),Max(Min(Facility_tpMaxMaturityRWA,Facility_tpRemainingAverageTenor),Facility_tpMinMaturityRWA)),NA)
Facility_tpK                             = OnER((Facility_tpDLGDMoC*CumNormal(((1-Facility_tpR)^(-0.5))*InvNormal(Facility_tpBorrower_tpPDMoC)+(((Facility_tpR/(1-Facility_tpR))^(0.5))*InvNormal(0.999)))-Facility_tpBorrower_tpPDMoC*Facility_tpDLGDMoC)*((1-1.5*Facility_tpb)^(-1))*(1+(Facility_tpMWRA-2.5)*Facility_tpb),NA)
Facility_tpRW                            = OnER(Facility_tpK*12.5*1.06,NA)



; ----------------------- Guaranteed part --------------------------

Facility_tpRWACreditRiskGuaranteed       = Facility_tpRWGuaranteed*Facility_tpEADGuaranteed

Facility_tpPDMoCGuaranteed               = If((Facility_tpGuarantorPercentageGuaranteed>0) And (Facility_tpGuarantorPDMoC < Facility_tpBorrower_tpPDMoC),Facility_tpGuarantorPDMoC,Facility_tpBorrower_tpPDMoC)
Facility_tpDLGDMoCGuaranteed             = Facility_tpDLGDMoC ; OR DLGD * MOC factor Guarantor!!! SPW 16-7-2015

Facility_tpRGuaranteed                   = If((Borrower_tpFinancialInstitutionChoice=0),Facility_tpR2Guaranteed,If((Facility_tpFI=1) And (Borrower_tpAssetSize<=70000) And (Borrower_tpUnderSupervision=1),Facility_tpR2Guaranteed,Facility_tpR1Guaranteed))
Facility_tpR1Guaranteed                  = (((0.12*(1-Exp(-50*Facility_tpPDMoCGuaranteed)))/(1-Exp(-50)))+(0.24*((1-(1-Exp(-50*Facility_tpPDMoCGuaranteed)))/(1-Exp(-50)))))*1.25
Facility_tpR2Guaranteed                  = ((0.12*(1-Exp(-50*Facility_tpPDMoCGuaranteed)))/(1-Exp(-50)))+(0.24*(((1-(1-Exp(-50*Facility_tpPDMoCGuaranteed))))/(1-Exp(-50))))-0.04*(1-(((MAX(5,(MIN(50,Borrower_tpAssetSize)))-5)/45)))


Facility_tpbGuaranteed                   = OnER((0.11852-0.05478*LN(Facility_tpPDMoCGuaranteed))^2,NA)
Facility_tpMWRAGuaranteed                = OnER(IF(Facility_tpShortTermException,Max(Min(Facility_tpMaxMaturityRWA,Facility_tpRemainingAverageTenor),1/365),Max(Min(Facility_tpMaxMaturityRWA,Facility_tpRemainingAverageTenor),Facility_tpMinMaturityRWA)),NA)
Facility_tpKGuaranteed                   = OnER((Facility_tpDLGDMoCGuaranteed*CumNormal(((1-Facility_tpRGuaranteed)^(-0.5))*InvNormal(Facility_tpPDMoCGuaranteed)+(((Facility_tpRGuaranteed/(1-Facility_tpRGuaranteed))^(0.5))*InvNormal(0.999)))-Facility_tpPDMoCGuaranteed*Facility_tpDLGDMoCGuaranteed)*((1-1.5*Facility_tpbGuaranteed)^(-1))*(1+(Facility_tpMWRAGuaranteed-2.5)*Facility_tpbGuaranteed),NA)
Facility_tpRWGuaranteed                  = OnER(Facility_tpKGuaranteed*12.5*1.06,NA)


;-------------------------------------------------------------------------------------------

Facility_tpRWAOperationalRisk            =(Facility_tpRWAOpR*(Facility_tpCreditIncome-Facility_tpDirectLiquidityPremium))
Facility_tpRWAOpR                        = MatrixLookup("AAB_Parameters.xls","ClientGroup",&Borrower_tpClientGroup,7)

;;============================== Exported Data ================================================================
.Variables

PP      1N     5               $>Exported Data<$                                                                                \Facility_tpDataExportedToForce
PP      1N     6               $>RaRoRaC<$                                                                                      \=Facility_tpRaRoRaC
PP      1N     6               $>Return on Equity<$                                                                             \=Facility_tpReturnOnEquity
PP      1N     6               $>Economic Profit<$                                                                              \=Facility_tpEconomicProfit
PP      1N     6               $>Regulatory Profit<$                                                                            \=Facility_tpRegulatoryProfit
PP      1N     6               $>Required Customer Spread<$                                                                     \Facility_tpRequiredCustomerSpread
PP    4 1N     6               $>Required Market Spread<$                                                                       \Facility_tpRequiredMarketSpread
PP      1N     7               $>Facility Type Index<$                                                                          \Facility_tpTypeIndex
PP      1N     6               $>Required Liquidity Spread<$                                                                    \Facility_tpRequiredLiquiditySpread

.Formulas NoTrend
Facility_tpRequiredCustomerSpread  = Facility_tpCustomerSpread / 10000
Facility_tpRequiredMarketSpread    = MatrixLookup("AAB_Parameters.xls","MarketSpread",&Facility_tpProductinterestDetailsInterestProductName,Facility_tpTypeIndex) 
Facility_tpTypeIndex               = MatrixLookup("AAB_Parameters.xls","VertaaltabelProductType",&Facility_tpType,2)
Facility_tpRequiredLiquiditySpread = Facility_tpLiquiditySpreadBps / 10000

;-----------
.Variables
PP    0 1N    -4        +       $>Total<$                                                           \FacilityTotal

.Formulas NoTrend
FacilityTotal = TupleSum(Facility_tpPrincipalLimit)

;---------
.Variables
PP      1N     3               $>Other<$                                                           \Other

PP      1A     4               "Versions"                                                          \VersionInfoText
PP      1A     5               "Gemaakt door"                                                      \WindowsUserName
PP      1N D   5               "Generated at"                                                      \CurrentDate                 ;; vertaald tbv compact report
PP      1A     5               "Gemaakt XML-applicatie version"                                    \FinanFullVersion


.Formulas NoTrend
WindowsUserName                = "#WindowsUserName#"
CurrentDate                    = #ApplicationStartDateTime#
FinanFullVersion               = "#FinanFullVersion#"
VersionInfoText							   = &Q_ModelType&" "&Q_ModelVersion&" (Matrix "&Q_MatrixVersion&")"

;==============================
.Variables
XX      1N     3               $>Hulpvariabelen<$                                                  \Q_MAP01_Hulpvariabelen
PP      1N     4               $>Aantal verplichte velden (1)<$                                    \Q_Map01_REQUIREDVARS
PP      1N     4               $>Aantal ingevulde verplichte velden (1)<$                          \Q_Map01_ENTEREDREQUIREDVARS
PP      1N     4               $>test variable for SumFor    <$                                    \Q_Map01_SUMFOR

.Formulas Notrend
Q_Map01_REQUIREDVARS           = FesExpression("Count(X,SelectDescendants(Q_Map01, Q_MAP01_Hulpvariabelen),InputRequired(X))")
Q_Map01_ENTEREDREQUIREDVARS    = FesExpression("Count(X,SelectDescendants(Q_Map01, Q_MAP01_Hulpvariabelen),InputRequired(X) And DataAvailable(X))")
Q_Map01                        = (Q_Map01_ENTEREDREQUIREDVARS=Q_Map01_REQUIREDVARS)
Q_Map01_WARNING                = &Q_WARNING_GLOBAL[1]
;Q_Map01_INFO                   =
Q_Map01_VALIDATION             = &If(Q_Map01[1]=0,&"Not all required questions in this step are completed. [BR][/BR]Mandatory questions are marked with a *.",&"")
Q_Map01_SUMFOR                 = FesExpression("SumFor(X,1,12,1,PPMT(1.0,X,24.0,-100000.0,0.0))")

.Choices
Q_Map01                        = Q_ROOT


;; .Variables
;; ;================================================================================================== MAP 2
;; PP      1N C   2               $>Facility<$                                                        \Q_Map02
;;
;; PP      1M   1 3               $>Warning voor map<$                                                \Q_MAP02_WARNING
;; PP      1A M   3               $>Info bij stap<$                                                   \Q_MAP02_INFO
;; PP      1A M   3               $>Validatie stap<$                                                  \Q_MAP02_VALIDATION
;;
;;
;; .Variables
;; ;==============================
;; ; Warning voor map 2
;;
;; .Variables
;; XX      1N     3               $>Hulpvariabelen<$                                                  \Q_MAP02_Hulpvariabelen
;; PP      1N     4               $>Aantal verplichte velden (1)<$                                    \Q_MAP02_REQUIREDVARS
;; PP      1N     4               $>Aantal ingevulde verplichte velden (1)<$                          \Q_MAP02_ENTEREDREQUIREDVARS
;;
;; .Formulas Notrend
;; Q_MAP02_REQUIREDVARS            = 1; FesExpression("Count(X,SelectDescendants(Q_MAP02, Q_MAP02_Hulpvariabelen),InputRequired(X))")
;; Q_MAP02_ENTEREDREQUIREDVARS     = 1; FesExpression("Count(X,SelectDescendants(Q_MAP02, Q_MAP02_Hulpvariabelen),InputRequired(X) And DataAvailable(X))")
;; Q_MAP02_WARNING                = &Q_WARNING_GLOBAL[1]
;; Q_MAP02                         = (Q_MAP02_ENTEREDREQUIREDVARS=Q_MAP02_REQUIREDVARS)
;; ;Q_MAP02_INFO                   =
;; Q_MAP02_VALIDATION             = &If(Q_MAP02[1]=0,&"Not all required questions in this step are completed. [BR][/BR]Mandatory questions are marked with a *.",&"")
;;
;; .Choices
;; Q_MAP02                        = Q_ROOT

.Variables
;================================================================================================== Result
; Resultaat
; wordt pas getoond na definitief maken

PP      1A   1 2               $>Results<$                                                         \Q_RESULT
PP      1A     3               =Q_RESULT                                                           \=Q_RESULT

.Variables
;================================================================================================== Result
; Q_Status
;

PI      1N C 1 2  +            Role                                             					           \Q_ROLE
PI      1N C   2  +            Status                                            					           \Q_STATUS
PI      1N D   2               $>Made final on:<$                                                    \Q_STATUS_FINAL_ON
PI      1A     2               $>Made final by (username):<$                                         \Q_STATUS_FINAL_BY
PI      1A     2               $>Made final by (fullname):<$                                         \Q_STATUS_FINAL_BY_NAME
PI      1N D   2               $>Created on:<$                                                       \Q_STATUS_STARTED_ON
PI      1A     2               $>Created by (username):<$                                            \Q_STATUS_STARTED_BY
PI      1A     2               $>Created by (fullname):<$                                            \Q_STATUS_STARTED_BY_NAME
PI      1N D   2  +            $>Last modification:<$                                                \Q_STATUS_MODIFIED_ON
PP      1A     2  +            $>Model version<$                                                     \Q_ModelVersion
PP      1A     2  +            $>Model type<$                                                        \Q_ModelType
PP      1A     2  +            $>Matrix version<$                                                    \Q_MatrixVersion

PI      1N C   2               "Previous"                                                            \Q_PREVIOUS_BUTTON_VISIBLE
PI      1N C   2               "Next"                                                                \Q_NEXT_BUTTON_VISIBLE
PI      1N C   2               "Draft report"                                                        \Q_CONCEPT_REPORT_VISIBLE
PI      1N C   2               "Final report"                                                        \Q_FINAL_REPORT_VISIBLE
PI      1N C   2               "Make it final"                                                       \Q_MAKE_FINAL_VISIBLE



.Choices
Q_ROLE                         = "0:Tester|2:RM|3:FB"
Q_PREVIOUS_BUTTON_VISIBLE      = "0:Nooit|2:Altijd"
Q_NEXT_BUTTON_VISIBLE          = "0:Nooit|1:Alleen wanneer stap volledig is|2:Altijd"
Q_CONCEPT_REPORT_VISIBLE       = "0:Nee|1:Ja"
Q_FINAL_REPORT_VISIBLE         = "0:Nee|1:Ja"
Q_MAKE_FINAL_VISIBLE           = "0:Nee|1:Ja"

.Formulas NoTrend
Q_ROLE                         = 0
Q_PREVIOUS_BUTTON_VISIBLE      = 2
Q_NEXT_BUTTON_VISIBLE          = 2
Q_CONCEPT_REPORT_VISIBLE       = 0
Q_FINAL_REPORT_VISIBLE         = 0
Q_MAKE_FINAL_VISIBLE           = 0

.Choices
Q_STATUS                       = "0:$>Open<$|1:$>Final<$"

.Formulas NoTrend
Q_STATUS                       = 0
Q_STATUS_MODIFIED_ON           = Now
Q_ModelVersion                 = "#ModelVersion#"                                                                                           ; EJS: mooier is (maar kan niet in webversie): &SysVar("ModelVersion")
Q_MatrixVersion                = &MatrixLookup("AAB_Parameters.xls","Version",1,3)
Q_ModelType                    = "#MODELCODE#"

.Variables
;==========================================================================================================================================
; Overige berekeningen (buiten Q_ROOT)

PX      1X   1 1               "Overige berekeningen"                                              \Hulpvariabelen

.Formulas Notrend

.Variables
;================================================================================================== Q_HULPVARS
; Knock-outs


PP      1A     2               "Knockout(s)?"                                                      \Q_WARNING_GLOBAL
PP      1A     3               "Knockouts tekst"                                                   \scKnockoutsCombi

.Formulas NoTrend
Q_WARNING_GLOBAL               = &If(Length(&scKnockoutsCombi[1])>0,&"|Er zijn knockouts van toepassing:"&scKnockoutsCombi,"")

.Variables
;================================================================================================== Restricties
; Restricties

PP      1A     2               "Restricties"                                                       \scRestricties
PP      1A   1 3               "Restricties tekst"                                                 \scRestrictiesCombi


.Formulas NoTrend
scRestricties                  = &If(Length(&scRestrictiesCombi[1])>0,&"||De volgende variabelen zijn niet correct gevuld:"&scRestrictiesCombi,"")

.Quit