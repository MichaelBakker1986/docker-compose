'use strict';

var cov_2q8q9029it = function () {
	var path = 'C:\\Users\\michael\\Documents\\lme\\lme-model-api\\src\\ModelStorage.js',
	    hash = '65bfd8f2b5ab78929ebfa1c22bcce15c7b043010',
	    Function = function () {}.constructor,
	    global = new Function('return this')(),
	    gcv = '__coverage__',
	    coverageData = {
		path: 'C:\\Users\\michael\\Documents\\lme\\lme-model-api\\src\\ModelStorage.js',
		statementMap: {
			'0': {
				start: {
					line: 36,
					column: 1
				},
				end: {
					line: 39,
					column: 3
				}
			},
			'1': {
				start: {
					line: 37,
					column: 2
				},
				end: {
					line: 37,
					column: 62
				}
			},
			'2': {
				start: {
					line: 38,
					column: 2
				},
				end: {
					line: 38,
					column: 42
				}
			},
			'3': {
				start: {
					line: 42,
					column: 0
				},
				end: {
					line: 50,
					column: 1
				}
			},
			'4': {
				start: {
					line: 43,
					column: 1
				},
				end: {
					line: 49,
					column: 3
				}
			},
			'5': {
				start: {
					line: 44,
					column: 2
				},
				end: {
					line: 44,
					column: 14
				}
			},
			'6': {
				start: {
					line: 45,
					column: 2
				},
				end: {
					line: 45,
					column: 11
				}
			},
			'7': {
				start: {
					line: 47,
					column: 2
				},
				end: {
					line: 47,
					column: 16
				}
			},
			'8': {
				start: {
					line: 48,
					column: 2
				},
				end: {
					line: 48,
					column: 80
				}
			},
			'9': {
				start: {
					line: 62,
					column: 0
				},
				end: {
					line: 90,
					column: 1
				}
			},
			'10': {
				start: {
					line: 63,
					column: 17
				},
				end: {
					line: 63,
					column: 85
				}
			},
			'11': {
				start: {
					line: 64,
					column: 24
				},
				end: {
					line: 64,
					column: 64
				}
			},
			'12': {
				start: {
					line: 65,
					column: 1
				},
				end: {
					line: 89,
					column: 2
				}
			},
			'13': {
				start: {
					line: 67,
					column: 26
				},
				end: {
					line: 67,
					column: 93
				}
			},
			'14': {
				start: {
					line: 68,
					column: 20
				},
				end: {
					line: 68,
					column: 22
				}
			},
			'15': {
				start: {
					line: 69,
					column: 22
				},
				end: {
					line: 69,
					column: 46
				}
			},
			'16': {
				start: {
					line: 70,
					column: 15
				},
				end: {
					line: 70,
					column: 21
				}
			},
			'17': {
				start: {
					line: 71,
					column: 2
				},
				end: {
					line: 74,
					column: 3
				}
			},
			'18': {
				start: {
					line: 72,
					column: 18
				},
				end: {
					line: 72,
					column: 51
				}
			},
			'19': {
				start: {
					line: 73,
					column: 3
				},
				end: {
					line: 73,
					column: 94
				}
			},
			'20': {
				start: {
					line: 75,
					column: 2
				},
				end: {
					line: 78,
					column: 3
				}
			},
			'21': {
				start: {
					line: 76,
					column: 18
				},
				end: {
					line: 76,
					column: 51
				}
			},
			'22': {
				start: {
					line: 77,
					column: 3
				},
				end: {
					line: 77,
					column: 94
				}
			},
			'23': {
				start: {
					line: 79,
					column: 2
				},
				end: {
					line: 82,
					column: 3
				}
			},
			'24': {
				start: {
					line: 80,
					column: 18
				},
				end: {
					line: 80,
					column: 51
				}
			},
			'25': {
				start: {
					line: 81,
					column: 3
				},
				end: {
					line: 81,
					column: 89
				}
			},
			'26': {
				start: {
					line: 83,
					column: 2
				},
				end: {
					line: 87,
					column: 4
				}
			},
			'27': {
				start: {
					line: 84,
					column: 3
				},
				end: {
					line: 84,
					column: 15
				}
			},
			'28': {
				start: {
					line: 86,
					column: 3
				},
				end: {
					line: 86,
					column: 32
				}
			},
			'29': {
				start: {
					line: 86,
					column: 18
				},
				end: {
					line: 86,
					column: 32
				}
			},
			'30': {
				start: {
					line: 88,
					column: 2
				},
				end: {
					line: 88,
					column: 13
				}
			},
			'31': {
				start: {
					line: 91,
					column: 0
				},
				end: {
					line: 108,
					column: 1
				}
			},
			'32': {
				start: {
					line: 92,
					column: 16
				},
				end: {
					line: 92,
					column: 46
				}
			},
			'33': {
				start: {
					line: 93,
					column: 1
				},
				end: {
					line: 106,
					column: 2
				}
			},
			'34': {
				start: {
					line: 94,
					column: 24
				},
				end: {
					line: 94,
					column: 38
				}
			},
			'35': {
				start: {
					line: 95,
					column: 20
				},
				end: {
					line: 95,
					column: 83
				}
			},
			'36': {
				start: {
					line: 96,
					column: 2
				},
				end: {
					line: 96,
					column: 29
				}
			},
			'37': {
				start: {
					line: 97,
					column: 29
				},
				end: {
					line: 97,
					column: 43
				}
			},
			'38': {
				start: {
					line: 98,
					column: 25
				},
				end: {
					line: 98,
					column: 68
				}
			},
			'39': {
				start: {
					line: 99,
					column: 2
				},
				end: {
					line: 99,
					column: 34
				}
			},
			'40': {
				start: {
					line: 100,
					column: 19
				},
				end: {
					line: 100,
					column: 78
				}
			},
			'41': {
				start: {
					line: 101,
					column: 25
				},
				end: {
					line: 101,
					column: 43
				}
			},
			'42': {
				start: {
					line: 102,
					column: 2
				},
				end: {
					line: 102,
					column: 53
				}
			},
			'43': {
				start: {
					line: 102,
					column: 17
				},
				end: {
					line: 102,
					column: 53
				}
			},
			'44': {
				start: {
					line: 103,
					column: 2
				},
				end: {
					line: 103,
					column: 22
				}
			},
			'45': {
				start: {
					line: 104,
					column: 2
				},
				end: {
					line: 104,
					column: 41
				}
			},
			'46': {
				start: {
					line: 105,
					column: 2
				},
				end: {
					line: 105,
					column: 33
				}
			},
			'47': {
				start: {
					line: 107,
					column: 1
				},
				end: {
					line: 107,
					column: 14
				}
			},
			'48': {
				start: {
					line: 109,
					column: 0
				},
				end: {
					line: 109,
					column: 41
				}
			}
		},
		fnMap: {
			'0': {
				name: 'ModelStorage',
				decl: {
					start: {
						line: 35,
						column: 9
					},
					end: {
						line: 35,
						column: 21
					}
				},
				loc: {
					start: {
						line: 35,
						column: 24
					},
					end: {
						line: 40,
						column: 1
					}
				},
				line: 35
			},
			'1': {
				name: '(anonymous_1)',
				decl: {
					start: {
						line: 36,
						column: 16
					},
					end: {
						line: 36,
						column: 17
					}
				},
				loc: {
					start: {
						line: 36,
						column: 70
					},
					end: {
						line: 39,
						column: 2
					}
				},
				line: 36
			},
			'2': {
				name: '(anonymous_2)',
				decl: {
					start: {
						line: 42,
						column: 36
					},
					end: {
						line: 42,
						column: 37
					}
				},
				loc: {
					start: {
						line: 42,
						column: 51
					},
					end: {
						line: 50,
						column: 1
					}
				},
				line: 42
			},
			'3': {
				name: '(anonymous_3)',
				decl: {
					start: {
						line: 43,
						column: 51
					},
					end: {
						line: 43,
						column: 52
					}
				},
				loc: {
					start: {
						line: 43,
						column: 64
					},
					end: {
						line: 46,
						column: 2
					}
				},
				line: 43
			},
			'4': {
				name: '(anonymous_4)',
				decl: {
					start: {
						line: 46,
						column: 10
					},
					end: {
						line: 46,
						column: 11
					}
				},
				loc: {
					start: {
						line: 46,
						column: 24
					},
					end: {
						line: 49,
						column: 2
					}
				},
				line: 46
			},
			'5': {
				name: '(anonymous_5)',
				decl: {
					start: {
						line: 62,
						column: 35
					},
					end: {
						line: 62,
						column: 36
					}
				},
				loc: {
					start: {
						line: 62,
						column: 56
					},
					end: {
						line: 90,
						column: 1
					}
				},
				line: 62
			},
			'6': {
				name: '(anonymous_6)',
				decl: {
					start: {
						line: 83,
						column: 40
					},
					end: {
						line: 83,
						column: 41
					}
				},
				loc: {
					start: {
						line: 83,
						column: 53
					},
					end: {
						line: 85,
						column: 3
					}
				},
				line: 83
			},
			'7': {
				name: '(anonymous_7)',
				decl: {
					start: {
						line: 85,
						column: 11
					},
					end: {
						line: 85,
						column: 12
					}
				},
				loc: {
					start: {
						line: 85,
						column: 18
					},
					end: {
						line: 87,
						column: 3
					}
				},
				line: 85
			},
			'8': {
				name: '(anonymous_8)',
				decl: {
					start: {
						line: 91,
						column: 40
					},
					end: {
						line: 91,
						column: 41
					}
				},
				loc: {
					start: {
						line: 91,
						column: 70
					},
					end: {
						line: 108,
						column: 1
					}
				},
				line: 91
			}
		},
		branchMap: {
			'0': {
				loc: {
					start: {
						line: 65,
						column: 1
					},
					end: {
						line: 89,
						column: 2
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 65,
						column: 1
					},
					end: {
						line: 89,
						column: 2
					}
				}, {
					start: {
						line: 65,
						column: 1
					},
					end: {
						line: 89,
						column: 2
					}
				}],
				line: 65
			},
			'1': {
				loc: {
					start: {
						line: 65,
						column: 5
					},
					end: {
						line: 65,
						column: 65
					}
				},
				type: 'binary-expr',
				locations: [{
					start: {
						line: 65,
						column: 5
					},
					end: {
						line: 65,
						column: 35
					}
				}, {
					start: {
						line: 65,
						column: 39
					},
					end: {
						line: 65,
						column: 65
					}
				}],
				line: 65
			},
			'2': {
				loc: {
					start: {
						line: 86,
						column: 3
					},
					end: {
						line: 86,
						column: 32
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 86,
						column: 3
					},
					end: {
						line: 86,
						column: 32
					}
				}, {
					start: {
						line: 86,
						column: 3
					},
					end: {
						line: 86,
						column: 32
					}
				}],
				line: 86
			},
			'3': {
				loc: {
					start: {
						line: 93,
						column: 1
					},
					end: {
						line: 106,
						column: 2
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 93,
						column: 1
					},
					end: {
						line: 106,
						column: 2
					}
				}, {
					start: {
						line: 93,
						column: 1
					},
					end: {
						line: 106,
						column: 2
					}
				}],
				line: 93
			},
			'4': {
				loc: {
					start: {
						line: 102,
						column: 2
					},
					end: {
						line: 102,
						column: 53
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 102,
						column: 2
					},
					end: {
						line: 102,
						column: 53
					}
				}, {
					start: {
						line: 102,
						column: 2
					},
					end: {
						line: 102,
						column: 53
					}
				}],
				line: 102
			}
		},
		s: {
			'0': 0,
			'1': 0,
			'2': 0,
			'3': 0,
			'4': 0,
			'5': 0,
			'6': 0,
			'7': 0,
			'8': 0,
			'9': 0,
			'10': 0,
			'11': 0,
			'12': 0,
			'13': 0,
			'14': 0,
			'15': 0,
			'16': 0,
			'17': 0,
			'18': 0,
			'19': 0,
			'20': 0,
			'21': 0,
			'22': 0,
			'23': 0,
			'24': 0,
			'25': 0,
			'26': 0,
			'27': 0,
			'28': 0,
			'29': 0,
			'30': 0,
			'31': 0,
			'32': 0,
			'33': 0,
			'34': 0,
			'35': 0,
			'36': 0,
			'37': 0,
			'38': 0,
			'39': 0,
			'40': 0,
			'41': 0,
			'42': 0,
			'43': 0,
			'44': 0,
			'45': 0,
			'46': 0,
			'47': 0,
			'48': 0
		},
		f: {
			'0': 0,
			'1': 0,
			'2': 0,
			'3': 0,
			'4': 0,
			'5': 0,
			'6': 0,
			'7': 0,
			'8': 0
		},
		b: {
			'0': [0, 0],
			'1': [0, 0],
			'2': [0, 0],
			'3': [0, 0],
			'4': [0, 0]
		},
		_coverageSchema: 'd34fc3e6b8297bcde183f5492bcb8fcb36775295'
	},
	    coverage = global[gcv] || (global[gcv] = {});

	if (coverage[path] && coverage[path].hash === hash) {
		return coverage[path];
	}

	coverageData.hash = hash;
	return coverage[path] = coverageData;
}();

var _index = require('../../lme-core/index');

var _index2 = require('../../ffl/index');

var _uuid = require('uuid4');

var _uuid2 = _interopRequireDefault(_uuid);

var _log = require('log6');

var _log2 = _interopRequireDefault(_log);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _ModelAssembler = require('../../git-connect/ModelAssembler');

var _ModelAssembler2 = _interopRequireDefault(_ModelAssembler);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * A data-state contains
 *  - Translation file(s)    MODEL.test(1.1).csv
 *  - FFL model files(s)     MODEL.test(0.1).ffl
 *  - JBehave story files(s) MODEL(test-v1).story
 *  - Excel matrix files(s)  MODEL(test-v1).xlsx
 *  -
 *
 *  We want to load multiple version files runtime.
 *  Storage is another question
 *  Could load only last 4versions.
 *
 *  model(v1|2|3|4).ffl -> LME
 *  We require state to be changed runtime, Since we update small parts of the model only constantly
 *  And ability to change model also.
 *
 *  TODO: bug in JBehave view while editing FFL.
 *
 *  root
 *  {
 *    version: a
 *  }
 *  is combined with model X uses BaseModel {
 *  will become x_root_value   = null
 *  will become x_root_version = a
 */
function ModelStorage() {
	var _this = this;

	cov_2q8q9029it.f[0]++;
	cov_2q8q9029it.s[0]++;

	_ModelAssembler2.default.then(function (_ref) {
		var getFFLModelPropertyChanges = _ref.getFFLModelPropertyChanges,
		    insertProperties = _ref.insertProperties;
		cov_2q8q9029it.f[1]++;
		cov_2q8q9029it.s[1]++;

		_this.getFFLModelPropertyChanges = getFFLModelPropertyChanges;
		cov_2q8q9029it.s[2]++;
		_this.insertProperties = insertProperties;
	});
}

cov_2q8q9029it.s[3]++;
ModelStorage.prototype.getHistory = function (name) {
	cov_2q8q9029it.f[2]++;
	cov_2q8q9029it.s[4]++;

	return this.getFFLModelPropertyChanges(name).then(function (ok) {
		cov_2q8q9029it.f[3]++;
		cov_2q8q9029it.s[5]++;

		_log2.default.info(ok);
		cov_2q8q9029it.s[6]++;
		return ok;
	}).catch(function (err) {
		cov_2q8q9029it.f[4]++;
		cov_2q8q9029it.s[7]++;

		_log2.default.error(err);
		cov_2q8q9029it.s[8]++;
		throw Error('Unable to get history for model with name ' + name + 'm' + err.stack);
	});
};
/**
 * TODO: WE KNOW FOR ALL VALUES IN THE MODEL WHAT VALUES IT OUTPUTS IN THE MONTOCARLO TEST
 * STORE THESE VALUES,  AND MATCH IT VS UPDATES!!!!!
 * THIS WAY we do not explicitly need a JBehave Test, we can conftront the editor with the changes once he want to edit formula's
 *
 * Variables * FormulaSets[doc|column_trend|column_notrend_user|valuation]
 * So we can create a DELTA-COMPARE between calculations. ALSO internal calculations will be reported
 *
 * document_title: 'Hoi';
 *   column_title: 'Other';
 */
cov_2q8q9029it.s[9]++;
ModelStorage.prototype.saveDelta = function (name, data) {
	cov_2q8q9029it.f[5]++;

	var fflPath = (cov_2q8q9029it.s[10]++, _path2.default.resolve(__dirname + '/../../git-connect/resources/' + name + '.ffl'));
	var compareResults = (cov_2q8q9029it.s[11]++, this.doDeltaCompare(name, fflPath, data));
	cov_2q8q9029it.s[12]++;
	if ((cov_2q8q9029it.b[1][0]++, compareResults.status === 'ok') && (cov_2q8q9029it.b[1][1]++, compareResults.changes > 0)) {
		cov_2q8q9029it.b[0][0]++;

		var i = void 0;
		var relativeFFLPath = (cov_2q8q9029it.s[13]++, _path2.default.relative(__dirname + '/../../git-connect/resources/', fflPath));
		var dbEntries = (cov_2q8q9029it.s[14]++, []);
		var create_time = (cov_2q8q9029it.s[15]++, new Date().toUTCString());
		var hash = (cov_2q8q9029it.s[16]++, (0, _uuid2.default)());
		cov_2q8q9029it.s[17]++;
		for (i = 0; i < compareResults.compare.updates.length; i++) {
			var update = (cov_2q8q9029it.s[18]++, compareResults.compare.updates[i]);
			cov_2q8q9029it.s[19]++;
			dbEntries.push([hash, create_time, relativeFFLPath, name, update[1], update[2], update[3]]);
		}
		cov_2q8q9029it.s[20]++;
		for (i = 0; i < compareResults.compare.inserts.length; i++) {
			var _update = (cov_2q8q9029it.s[21]++, compareResults.compare.inserts[i]);
			cov_2q8q9029it.s[22]++;
			dbEntries.push([hash, create_time, relativeFFLPath, name, _update[1], _update[2], _update[3]]);
		}
		cov_2q8q9029it.s[23]++;
		for (i = 0; i < compareResults.compare.deletes.length; i++) {
			var _update2 = (cov_2q8q9029it.s[24]++, compareResults.compare.deletes[i]);
			cov_2q8q9029it.s[25]++;
			dbEntries.push([hash, create_time, relativeFFLPath, name, _update2[1], _update2[2], null]);
		}
		cov_2q8q9029it.s[26]++;
		this.insertProperties(dbEntries).then(function (ok) {
			cov_2q8q9029it.f[6]++;
			cov_2q8q9029it.s[27]++;

			_log2.default.info(ok);
		}).catch(function (err) {
			cov_2q8q9029it.f[7]++;
			cov_2q8q9029it.s[28]++;

			if (_log2.default.DEBUG) {
					cov_2q8q9029it.b[2][0]++;
					cov_2q8q9029it.s[29]++;
					_log2.default.error(err);
				} else {
				cov_2q8q9029it.b[2][1]++;
			}
		});
		cov_2q8q9029it.s[30]++;
		return hash;
	} else {
		cov_2q8q9029it.b[0][1]++;
	}
};
cov_2q8q9029it.s[31]++;
ModelStorage.prototype.doDeltaCompare = function (name, fflPath, data) {
	cov_2q8q9029it.f[8]++;

	var result = (cov_2q8q9029it.s[32]++, { status: 'fail', changes: 0 });
	cov_2q8q9029it.s[33]++;
	if (_fs2.default.existsSync(fflPath)) {
		cov_2q8q9029it.b[3][0]++;

		var modelRegister = (cov_2q8q9029it.s[34]++, new _index.Register());
		var fflformat = (cov_2q8q9029it.s[35]++, new _index2.FFLToRegister(modelRegister, (0, _fs.readFileSync)(fflPath, 'utf8')));
		cov_2q8q9029it.s[36]++;
		fflformat.parseProperties();
		var otherModelRegister = (cov_2q8q9029it.s[37]++, new _index.Register());
		var otherFFLFormat = (cov_2q8q9029it.s[38]++, new _index2.FFLToRegister(otherModelRegister, data));
		cov_2q8q9029it.s[39]++;
		otherFFLFormat.parseProperties();
		var dcompare = (cov_2q8q9029it.s[40]++, new _index2.DeltaCompareRegister(modelRegister, otherModelRegister));
		var compareResults = (cov_2q8q9029it.s[41]++, dcompare.compare());
		cov_2q8q9029it.s[42]++;
		if (_log2.default.TRACE) {
				cov_2q8q9029it.b[4][0]++;
				cov_2q8q9029it.s[43]++;
				_log2.default.trace(compareResults.toString());
			} else {
			cov_2q8q9029it.b[4][1]++;
		}cov_2q8q9029it.s[44]++;
		result.status = 'ok';
		cov_2q8q9029it.s[45]++;
		result.changes = compareResults.changes;
		cov_2q8q9029it.s[46]++;
		result.compare = compareResults;
	} else {
		cov_2q8q9029it.b[3][1]++;
	}
	cov_2q8q9029it.s[47]++;
	return result;
};
cov_2q8q9029it.s[48]++;
exports.ModelStorage = new ModelStorage();