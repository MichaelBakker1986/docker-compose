'use strict';

var cov_27zmzsia0m = function () {
	var path = 'C:\\Users\\michael\\Documents\\lme\\lme-model-api\\src\\FFLWebpackConverter.js',
	    hash = '6a42e0868a03b71d9a96e94cd6dd1b670142084a',
	    Function = function () {}.constructor,
	    global = new Function('return this')(),
	    gcv = '__coverage__',
	    coverageData = {
		path: 'C:\\Users\\michael\\Documents\\lme\\lme-model-api\\src\\FFLWebpackConverter.js',
		statementMap: {
			'0': {
				start: {
					line: 14,
					column: 17
				},
				end: {
					line: 14,
					column: 23
				}
			},
			'1': {
				start: {
					line: 15,
					column: 18
				},
				end: {
					line: 15,
					column: 20
				}
			},
			'2': {
				start: {
					line: 16,
					column: 28
				},
				end: {
					line: 16,
					column: 41
				}
			},
			'3': {
				start: {
					line: 17,
					column: 25
				},
				end: {
					line: 17,
					column: 78
				}
			},
			'4': {
				start: {
					line: 18,
					column: 18
				},
				end: {
					line: 18,
					column: 42
				}
			},
			'5': {
				start: {
					line: 19,
					column: 34
				},
				end: {
					line: 19,
					column: 126
				}
			},
			'6': {
				start: {
					line: 19,
					column: 49
				},
				end: {
					line: 19,
					column: 126
				}
			},
			'7': {
				start: {
					line: 20,
					column: 18
				},
				end: {
					line: 20,
					column: 54
				}
			},
			'8': {
				start: {
					line: 22,
					column: 24
				},
				end: {
					line: 58,
					column: 1
				}
			},
			'9': {
				start: {
					line: 23,
					column: 16
				},
				end: {
					line: 23,
					column: 35
				}
			},
			'10': {
				start: {
					line: 24,
					column: 1
				},
				end: {
					line: 56,
					column: 2
				}
			},
			'11': {
				start: {
					line: 25,
					column: 2
				},
				end: {
					line: 53,
					column: 4
				}
			},
			'12': {
				start: {
					line: 54,
					column: 2
				},
				end: {
					line: 54,
					column: 39
				}
			},
			'13': {
				start: {
					line: 55,
					column: 2
				},
				end: {
					line: 55,
					column: 32
				}
			},
			'14': {
				start: {
					line: 57,
					column: 1
				},
				end: {
					line: 57,
					column: 27
				}
			},
			'15': {
				start: {
					line: 62,
					column: 2
				},
				end: {
					line: 62,
					column: 28
				}
			},
			'16': {
				start: {
					line: 63,
					column: 2
				},
				end: {
					line: 63,
					column: 28
				}
			},
			'17': {
				start: {
					line: 67,
					column: 20
				},
				end: {
					line: 67,
					column: 34
				}
			},
			'18': {
				start: {
					line: 68,
					column: 19
				},
				end: {
					line: 68,
					column: 71
				}
			},
			'19': {
				start: {
					line: 69,
					column: 2
				},
				end: {
					line: 83,
					column: 4
				}
			},
			'20': {
				start: {
					line: 70,
					column: 3
				},
				end: {
					line: 82,
					column: 4
				}
			},
			'21': {
				start: {
					line: 71,
					column: 4
				},
				end: {
					line: 79,
					column: 6
				}
			},
			'22': {
				start: {
					line: 72,
					column: 5
				},
				end: {
					line: 72,
					column: 25
				}
			},
			'23': {
				start: {
					line: 72,
					column: 14
				},
				end: {
					line: 72,
					column: 25
				}
			},
			'24': {
				start: {
					line: 73,
					column: 5
				},
				end: {
					line: 78,
					column: 8
				}
			},
			'25': {
				start: {
					line: 81,
					column: 4
				},
				end: {
					line: 81,
					column: 15
				}
			},
			'26': {
				start: {
					line: 87,
					column: 20
				},
				end: {
					line: 87,
					column: 32
				}
			},
			'27': {
				start: {
					line: 88,
					column: 26
				},
				end: {
					line: 88,
					column: 74
				}
			},
			'28': {
				start: {
					line: 89,
					column: 16
				},
				end: {
					line: 89,
					column: 67
				}
			},
			'29': {
				start: {
					line: 90,
					column: 2
				},
				end: {
					line: 90,
					column: 21
				}
			},
			'30': {
				start: {
					line: 91,
					column: 2
				},
				end: {
					line: 91,
					column: 84
				}
			},
			'31': {
				start: {
					line: 95,
					column: 0
				},
				end: {
					line: 112,
					column: 2
				}
			},
			'32': {
				start: {
					line: 96,
					column: 1
				},
				end: {
					line: 96,
					column: 77
				}
			},
			'33': {
				start: {
					line: 98,
					column: 1
				},
				end: {
					line: 102,
					column: 2
				}
			},
			'34': {
				start: {
					line: 99,
					column: 2
				},
				end: {
					line: 99,
					column: 74
				}
			},
			'35': {
				start: {
					line: 101,
					column: 2
				},
				end: {
					line: 101,
					column: 58
				}
			},
			'36': {
				start: {
					line: 103,
					column: 15
				},
				end: {
					line: 103,
					column: 83
				}
			},
			'37': {
				start: {
					line: 104,
					column: 1
				},
				end: {
					line: 104,
					column: 23
				}
			},
			'38': {
				start: {
					line: 105,
					column: 19
				},
				end: {
					line: 105,
					column: 34
				}
			},
			'39': {
				start: {
					line: 107,
					column: 1
				},
				end: {
					line: 111,
					column: 36
				}
			},
			'40': {
				start: {
					line: 108,
					column: 27
				},
				end: {
					line: 108,
					column: 73
				}
			},
			'41': {
				start: {
					line: 109,
					column: 2
				},
				end: {
					line: 109,
					column: 51
				}
			},
			'42': {
				start: {
					line: 110,
					column: 2
				},
				end: {
					line: 110,
					column: 85
				}
			},
			'43': {
				start: {
					line: 111,
					column: 19
				},
				end: {
					line: 111,
					column: 35
				}
			}
		},
		fnMap: {
			'0': {
				name: '(anonymous_0)',
				decl: {
					start: {
						line: 19,
						column: 34
					},
					end: {
						line: 19,
						column: 35
					}
				},
				loc: {
					start: {
						line: 19,
						column: 49
					},
					end: {
						line: 19,
						column: 126
					}
				},
				line: 19
			},
			'1': {
				name: '(anonymous_1)',
				decl: {
					start: {
						line: 22,
						column: 24
					},
					end: {
						line: 22,
						column: 25
					}
				},
				loc: {
					start: {
						line: 22,
						column: 60
					},
					end: {
						line: 58,
						column: 1
					}
				},
				line: 22
			},
			'2': {
				name: '(anonymous_2)',
				decl: {
					start: {
						line: 61,
						column: 1
					},
					end: {
						line: 61,
						column: 2
					}
				},
				loc: {
					start: {
						line: 61,
						column: 39
					},
					end: {
						line: 64,
						column: 2
					}
				},
				line: 61
			},
			'3': {
				name: '(anonymous_3)',
				decl: {
					start: {
						line: 66,
						column: 1
					},
					end: {
						line: 66,
						column: 2
					}
				},
				loc: {
					start: {
						line: 66,
						column: 37
					},
					end: {
						line: 84,
						column: 2
					}
				},
				line: 66
			},
			'4': {
				name: '(anonymous_4)',
				decl: {
					start: {
						line: 69,
						column: 21
					},
					end: {
						line: 69,
						column: 22
					}
				},
				loc: {
					start: {
						line: 69,
						column: 41
					},
					end: {
						line: 83,
						column: 3
					}
				},
				line: 69
			},
			'5': {
				name: '(anonymous_5)',
				decl: {
					start: {
						line: 71,
						column: 17
					},
					end: {
						line: 71,
						column: 18
					}
				},
				loc: {
					start: {
						line: 71,
						column: 33
					},
					end: {
						line: 79,
						column: 5
					}
				},
				line: 71
			},
			'6': {
				name: '(anonymous_6)',
				decl: {
					start: {
						line: 86,
						column: 1
					},
					end: {
						line: 86,
						column: 2
					}
				},
				loc: {
					start: {
						line: 86,
						column: 54
					},
					end: {
						line: 92,
						column: 2
					}
				},
				line: 86
			},
			'7': {
				name: '(anonymous_7)',
				decl: {
					start: {
						line: 95,
						column: 39
					},
					end: {
						line: 95,
						column: 40
					}
				},
				loc: {
					start: {
						line: 95,
						column: 51
					},
					end: {
						line: 112,
						column: 1
					}
				},
				line: 95
			},
			'8': {
				name: '(anonymous_8)',
				decl: {
					start: {
						line: 107,
						column: 77
					},
					end: {
						line: 107,
						column: 78
					}
				},
				loc: {
					start: {
						line: 107,
						column: 89
					},
					end: {
						line: 111,
						column: 2
					}
				},
				line: 107
			},
			'9': {
				name: '(anonymous_9)',
				decl: {
					start: {
						line: 111,
						column: 10
					},
					end: {
						line: 111,
						column: 11
					}
				},
				loc: {
					start: {
						line: 111,
						column: 19
					},
					end: {
						line: 111,
						column: 35
					}
				},
				line: 111
			}
		},
		branchMap: {
			'0': {
				loc: {
					start: {
						line: 18,
						column: 18
					},
					end: {
						line: 18,
						column: 42
					}
				},
				type: 'binary-expr',
				locations: [{
					start: {
						line: 18,
						column: 18
					},
					end: {
						line: 18,
						column: 33
					}
				}, {
					start: {
						line: 18,
						column: 37
					},
					end: {
						line: 18,
						column: 42
					}
				}],
				line: 18
			},
			'1': {
				loc: {
					start: {
						line: 19,
						column: 49
					},
					end: {
						line: 19,
						column: 126
					}
				},
				type: 'cond-expr',
				locations: [{
					start: {
						line: 19,
						column: 81
					},
					end: {
						line: 19,
						column: 114
					}
				}, {
					start: {
						line: 19,
						column: 117
					},
					end: {
						line: 19,
						column: 126
					}
				}],
				line: 19
			},
			'2': {
				loc: {
					start: {
						line: 24,
						column: 1
					},
					end: {
						line: 56,
						column: 2
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 24,
						column: 1
					},
					end: {
						line: 56,
						column: 2
					}
				}, {
					start: {
						line: 24,
						column: 1
					},
					end: {
						line: 56,
						column: 2
					}
				}],
				line: 24
			},
			'3': {
				loc: {
					start: {
						line: 72,
						column: 5
					},
					end: {
						line: 72,
						column: 25
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 72,
						column: 5
					},
					end: {
						line: 72,
						column: 25
					}
				}, {
					start: {
						line: 72,
						column: 5
					},
					end: {
						line: 72,
						column: 25
					}
				}],
				line: 72
			},
			'4': {
				loc: {
					start: {
						line: 98,
						column: 1
					},
					end: {
						line: 102,
						column: 2
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 98,
						column: 1
					},
					end: {
						line: 102,
						column: 2
					}
				}, {
					start: {
						line: 98,
						column: 1
					},
					end: {
						line: 102,
						column: 2
					}
				}],
				line: 98
			}
		},
		s: {
			'0': 0,
			'1': 0,
			'2': 0,
			'3': 0,
			'4': 0,
			'5': 0,
			'6': 0,
			'7': 0,
			'8': 0,
			'9': 0,
			'10': 0,
			'11': 0,
			'12': 0,
			'13': 0,
			'14': 0,
			'15': 0,
			'16': 0,
			'17': 0,
			'18': 0,
			'19': 0,
			'20': 0,
			'21': 0,
			'22': 0,
			'23': 0,
			'24': 0,
			'25': 0,
			'26': 0,
			'27': 0,
			'28': 0,
			'29': 0,
			'30': 0,
			'31': 0,
			'32': 0,
			'33': 0,
			'34': 0,
			'35': 0,
			'36': 0,
			'37': 0,
			'38': 0,
			'39': 0,
			'40': 0,
			'41': 0,
			'42': 0,
			'43': 0
		},
		f: {
			'0': 0,
			'1': 0,
			'2': 0,
			'3': 0,
			'4': 0,
			'5': 0,
			'6': 0,
			'7': 0,
			'8': 0,
			'9': 0
		},
		b: {
			'0': [0, 0],
			'1': [0, 0],
			'2': [0, 0],
			'3': [0, 0],
			'4': [0, 0]
		},
		_coverageSchema: 'd34fc3e6b8297bcde183f5492bcb8fcb36775295'
	},
	    coverage = global[gcv] || (global[gcv] = {});

	if (coverage[path] && coverage[path].hash === hash) {
		return coverage[path];
	}

	coverageData.hash = hash;
	return coverage[path] = coverageData;
}();

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.FFLWebpackCompiler = undefined;

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _webpack = require('webpack');

var _webpack2 = _interopRequireDefault(_webpack);

var _fs = require('fs');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _memoryFs = require('memory-fs');

var _memoryFs2 = _interopRequireDefault(_memoryFs);

var _ExcelApi = require('./ExcelApi');

var _ExcelApi2 = _interopRequireDefault(_ExcelApi);

var _SolutionFacade = require('../../lme-core/src/SolutionFacade');

var _SolutionFacade2 = _interopRequireDefault(_SolutionFacade);

var _lme = require('./lme');

var _log = require('log6');

var _CustomImport = require('../../lme-core/resources/CustomImport');

var _CustomImport2 = _interopRequireDefault(_CustomImport);

var _Context = require('../../lme-core/src/Context');

var _Constants = require('../../lme-core/src/Constants');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/** Combine workspace into a REST-API js **/
var fileType = (cov_27zmzsia0m.s[0]++, '.ffl');
var compilers = (cov_27zmzsia0m.s[1]++, {});
var javascript_filename = (cov_27zmzsia0m.s[2]++, 'frontend.js');
var resources_folder = (cov_27zmzsia0m.s[3]++, _path2.default.join(__dirname, '/../../git-connect/resources/'));
var modelName = (cov_27zmzsia0m.s[4]++, (cov_27zmzsia0m.b[0][0]++, process.argv[2]) || (cov_27zmzsia0m.b[0][1]++, 'KSP'));
cov_27zmzsia0m.s[5]++;
var excel_file_name_quick_fix = function excel_file_name_quick_fix(modelName) {
	cov_27zmzsia0m.f[0]++;
	cov_27zmzsia0m.s[6]++;
	return modelName.startsWith('_tmp_') ? (cov_27zmzsia0m.b[1][0]++, modelName.split('_').slice(-1)[0]) : (cov_27zmzsia0m.b[1][1]++, modelName);
};
var xlsx_name = (cov_27zmzsia0m.s[7]++, excel_file_name_quick_fix(modelName));

cov_27zmzsia0m.s[8]++;
var resolveCompiler = function resolveCompiler(memory_fs, filename, json_data) {
	cov_27zmzsia0m.f[1]++;

	var compiler = (cov_27zmzsia0m.s[9]++, compilers[filename]);
	cov_27zmzsia0m.s[10]++;
	if (!compiler) {
		cov_27zmzsia0m.b[2][0]++;
		cov_27zmzsia0m.s[11]++;

		compiler = (0, _webpack2.default)({
			entry: [_path2.default.resolve(__dirname, filename)],
			mode: 'development',
			target: 'web',
			node: {
				fs: 'empty',
				child_process: 'empty'
			},
			output: {
				path: __dirname,
				filename: javascript_filename
			},
			module: {
				rules: [{
					test: /\.js$/,
					include: [_path2.default.join(__dirname, 'client')],
					loader: 'babel-loader'
				}]
			},
			plugins: [new _webpack2.default.NamedModulesPlugin(), new _webpack2.default.NoEmitOnErrorsPlugin(), new _webpack2.default.optimize.OccurrenceOrderPlugin(), new _webpack2.default.DefinePlugin({
				'global.JSON_MODEL': json_data
			})],
			devtool: 'inline-source-map'
		});
		cov_27zmzsia0m.s[12]++;
		compiler.outputFileSystem = memory_fs;
		cov_27zmzsia0m.s[13]++;
		compilers[filename] = compiler;
	} else {
		cov_27zmzsia0m.b[2][1]++;
	}
	cov_27zmzsia0m.s[14]++;
	return compilers[filename];
};

var FFLWebpackCompiler = exports.FFLWebpackCompiler = function () {
	function FFLWebpackCompiler(_ref) {
		var memory_fs = _ref.memory_fs,
		    json_data = _ref.json_data;
		(0, _classCallCheck3.default)(this, FFLWebpackCompiler);
		cov_27zmzsia0m.f[2]++;
		cov_27zmzsia0m.s[15]++;

		this.memory_fs = memory_fs;
		cov_27zmzsia0m.s[16]++;
		this.json_data = json_data;
	}

	(0, _createClass3.default)(FFLWebpackCompiler, [{
		key: 'buildProductionFile',
		value: function () {
			var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(filename) {
				var memory_fs, compiler;
				return _regenerator2.default.wrap(function _callee$(_context) {
					while (1) {
						switch (_context.prev = _context.next) {
							case 0:
								cov_27zmzsia0m.f[3]++;
								memory_fs = (cov_27zmzsia0m.s[17]++, this.memory_fs);
								compiler = (cov_27zmzsia0m.s[18]++, resolveCompiler(memory_fs, filename, this.json_data));
								cov_27zmzsia0m.s[19]++;
								return _context.abrupt('return', new Promise(function (accept, reject) {
									cov_27zmzsia0m.f[4]++;
									cov_27zmzsia0m.s[20]++;

									try {
										cov_27zmzsia0m.s[21]++;

										compiler.run(function (err, stats) {
											cov_27zmzsia0m.f[5]++;
											cov_27zmzsia0m.s[22]++;

											if (err) {
													cov_27zmzsia0m.b[3][0]++;
													cov_27zmzsia0m.s[23]++;
													reject(err);
												} else {
												cov_27zmzsia0m.b[3][1]++;
											}cov_27zmzsia0m.s[24]++;
											accept(stats.toString({
												aggregateTimeout: 300,
												poll: undefined,
												chunks: false, // Makes the build much quieter
												colors: true // Shows colors in the console
											}));
										});
									} catch (err) {
										cov_27zmzsia0m.s[25]++;

										reject(err);
									}
								}));

							case 5:
							case 'end':
								return _context.stop();
						}
					}
				}, _callee, this);
			}));

			function buildProductionFile(_x) {
				return _ref2.apply(this, arguments);
			}

			return buildProductionFile;
		}()
	}], [{
		key: 'readProductionFile',
		value: function () {
			var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(filename, json_data) {
				var memory_fs, webpackCompiler, stats;
				return _regenerator2.default.wrap(function _callee2$(_context2) {
					while (1) {
						switch (_context2.prev = _context2.next) {
							case 0:
								cov_27zmzsia0m.f[6]++;
								memory_fs = (cov_27zmzsia0m.s[26]++, new _memoryFs2.default());
								webpackCompiler = (cov_27zmzsia0m.s[27]++, new FFLWebpackCompiler({ memory_fs: memory_fs, json_data: json_data }));
								cov_27zmzsia0m.s[28]++;
								_context2.next = 6;
								return webpackCompiler.buildProductionFile(filename);

							case 6:
								stats = _context2.sent;
								cov_27zmzsia0m.s[29]++;

								console.info(stats);
								cov_27zmzsia0m.s[30]++;
								return _context2.abrupt('return', memory_fs.readFileSync(_path2.default.join(__dirname, javascript_filename), _Constants.ENCODING));

							case 11:
							case 'end':
								return _context2.stop();
						}
					}
				}, _callee2, this);
			}));

			function readProductionFile(_x2, _x3) {
				return _ref3.apply(this, arguments);
			}

			return readProductionFile;
		}()
	}]);
	return FFLWebpackCompiler;
}();

cov_27zmzsia0m.s[31]++;


_ExcelApi2.default.loadExcelFile(xlsx_name).then(function (matrix) {
	cov_27zmzsia0m.f[7]++;
	cov_27zmzsia0m.s[32]++;

	_SolutionFacade2.default.addVariables([{ name: 'MATRIX_VALUES', expression: matrix }]);
	var LME = void 0;
	cov_27zmzsia0m.s[33]++;
	if (modelName.includes('SCORECARDTESTMODEL')) {
		cov_27zmzsia0m.b[4][0]++;
		cov_27zmzsia0m.s[34]++;

		LME = new _lme.LmeAPI(_CustomImport2.default, new _Context.Context({ modelName: modelName }), _Constants.DETAIL_INTERVAL);
	} else {
		cov_27zmzsia0m.b[4][1]++;
		cov_27zmzsia0m.s[35]++;

		LME = new _lme.LmeAPI(null, new _Context.Context({ modelName: modelName }), null);
	}
	var rawData = (cov_27zmzsia0m.s[36]++, (0, _fs.readFileSync)('' + resources_folder + modelName + fileType, _Constants.ENCODING));
	cov_27zmzsia0m.s[37]++;
	LME.importFFL(rawData);
	var json_data = (cov_27zmzsia0m.s[38]++, LME.exportLME());

	cov_27zmzsia0m.s[39]++;
	FFLWebpackCompiler.readProductionFile('./lmeAPIWrapper.js', json_data).then(function (source) {
		cov_27zmzsia0m.f[8]++;

		var destination_path = (cov_27zmzsia0m.s[40]++, _path2.default.join(resources_folder, modelName + '.js'));
		cov_27zmzsia0m.s[41]++;
		(0, _fs.createWriteStream)(destination_path).write(source);
		cov_27zmzsia0m.s[42]++;
		(0, _log.info)('Done writing executable file to ' + destination_path + ' size: ' + source.length + ' ');
	}).catch(function (err) {
		cov_27zmzsia0m.f[9]++;
		cov_27zmzsia0m.s[43]++;
		return (0, _log.error)(err.stack);
	});
});