'use strict';

var cov_27zmzsia0m = function () {
	var path = 'C:\\Users\\michael\\Documents\\lme\\lme-model-api\\src\\FFLWebpackConverter.js',
	    hash = '26feb2ae87b315f58b23ad453f6ce2376edb0f69',
	    Function = function () {}.constructor,
	    global = new Function('return this')(),
	    gcv = '__coverage__',
	    coverageData = {
		path: 'C:\\Users\\michael\\Documents\\lme\\lme-model-api\\src\\FFLWebpackConverter.js',
		statementMap: {
			'0': {
				start: {
					line: 14,
					column: 18
				},
				end: {
					line: 14,
					column: 20
				}
			},
			'1': {
				start: {
					line: 15,
					column: 28
				},
				end: {
					line: 15,
					column: 41
				}
			},
			'2': {
				start: {
					line: 16,
					column: 19
				},
				end: {
					line: 16,
					column: 43
				}
			},
			'3': {
				start: {
					line: 17,
					column: 34
				},
				end: {
					line: 17,
					column: 126
				}
			},
			'4': {
				start: {
					line: 17,
					column: 49
				},
				end: {
					line: 17,
					column: 126
				}
			},
			'5': {
				start: {
					line: 18,
					column: 18
				},
				end: {
					line: 18,
					column: 55
				}
			},
			'6': {
				start: {
					line: 20,
					column: 24
				},
				end: {
					line: 63,
					column: 1
				}
			},
			'7': {
				start: {
					line: 21,
					column: 16
				},
				end: {
					line: 21,
					column: 35
				}
			},
			'8': {
				start: {
					line: 23,
					column: 1
				},
				end: {
					line: 61,
					column: 2
				}
			},
			'9': {
				start: {
					line: 24,
					column: 2
				},
				end: {
					line: 58,
					column: 4
				}
			},
			'10': {
				start: {
					line: 59,
					column: 2
				},
				end: {
					line: 59,
					column: 39
				}
			},
			'11': {
				start: {
					line: 60,
					column: 2
				},
				end: {
					line: 60,
					column: 32
				}
			},
			'12': {
				start: {
					line: 62,
					column: 1
				},
				end: {
					line: 62,
					column: 27
				}
			},
			'13': {
				start: {
					line: 67,
					column: 2
				},
				end: {
					line: 67,
					column: 28
				}
			},
			'14': {
				start: {
					line: 68,
					column: 2
				},
				end: {
					line: 68,
					column: 28
				}
			},
			'15': {
				start: {
					line: 72,
					column: 20
				},
				end: {
					line: 72,
					column: 34
				}
			},
			'16': {
				start: {
					line: 73,
					column: 19
				},
				end: {
					line: 73,
					column: 71
				}
			},
			'17': {
				start: {
					line: 74,
					column: 2
				},
				end: {
					line: 88,
					column: 4
				}
			},
			'18': {
				start: {
					line: 75,
					column: 3
				},
				end: {
					line: 87,
					column: 4
				}
			},
			'19': {
				start: {
					line: 76,
					column: 4
				},
				end: {
					line: 84,
					column: 6
				}
			},
			'20': {
				start: {
					line: 77,
					column: 5
				},
				end: {
					line: 77,
					column: 25
				}
			},
			'21': {
				start: {
					line: 77,
					column: 14
				},
				end: {
					line: 77,
					column: 25
				}
			},
			'22': {
				start: {
					line: 78,
					column: 5
				},
				end: {
					line: 83,
					column: 8
				}
			},
			'23': {
				start: {
					line: 86,
					column: 4
				},
				end: {
					line: 86,
					column: 15
				}
			},
			'24': {
				start: {
					line: 92,
					column: 20
				},
				end: {
					line: 92,
					column: 32
				}
			},
			'25': {
				start: {
					line: 93,
					column: 26
				},
				end: {
					line: 93,
					column: 74
				}
			},
			'26': {
				start: {
					line: 94,
					column: 2
				},
				end: {
					line: 94,
					column: 53
				}
			},
			'27': {
				start: {
					line: 95,
					column: 2
				},
				end: {
					line: 95,
					column: 84
				}
			},
			'28': {
				start: {
					line: 99,
					column: 0
				},
				end: {
					line: 122,
					column: 2
				}
			},
			'29': {
				start: {
					line: 100,
					column: 1
				},
				end: {
					line: 100,
					column: 77
				}
			},
			'30': {
				start: {
					line: 102,
					column: 1
				},
				end: {
					line: 106,
					column: 2
				}
			},
			'31': {
				start: {
					line: 103,
					column: 2
				},
				end: {
					line: 103,
					column: 86
				}
			},
			'32': {
				start: {
					line: 105,
					column: 2
				},
				end: {
					line: 105,
					column: 70
				}
			},
			'33': {
				start: {
					line: 107,
					column: 17
				},
				end: {
					line: 107,
					column: 50
				}
			},
			'34': {
				start: {
					line: 108,
					column: 1
				},
				end: {
					line: 108,
					column: 23
				}
			},
			'35': {
				start: {
					line: 109,
					column: 19
				},
				end: {
					line: 109,
					column: 34
				}
			},
			'36': {
				start: {
					line: 111,
					column: 1
				},
				end: {
					line: 118,
					column: 2
				}
			},
			'37': {
				start: {
					line: 112,
					column: 17
				},
				end: {
					line: 112,
					column: 93
				}
			},
			'38': {
				start: {
					line: 113,
					column: 2
				},
				end: {
					line: 113,
					column: 59
				}
			},
			'39': {
				start: {
					line: 114,
					column: 2
				},
				end: {
					line: 114,
					column: 79
				}
			},
			'40': {
				start: {
					line: 116,
					column: 2
				},
				end: {
					line: 116,
					column: 77
				}
			},
			'41': {
				start: {
					line: 117,
					column: 2
				},
				end: {
					line: 117,
					column: 18
				}
			},
			'42': {
				start: {
					line: 120,
					column: 1
				},
				end: {
					line: 120,
					column: 55
				}
			},
			'43': {
				start: {
					line: 121,
					column: 1
				},
				end: {
					line: 121,
					column: 17
				}
			}
		},
		fnMap: {
			'0': {
				name: '(anonymous_0)',
				decl: {
					start: {
						line: 17,
						column: 34
					},
					end: {
						line: 17,
						column: 35
					}
				},
				loc: {
					start: {
						line: 17,
						column: 49
					},
					end: {
						line: 17,
						column: 126
					}
				},
				line: 17
			},
			'1': {
				name: '(anonymous_1)',
				decl: {
					start: {
						line: 20,
						column: 24
					},
					end: {
						line: 20,
						column: 25
					}
				},
				loc: {
					start: {
						line: 20,
						column: 60
					},
					end: {
						line: 63,
						column: 1
					}
				},
				line: 20
			},
			'2': {
				name: '(anonymous_2)',
				decl: {
					start: {
						line: 66,
						column: 1
					},
					end: {
						line: 66,
						column: 2
					}
				},
				loc: {
					start: {
						line: 66,
						column: 39
					},
					end: {
						line: 69,
						column: 2
					}
				},
				line: 66
			},
			'3': {
				name: '(anonymous_3)',
				decl: {
					start: {
						line: 71,
						column: 1
					},
					end: {
						line: 71,
						column: 2
					}
				},
				loc: {
					start: {
						line: 71,
						column: 37
					},
					end: {
						line: 89,
						column: 2
					}
				},
				line: 71
			},
			'4': {
				name: '(anonymous_4)',
				decl: {
					start: {
						line: 74,
						column: 21
					},
					end: {
						line: 74,
						column: 22
					}
				},
				loc: {
					start: {
						line: 74,
						column: 41
					},
					end: {
						line: 88,
						column: 3
					}
				},
				line: 74
			},
			'5': {
				name: '(anonymous_5)',
				decl: {
					start: {
						line: 76,
						column: 17
					},
					end: {
						line: 76,
						column: 18
					}
				},
				loc: {
					start: {
						line: 76,
						column: 33
					},
					end: {
						line: 84,
						column: 5
					}
				},
				line: 76
			},
			'6': {
				name: '(anonymous_6)',
				decl: {
					start: {
						line: 91,
						column: 1
					},
					end: {
						line: 91,
						column: 2
					}
				},
				loc: {
					start: {
						line: 91,
						column: 54
					},
					end: {
						line: 96,
						column: 2
					}
				},
				line: 91
			},
			'7': {
				name: '(anonymous_7)',
				decl: {
					start: {
						line: 99,
						column: 39
					},
					end: {
						line: 99,
						column: 40
					}
				},
				loc: {
					start: {
						line: 99,
						column: 57
					},
					end: {
						line: 119,
						column: 1
					}
				},
				line: 99
			},
			'8': {
				name: '(anonymous_8)',
				decl: {
					start: {
						line: 119,
						column: 9
					},
					end: {
						line: 119,
						column: 10
					}
				},
				loc: {
					start: {
						line: 119,
						column: 16
					},
					end: {
						line: 122,
						column: 1
					}
				},
				line: 119
			}
		},
		branchMap: {
			'0': {
				loc: {
					start: {
						line: 16,
						column: 19
					},
					end: {
						line: 16,
						column: 43
					}
				},
				type: 'binary-expr',
				locations: [{
					start: {
						line: 16,
						column: 19
					},
					end: {
						line: 16,
						column: 34
					}
				}, {
					start: {
						line: 16,
						column: 38
					},
					end: {
						line: 16,
						column: 43
					}
				}],
				line: 16
			},
			'1': {
				loc: {
					start: {
						line: 17,
						column: 49
					},
					end: {
						line: 17,
						column: 126
					}
				},
				type: 'cond-expr',
				locations: [{
					start: {
						line: 17,
						column: 81
					},
					end: {
						line: 17,
						column: 114
					}
				}, {
					start: {
						line: 17,
						column: 117
					},
					end: {
						line: 17,
						column: 126
					}
				}],
				line: 17
			},
			'2': {
				loc: {
					start: {
						line: 23,
						column: 1
					},
					end: {
						line: 61,
						column: 2
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 23,
						column: 1
					},
					end: {
						line: 61,
						column: 2
					}
				}, {
					start: {
						line: 23,
						column: 1
					},
					end: {
						line: 61,
						column: 2
					}
				}],
				line: 23
			},
			'3': {
				loc: {
					start: {
						line: 77,
						column: 5
					},
					end: {
						line: 77,
						column: 25
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 77,
						column: 5
					},
					end: {
						line: 77,
						column: 25
					}
				}, {
					start: {
						line: 77,
						column: 5
					},
					end: {
						line: 77,
						column: 25
					}
				}],
				line: 77
			},
			'4': {
				loc: {
					start: {
						line: 102,
						column: 1
					},
					end: {
						line: 106,
						column: 2
					}
				},
				type: 'if',
				locations: [{
					start: {
						line: 102,
						column: 1
					},
					end: {
						line: 106,
						column: 2
					}
				}, {
					start: {
						line: 102,
						column: 1
					},
					end: {
						line: 106,
						column: 2
					}
				}],
				line: 102
			}
		},
		s: {
			'0': 0,
			'1': 0,
			'2': 0,
			'3': 0,
			'4': 0,
			'5': 0,
			'6': 0,
			'7': 0,
			'8': 0,
			'9': 0,
			'10': 0,
			'11': 0,
			'12': 0,
			'13': 0,
			'14': 0,
			'15': 0,
			'16': 0,
			'17': 0,
			'18': 0,
			'19': 0,
			'20': 0,
			'21': 0,
			'22': 0,
			'23': 0,
			'24': 0,
			'25': 0,
			'26': 0,
			'27': 0,
			'28': 0,
			'29': 0,
			'30': 0,
			'31': 0,
			'32': 0,
			'33': 0,
			'34': 0,
			'35': 0,
			'36': 0,
			'37': 0,
			'38': 0,
			'39': 0,
			'40': 0,
			'41': 0,
			'42': 0,
			'43': 0
		},
		f: {
			'0': 0,
			'1': 0,
			'2': 0,
			'3': 0,
			'4': 0,
			'5': 0,
			'6': 0,
			'7': 0,
			'8': 0
		},
		b: {
			'0': [0, 0],
			'1': [0, 0],
			'2': [0, 0],
			'3': [0, 0],
			'4': [0, 0]
		},
		_coverageSchema: '43e27e138ebf9cfc5966b082cf9a028302ed4184'
	},
	    coverage = global[gcv] || (global[gcv] = {});

	if (coverage[path] && coverage[path].hash === hash) {
		return coverage[path];
	}

	coverageData.hash = hash;
	return coverage[path] = coverageData;
}();

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.FFLWebpackCompiler = undefined;

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _webpack = require('webpack');

var _webpack2 = _interopRequireDefault(_webpack);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _memoryFs = require('memory-fs');

var _memoryFs2 = _interopRequireDefault(_memoryFs);

var _ExcelApi = require('./ExcelApi');

var _ExcelApi2 = _interopRequireDefault(_ExcelApi);

var _SolutionFacade = require('../../lme-core/src/SolutionFacade');

var _SolutionFacade2 = _interopRequireDefault(_SolutionFacade);

var _lme = require('./lme');

var _log = require('log6');

var _CustomImport = require('../../lme-core/resources/CustomImport');

var _CustomImport2 = _interopRequireDefault(_CustomImport);

var _Context = require('../../lme-core/src/Context');

var _Constants = require('../../lme-core/src/Constants');

var _ResourceManager = require('../../git-connect/ResourceManager');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/** Combine workspace into a REST-API js **/
var compilers = (cov_27zmzsia0m.s[0]++, {});
var javascript_filename = (cov_27zmzsia0m.s[1]++, 'frontend.js');
var model_name = (cov_27zmzsia0m.s[2]++, (cov_27zmzsia0m.b[0][0]++, process.argv[2]) || (cov_27zmzsia0m.b[0][1]++, 'KSP'));
cov_27zmzsia0m.s[3]++;
var excel_file_name_quick_fix = function excel_file_name_quick_fix(modelName) {
	cov_27zmzsia0m.f[0]++;
	cov_27zmzsia0m.s[4]++;
	return modelName.startsWith('_tmp_') ? (cov_27zmzsia0m.b[1][0]++, modelName.split('_').slice(-1)[0]) : (cov_27zmzsia0m.b[1][1]++, modelName);
};
var xlsx_name = (cov_27zmzsia0m.s[5]++, excel_file_name_quick_fix(model_name));

cov_27zmzsia0m.s[6]++;
var resolveCompiler = function resolveCompiler(memory_fs, filename, json_data) {
	cov_27zmzsia0m.f[1]++;

	var compiler = (cov_27zmzsia0m.s[7]++, compilers[filename]);
	//let b = browser(options).ignore('escodegen').ignore('esprima').ignore('log6').ignore('tracer').ignore('ast-node-utils').ignore('*ast-node-utils*')
	cov_27zmzsia0m.s[8]++;
	if (!compiler) {
		cov_27zmzsia0m.b[2][0]++;
		cov_27zmzsia0m.s[9]++;

		compiler = (0, _webpack2.default)({
			entry: [_path2.default.resolve(__dirname, filename)],
			mode: 'development',
			target: 'web',
			node: {
				fs: 'empty',
				escodegen: 'empty',
				log6: 'empty',
				esprima: 'empty',
				child_process: 'empty'
			},
			output: {
				path: __dirname,
				filename: javascript_filename
			},
			module: {
				rules: [{
					test: /\.js$/,
					include: [_path2.default.join(__dirname, 'client')],
					loader: 'babel-loader'
				}]
			},
			plugins: [new _webpack2.default.NamedModulesPlugin(), new _webpack2.default.NoEmitOnErrorsPlugin(), new _webpack2.default.optimize.OccurrenceOrderPlugin(), new _webpack2.default.DefinePlugin({
				'global.JSON_MODEL': json_data
			})
			/*new webpack.IgnorePlugin(/esprima/)*/
			/*new webpack.IgnorePlugin(/escodegen/),*/
			/*new webpack.IgnorePlugin(/log6/)*/
			],
			devtool: 'none'
		});
		cov_27zmzsia0m.s[10]++;
		compiler.outputFileSystem = memory_fs;
		cov_27zmzsia0m.s[11]++;
		compilers[filename] = compiler;
	} else {
		cov_27zmzsia0m.b[2][1]++;
	}
	cov_27zmzsia0m.s[12]++;
	return compilers[filename];
};

var FFLWebpackCompiler = exports.FFLWebpackCompiler = function () {
	function FFLWebpackCompiler(_ref) {
		var memory_fs = _ref.memory_fs,
		    json_data = _ref.json_data;
		(0, _classCallCheck3.default)(this, FFLWebpackCompiler);
		cov_27zmzsia0m.f[2]++;
		cov_27zmzsia0m.s[13]++;

		this.memory_fs = memory_fs;
		cov_27zmzsia0m.s[14]++;
		this.json_data = json_data;
	}

	(0, _createClass3.default)(FFLWebpackCompiler, [{
		key: 'buildProductionFile',
		value: function () {
			var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(filename) {
				var memory_fs, compiler;
				return _regenerator2.default.wrap(function _callee$(_context) {
					while (1) {
						switch (_context.prev = _context.next) {
							case 0:
								cov_27zmzsia0m.f[3]++;
								memory_fs = (cov_27zmzsia0m.s[15]++, this.memory_fs);
								compiler = (cov_27zmzsia0m.s[16]++, resolveCompiler(memory_fs, filename, this.json_data));
								cov_27zmzsia0m.s[17]++;
								return _context.abrupt('return', new Promise(function (accept, reject) {
									cov_27zmzsia0m.f[4]++;
									cov_27zmzsia0m.s[18]++;

									try {
										cov_27zmzsia0m.s[19]++;

										compiler.run(function (err, stats) {
											cov_27zmzsia0m.f[5]++;
											cov_27zmzsia0m.s[20]++;

											if (err) {
													cov_27zmzsia0m.b[3][0]++;
													cov_27zmzsia0m.s[21]++;
													reject(err);
												} else {
												cov_27zmzsia0m.b[3][1]++;
											}cov_27zmzsia0m.s[22]++;
											accept(stats.toString({
												aggregateTimeout: 300,
												poll: undefined,
												chunks: false, // Makes the build much quieter
												colors: true // Shows colors in the console
											}));
										});
									} catch (err) {
										cov_27zmzsia0m.s[23]++;

										reject(err);
									}
								}));

							case 5:
							case 'end':
								return _context.stop();
						}
					}
				}, _callee, this);
			}));

			function buildProductionFile(_x) {
				return _ref2.apply(this, arguments);
			}

			return buildProductionFile;
		}()
	}], [{
		key: 'readProductionFile',
		value: function () {
			var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(filename, json_data) {
				var memory_fs, webpackCompiler;
				return _regenerator2.default.wrap(function _callee2$(_context2) {
					while (1) {
						switch (_context2.prev = _context2.next) {
							case 0:
								cov_27zmzsia0m.f[6]++;
								memory_fs = (cov_27zmzsia0m.s[24]++, new _memoryFs2.default());
								webpackCompiler = (cov_27zmzsia0m.s[25]++, new FFLWebpackCompiler({ memory_fs: memory_fs, json_data: json_data }));
								cov_27zmzsia0m.s[26]++;
								_context2.next = 6;
								return webpackCompiler.buildProductionFile(filename);

							case 6:
								cov_27zmzsia0m.s[27]++;
								return _context2.abrupt('return', memory_fs.readFileSync(_path2.default.join(__dirname, javascript_filename), _Constants.ENCODING));

							case 8:
							case 'end':
								return _context2.stop();
						}
					}
				}, _callee2, this);
			}));

			function readProductionFile(_x2, _x3) {
				return _ref3.apply(this, arguments);
			}

			return readProductionFile;
		}()
	}]);
	return FFLWebpackCompiler;
}();

cov_27zmzsia0m.s[28]++;


_ExcelApi2.default.loadExcelFile(xlsx_name).then(function () {
	var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(matrix) {
		var LME, rawData, json_data, source;
		return _regenerator2.default.wrap(function _callee3$(_context3) {
			while (1) {
				switch (_context3.prev = _context3.next) {
					case 0:
						cov_27zmzsia0m.f[7]++;
						cov_27zmzsia0m.s[29]++;

						_SolutionFacade2.default.addVariables([{ name: 'MATRIX_VALUES', expression: matrix }]);
						LME = void 0;
						cov_27zmzsia0m.s[30]++;

						if (model_name.includes('SCORECARDTESTMODEL')) {
							cov_27zmzsia0m.b[4][0]++;
							cov_27zmzsia0m.s[31]++;

							LME = new _lme.LmeAPI(_CustomImport2.default, new _Context.Context({ modelName: model_name }), _Constants.DETAIL_INTERVAL);
						} else {
							cov_27zmzsia0m.b[4][1]++;
							cov_27zmzsia0m.s[32]++;

							LME = new _lme.LmeAPI(null, new _Context.Context({ modelName: model_name }), null);
						}
						rawData = (cov_27zmzsia0m.s[33]++, (0, _ResourceManager.readModelAsString)({ model_name: model_name }));
						cov_27zmzsia0m.s[34]++;

						LME.importFFL(rawData);
						json_data = (cov_27zmzsia0m.s[35]++, LME.exportLME());
						cov_27zmzsia0m.s[36]++;
						_context3.prev = 11;
						cov_27zmzsia0m.s[37]++;
						_context3.next = 15;
						return FFLWebpackCompiler.readProductionFile('./lmeAPIWrapper.js', json_data);

					case 15:
						source = _context3.sent;
						cov_27zmzsia0m.s[38]++;

						(0, _ResourceManager.createJavascriptWriteStream)({ model_name: model_name }).write(source);
						cov_27zmzsia0m.s[39]++;
						(0, _log.info)('Done writing executable file to ' + model_name + ' size: ' + source.length + ' ');
						_context3.next = 28;
						break;

					case 22:
						_context3.prev = 22;
						_context3.t0 = _context3['catch'](11);
						cov_27zmzsia0m.s[40]++;

						(0, _log.error)('Problems while combining ffl into executable with frontend wrapper');
						cov_27zmzsia0m.s[41]++;
						(0, _log.error)(_context3.t0.stack);

					case 28:
					case 'end':
						return _context3.stop();
				}
			}
		}, _callee3, undefined, [[11, 22]]);
	}));

	return function (_x4) {
		return _ref4.apply(this, arguments);
	};
}()).catch(function (err) {
	cov_27zmzsia0m.f[8]++;
	cov_27zmzsia0m.s[42]++;

	(0, _log.error)('Problems while converting ffl into executable');
	cov_27zmzsia0m.s[43]++;
	(0, _log.error)(err.stack);
});