<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">ffl/FinFormula.js | ffl-pack</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="core package converting ffl"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="ffl-pack"><meta property="twitter:description" content="core package converting ffl"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/DeltaCompareRegister.js~DeltaCompareRegister.html">DeltaCompareRegister</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/Register.js~Register.html">Register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/RegisterToJSON.js~RegisterToJSON.html">RegisterToJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-FinFormula">FinFormula</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RegisterToFFL">RegisterToFFL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">ffl/FinFormula.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">//http://excelformulabeautifier.com/
function finFormulaGeneric(buf) {
	/**
	 * Choices fix, this is a problem for titles and hints containing &quot;:&quot; chars.
	 * TODO: move to choice specific logic.
	 */
	var buf = buf.replace(/:/gm, &apos;, &apos;)
	buf = buf.replace(/(\$p|@|#|%|\.\.)/gmi, &apos;&apos;)

	//temp case fix, &lt;= lt,gt,lte,gte from Cases,
	buf = buf.replace(/\[\&lt;\=/gm, &apos;[Infinity&lt;=&apos;)
	buf = buf.replace(/\[\&lt;/gm, &apos;[Infinity&lt;&apos;)
	buf = buf.replace(/\|\&lt;/gm, &apos;&lt;&apos;)
	buf = buf.replace(/\[\=/gm, &apos;[&apos;)
	buf = buf.replace(/\|\&lt;\=/gm, &apos;&lt;=&apos;)
	buf = buf.replace(/\|\=/gm, &apos;=&apos;)
	buf = buf.replace(/\|\&gt;\=/gm, &apos;&gt;=&apos;)
	buf = buf.replace(/\|\&gt;/gm, &apos;&gt;&apos;)
	//end temp case fix

	/**
	 * Here are all time references
	 the same as hasAnyValue? HasValue(var) ?
	 */
	buf = buf.replace(/\(FirstValueT\((\w+),1,MaxT\)&gt;0\)/gi, &apos;AnyDataAvailable($1)&apos;)//regular test for any data entered
	buf = buf.replace(/FormulaSetInT\(GetT\(T\,-1\)\)&lt;&gt;NoTrend/gi, &apos;!x.isprevnotrend&apos;)

	buf = buf.replace(/LastTinYear\(FirstTinFormulaSet\(Trend,\s*(\w+|\d+)\)\)/gi, &apos;x.firsttrend.lastbkyr&apos;)
	buf = buf.replace(/FirstTInFormulaset\(NoTrend\)/gi, &apos;x.firstnotrend&apos;)
	buf = buf.replace(/FirstTInFormulaset\(Trend\)/gi, &apos;x.firsttrend&apos;)
	buf = buf.replace(/FirstTinFormulaSet\(NoTrend,\s*(\w+|\d+)\)/gi, &apos;x.firstnotrend&apos;)
	buf = buf.replace(/FirstTinFormulaSet\(Trend,\s*(\w+|\d+)\)/gi, &apos;x.firsttrend&apos;)

	buf = buf.replace(/LastTinFormulaSet\(NoTrend\)/gi, &apos;x.lastnotrend&apos;)
	buf = buf.replace(/LastTinFormulaSet\(Trend\)/gi, &apos;x.lasttrend&apos;)
	buf = buf.replace(/LastTinFormulaSet\(NoTrend,\s*(\w+|\d+)\)/gi, &apos;x.lastnotrend&apos;)
	buf = buf.replace(/LastTinFormulaSet\(Trend,\s*(\w+|\d+)\)/gi, &apos;x.lasttrend&apos;)
	// buf = buf.replace(/LastTinFormulaSet\(NoTrend,PeriodInT\)/gi, &apos;x.lastnotrend&apos;);

	buf = buf.replace(/FormulaSetInT\(LastTinPeriod\)/gi, &apos;x.lastinperiod&apos;)
	buf = buf.replace(/FormulaSetInT\(FirstTinPeriod\)/gi, &apos;x.firstinperiod&apos;)

	buf = buf.replace(/\[LastTinPeriod\(PeriodInT\)]/gi, &apos;[lastinperiod]&apos;)
	buf = buf.replace(/\LastTinPeriod\(PeriodInT\)/gi, &apos;x.lastinperiod&apos;)
	buf = buf.replace(/LastTinYear\(T-TsY\)/gi, &apos;x.prevbkyear&apos;)

	buf = buf.replace(/\[1]/g, &apos;[doc]&apos;)
	buf = buf.replace(/\[T]/g, &apos;&apos;) //Variable[T] is the same as Variable, its always in default to the corresponding time.
	buf = buf.replace(/\[GetT\(T,-1\)]/gi, &apos;[prev]&apos;) //Variable[T] is the same as Variable, its always in default to the corresponding time.
	buf = buf.replace(/\[LastT\]/gi, &apos;[lastinperiod]&apos;)
	//(FormulaSetInT(GetT(T,-1))&lt;&gt;NoTrend) ==&gt;  !x.prev.isnotrend
	buf = buf.replace(/ValueT\(1\)/gi, &apos;x.firstdetail&apos;)
	buf = buf.replace(/GetT\(T,-TsY,0,TsY\)/gi, &apos;x.prevbkyr&apos;)
	buf = buf.replace(/GetT\(T,-1\)/gi, &apos;x.prev&apos;)
	buf = buf.replace(/GetT(T,-1,1,1)/gi, &apos;x.prev&apos;)
	buf = buf.replace(/\(MaxT\)/g, &apos;(x.last)&apos;)//only replace Function(MaxT) into  Function(x.last)

	//TODO: same as TSY?
	buf = buf.replace(/TsY\(LastTinPeriod\)/gi, &apos;TsY&apos;)
	buf = buf.replace(/TsY\(T\)/gi, &apos;x.tsy&apos;)
	buf = buf.replace(/\[0\]/g, &apos;.title &apos;)
	/*buf = buf.replace(/Visible\((\w+)\)/gi, &apos;$1.visible&apos;)  ; Is done in ASTPreparser.js*/

	//(&amp; types
	buf = buf.replace(/(=|,|\()\s{0,4}\&amp;/gm, &apos; $1 &apos;)// replace all &apos;=   &amp;&apos; and &apos;(  &amp;&apos;   with = or ( respectively
	buf = buf.replace(/\(\s*not /gim, &apos;(!&apos;)//this of course only tackles the half of it
	buf = buf.replace(/^\s*&amp;/gm, &apos;&apos;)

	//AND &amp;
	buf = buf.replace(/&amp;/gmi, &apos;+&apos;)// convert &amp; to &amp;&amp;
	buf = buf.replace(/ And /gmi, &apos;&amp;&amp;&apos;)// convert &amp; to &amp;&amp;
	buf = buf.replace(/\)\s*and\s*\(/gmi, &apos;)&amp;&amp;(&apos;)// convert )  and ( =&gt; &amp;&amp;

	buf = buf.replace(/\s*&amp;&amp;not\s*/gmi, &apos;&amp;&amp; !&apos;)// convert )  and ( =&gt; &amp;&amp;

	//OR |
	buf = buf.replace(/\||\s+or /gmi, &apos; || &apos;)// convert | to ||
	buf = buf.replace(/ Or /gmi, &apos; || &apos;)// convert OR to ||
	buf = buf.replace(/\)\s*or\s*\(/gim, &apos;)||(&apos;)

	//fix = to == when &lt;=
	buf = buf.replace(/=/gm, &apos;==&apos;)// convert = to ==
	buf = buf.replace(/&lt;==/gm, &apos;&lt;=&apos;)
	buf = buf.replace(/&gt;==/gm, &apos;&gt;=&apos;)
	buf = buf.replace(/&lt;&gt;/gm, &apos;!=&apos;)
	buf = buf.replace(/&lt;-&gt;/gm, &apos;!=&apos;)
	buf = buf.replace(/ Implies /g, &apos;&amp;&amp;&apos;)
	buf = buf.replace(/ mod /g, &apos; % &apos;)

	return buf
}

//finFormulaGeneric(&apos;[(VATPaymentFraction[GetT(T,-1)]&gt;0)*(Round(VATPaymentFraction[GetT(T,-1)],0)=VATPaymentFraction[GetT(T,-1)])]&apos;))
function javaScriptToFinGeneric(buf) {
	var buf = buf.replace(/!=/gm, &apos;&lt;&gt;&apos;)
	//buf = buf.replace(/&lt;=/gm, &apos;&lt;==&apos;);
	//buf = buf.replace(/&gt;=/gm, &apos;&gt;==&apos;);
	buf = buf.replace(/==/gm, &apos;=&apos;)// convert = to ==
	buf = buf.replace(/\|\|/gmi, &apos; | &apos;)// convert | to ||
	buf = buf.replace(/&amp;&amp;/gmi, &apos; &amp; &apos;)// convert )  and ( =&gt; &amp;&amp;
	return buf
}

//if it ends up being impossible to resolve generic
//we will have to do it in the formula-bootstrap.js
//there we know what is a Variable name
function finChoice(formula) {
	/**
	 * Sometimes FFL is converted incorrectly with a trailing &apos;\&apos;&apos;
	 * This is bugfixing the problem
	 */
	formula = formula.replace(/\\&apos;&apos;$/g, &apos;\&apos;&apos;)

	//looks like a variable reference
	if (/^[a-z0-9_ ]+$/i.test(formula)) {
		return formula + &apos;.choices&apos;
	}
	//tricky one is just
	//three options
	//Directly with mm/dd/yy
	else if (formula.indexOf(&apos;|&apos;) &lt; 0 &amp;&amp; formula.indexOf(&apos;:&apos;) &lt; 0) {
		const cleanslice = formula.slice(1, -1)
		return &apos;[{ &quot;name&quot;: &quot;&apos; + cleanslice + &apos;&quot;, &quot;value&quot;: &quot;&apos; + cleanslice + &apos;&quot; }]&apos;
	}
	//NL|USA|BEL|GER
	else if (formula.indexOf(&apos;:&apos;) &lt; 0) {
		var split = formula.split(&apos;|&apos;)
		//remove a trailing and leading &quot; character.
		split[0] = split[0].slice(1)
		split[split.length - 1] = split[split.length - 1].slice(0, -1)

		split = split.map(function(e, idx) {
			return &apos;{ &quot;name&quot;: &quot;&apos; + idx + &apos;&quot; ,&quot;value&quot;:&apos; + (e ? &apos;&quot;&apos; + e + &apos;&quot;&apos; : null) + &apos;}&apos;
		})
		return &apos;[&apos; + split.join(&apos;,&apos;) + &apos;]&apos;
	}
	//HIGH:1|LOW:2|UNKNOWN:3
	else {
		formula = formula.trim().slice(1, -1)
		var choices = formula.replace(/&apos;/gmi, &apos;&apos;)
		choices = choices.replace(/: /g, &apos;:&apos;)
		choices = choices.replace(/:/gmi, &apos;\&quot; , \&quot;value\&quot; : \&quot;&apos;)
		choices = choices.replace(/\|/gmi, &apos;\&quot;} , { \&quot;name\&quot; :\&quot;&apos;)
		return &apos;[{ &quot;name&quot; : &quot;&apos; + choices + &apos;&quot; }]&apos;
	}
}

function FinFormula() {
}

FinFormula.prototype.toJavascriptChoice = function(choiceObjectString) {
	var choiceObject = JSON.parse(choiceObjectString.replace(/&apos;/gmi, &apos;&quot;&apos;))
	var response = &apos;&apos;
	for (var i = 0; i &lt; choiceObject.length; i++) {
		var choiceItem = choiceObject[i]
		if (i !== 0) {
			response += &apos;|&apos;
		}
		response += choiceItem.name + &apos;|&apos; + choiceItem.value
	}
	return response
}

FinFormula.prototype.finFormulaGeneric = finFormulaGeneric
FinFormula.prototype.javaScriptToFinGeneric = javaScriptToFinGeneric
FinFormula.prototype.parseFormula = finFormulaGeneric
FinFormula.prototype.finChoice = finChoice

//something more usefull came to mind, catches this large chunk of possibilities.
//&gt;&gt; old version would look like : buf = buf.replace(/Q_Map([0-9]{2})/gi, &apos;Q_MAP$1&apos;)9;
FinFormula.prototype.fixCasing = function(buf) {
	return buf.replace(/[^\w]{1}(Q_\w*)/gmi, function($1) {
		return $1.toUpperCase()
	})
}
export { FinFormula }</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
