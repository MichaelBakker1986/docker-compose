<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">ffl/RegisterToFFL.js | ffl-pack</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="core package converting ffl"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="ffl-pack"><meta property="twitter:description" content="core package converting ffl"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/DeltaCompareRegister.js~DeltaCompareRegister.html">DeltaCompareRegister</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/Register.js~Register.html">Register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/RegisterToJSON.js~RegisterToJSON.html">RegisterToJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-FinFormula">FinFormula</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RegisterToFFL">RegisterToFFL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">ffl/RegisterToFFL.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Used in front-end to reassemble the FFL file when needed.
 * extract underlying data-model
 * make an register, schema - indexed with array values
 * Can expand while adding more properties and keeps its integrity
 * schema and nodes
 * re-use over implementations
 * @param {Register} register
 */
function RegisterToFFL(register) {
	this.schema = register.schema
	this.constants = register.constants
	register.createIndex(&apos;name&apos;)
	this.vars = register.getIndex(&apos;name&apos;)
	this.child = {}
	this.nameIndex = register.schemaIndexes.name
	this.descIndex = register.schemaIndexes.desc
	this.startIndex = register.schemaIndexes.start
	this.endIndex = register.schemaIndexes.end
	this.tree_index = register.schemaIndexes.tree_index
	this.parentNameIndex = register.schemaIndexes.parentId
	this.stringIndex = register.schemaIndexes.index
	this.modifierIndex = register.schemaIndexes.modifier
	this.referstoIndex = register.schemaIndexes.refersto
	this.tupleIndex = register.schemaIndexes.tuple
	this.displaytypeIndex = register.schemaIndexes.displaytype
	this.visibleIndex = register.schemaIndexes.visible
	this.decimalsIndex = register.schemaIndexes.fixed_decimals
	this.datatypeIndex = register.schemaIndexes.datatype
	this.frequencyIndex = register.schemaIndexes.frequency
	this.options_titleIndex = register.schemaIndexes.options_title
	this.formulaindex = register.schemaIndexes.formula
	this.lockedIndex = register.schemaIndexes.locked
	this.requiredIndex = register.schemaIndexes.required
	this.childIndex = register.schemaIndexes.children
	this.schema_indexes = register.schemaIndexes
	const { nameIndex, modifier, refersto, tuple } = register.schemaIndexes
	this.output = &apos;&apos;
	this.delimiter = &apos;;&apos;
	this.line_delimiter = &apos;\n&apos;
	//some properties are generated for the tree structure, and cannot be changes manually
	this.variableProperties = [nameIndex, modifier, refersto, tuple]
	this.hiddenProperties = [this.startIndex, this.endIndex, this.tree_index, this.stringIndex, this.schema.indexOf(&apos;version&apos;), this.schema.indexOf(&apos;type&apos;), this.schema.indexOf(&apos;parent_name&apos;), this.parentNameIndex, this.childIndex, this.descIndex]
	this.indents = []
	const depth = 30
	for (let i = 0; i &lt; depth; i++) this.indents[i] = new Array(i).join(&apos; &apos;)
	this.relevant = []
	for (let i = 0; i &lt; this.schema.length; i++) {
		if ((this.hiddenProperties.indexOf(i) === -1) &amp;&amp; (this.variableProperties.indexOf(i) === -1)) {
			this.relevant.push(i)
		}
	}
	//creating indents + brackets
	const shiftindent = []
	for (let i = 0; i &lt; depth; i++) {
		shiftindent[i] = []
		for (let j = 0; j &lt;= i; j++) {
			let item = []
			for (let k = 0; k &lt;= j; k++) {
				item.push(new Array(i - k).join(&apos; &apos;))
				item.push(&apos;}\n&apos;)
			}
			shiftindent[i][j] = item.join(&apos;&apos;)
		}
	}

	this.shiftindent = shiftindent
	const formulas = [&apos;valid&apos;, &apos;title&apos;, &apos;hint&apos;, &apos;locked&apos;, &apos;visible&apos;, &apos;required&apos;, &apos;choices&apos;]
	this.formulaIndexes = formulas.map(formula =&gt; register.schemaIndexes[formula])
	this.defaultValues = []
	this.defaultValues[this.visibleIndex] = {
		undefined: true,
		null     : true,
		&apos;1.0&apos;    : true,
		&apos;1&apos;      : true,
		&apos;true&apos;   : true,
		&apos;On&apos;     : true
	}
	this.defaultValues[this.lockedIndex] = {
		undefined: true,
		null     : true,
		&apos;0.0&apos;    : true,
		&apos;0&apos;      : true,
		&apos;false&apos;  : true,
		&apos;Off&apos;    : true,
		&apos;No&apos;     : true
	}
	this.defaultValues[this.requiredIndex] = this.defaultValues[this.lockedIndex]
}

RegisterToFFL.prototype.toGeneratedCommaSeperated = function(rooNodeName = &apos;root&apos;) {
	const { delimiter, hiddenProperties, indents, vars } = this
	const lines = []
	this.walk(vars[rooNodeName], 0, (variable, depth) =&gt; lines.push([indents[depth], variable.filter((value, index) =&gt; hiddenProperties.indexOf(index) === -1)].join(delimiter)))
	this.output = lines.join(this.line_delimiter)
	return this.output
}
RegisterToFFL.prototype.toCSV = function({ rootVariableName = &apos;root&apos; }) {
	const { delimiter, hiddenProperties, vars, schema } = this
	return [
		schema.filter((value, index) =&gt; hiddenProperties.indexOf(index) === -1).join(delimiter),
		... this.walk(vars[rootVariableName], 0, variable =&gt; variable.filter((value, index) =&gt; hiddenProperties.indexOf(index) === -1).join(delimiter))
	]
}
RegisterToFFL.prototype.walk = function(node, depth, visitor, initial = []) {
	initial.push(visitor(node, depth))
	const c = node[this.childIndex]
	for (let i = 0; i &lt; c.length; i++) this.walk(c[i], depth + 1, visitor, initial)
	return initial
}
RegisterToFFL.prototype.validate = function(line) {
	return (this.schema.length - this.hiddenProperties.length) === ((line.match(/;/g) || []).length + 1)
}
/**
 *  Complex situation.
 *  Convert Register to FFL.
 *    -- internationalization happens here, &apos;constants&apos;
 */
RegisterToFFL.prototype.toGeneratedFFL = function({ rootVariableName = &apos;root&apos;, noChildren = false, auto_join = false }) {
	const formattedFFL = []
	const traverse = !noChildren
	const { modifierIndex, nameIndex, indents, constants, relevant, schema, shiftindent, tupleIndex } = this
	const { type, title = nameIndex, refersto } = this.schema_indexes
	const tuple = &apos;tuple &apos;, variable = &apos;variable &apos;, model = &apos;model &apos;, ref_postfix = &apos; refers to &apos;

	let curr_depth = 0
	const rootNode = this.vars[rootVariableName]
	const visitor = function(node, depth) {
		const items = []
		const model_node = node[type] === &apos;m&apos;
		if (curr_depth &gt;= depth) items.push(shiftindent[curr_depth][(curr_depth - depth)])
		items.push(indents[depth])
		items.push(node[tupleIndex] ? tuple : (model_node ? model : variable))
		items.push(node[modifierIndex] || &apos;&apos;)
		items.push(model_node ? node[title] + &apos; uses BaseModel&apos; : node[nameIndex])
		if (refersto !== -1 &amp;&amp; node[refersto]) items.push(ref_postfix, node[refersto])
		items.push(&apos;\n&apos;, indents[depth])

		const props = []
		for (let i = 0; i &lt; relevant.length; i++) {
			const real = relevant[i]
			if (node[real]) props.push([indents[depth + 1], schema[real], &apos;: &apos;, node[real], &apos;;&apos;].join(&apos;&apos;))
		}
		if (props.length &gt; 0) items.push(&apos;{\n&apos;, props.join(&apos;\n&apos;))
		else items.push(&apos;{&apos;)
		curr_depth = depth
		formattedFFL.push(items.join(&apos;&apos;))
	}
	if (traverse) this.walk(rootNode, 1, visitor)
	else visitor(rootNode, 1)

	formattedFFL.push(shiftindent[curr_depth][curr_depth - 1])
	if (!rootVariableName) formattedFFL.shift()
	const translated = formattedFFL.map(ffl =&gt; ffl.replace(/__(\d+)/gm, $1 =&gt; constants[parseInt($1.substring(2))]))
	return auto_join ? translated.join(&apos;\n&apos;) : translated
}
export { RegisterToFFL }</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
