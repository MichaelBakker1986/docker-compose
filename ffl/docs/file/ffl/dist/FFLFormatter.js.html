<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">ffl/dist/FFLFormatter.js | ffl-pack</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="core package converting ffl"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="ffl-pack"><meta property="twitter:description" content="core package converting ffl"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/DeltaCompareRegister.js~DeltaCompareRegister.html">DeltaCompareRegister</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/Register.js~Register.html">Register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/RegisterToJSON.js~RegisterToJSON.html">RegisterToJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RegisterToFFL">RegisterToFFL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">ffl/dist/FFLFormatter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

function FFLFormatter(register, data) {
	this.register = register;
	register.addColumn(&apos;desc&apos;);
	this.vars = register.getIndex(&apos;i&apos;);
	this.original = data;
	this.data = data;
	this.reassembled = &apos;&apos;;
	this.constants = [];
	register.constants = this.constants;
	this.comments = [];
	this.header = &apos;&apos;;
	this.indents = [];
	for (var i = 0; i &lt; 30; i++) {
		this.indents[i] = new Array(i).join(&apos; &apos;);
	}
}

FFLFormatter.prototype.extractHeader = function () {
	this.header = this.original.substring(0, this.original.indexOf(&apos;{&apos;));

	this.register.header = this.header;
	var headerLines = this.header.split(&apos;\n&apos;);
	for (var i = 0; i &lt; headerLines.length; i++) {
		var headerLine = headerLines[i].trim();
		var modelName = void 0;
		if (modelName = headerLine.match(/^\s*model (\w+)/i)) {
			this.name = modelName[1];
			break;
		}
	}
};
FFLFormatter.prototype.extractConstants = function () {
	var index = 0;
	var constants = this.constants;
	this.data = this.data.replace(/&quot;(.*?)&quot;/gm, function ($0) {
		constants[++index] = $0;
		return &apos;__&apos; + index;
	});
};
FFLFormatter.prototype.insertConstants = function () {
	var constants = this.constants;
	this.reassembled = this.reassembled.replace(/__(\d+)/gm, function ($1, $2) {
		return constants[parseInt($2)];
	});
};
FFLFormatter.prototype.extractComments = function () {
	var comments = {};
	var index = 0;
	this.data = this.data.replace(/\/\/.*/gm, function ($0) {
		comments[++index] = $0;
		return &apos;____&apos; + index;
	});
	this.comments = comments;
};

FFLFormatter.prototype.removeWhite = function () {
	this.data = this.data.replace(/\s\s+/g, &apos; &apos;).replace(/;\s+/g, &apos;;&apos;);
};
FFLFormatter.prototype.extractVars = function () {
	var noneexit = true;
	var data = this.data;
	var index = 0;
	var register = this.register;
	while (noneexit) {
		noneexit = false;
		data = data.replace(/{([^}{]*?)}/gm, function ($0, $1, $2) {
			noneexit = true;
			var index = register.addRow([$1, $2, $0.length + $2]);
			return &apos;___&apos; + index;
		});
	}
};
FFLFormatter.prototype.findRootVariable = function () {
	return this.register.lastRowIndex();
};
FFLFormatter.prototype.buildTree = function () {
	this.extractHeader();
	this.extractConstants();
	this.extractComments();
	this.removeWhite();
	this.extractVars();
	var firstVar = this.findRootVariable();
	this.reassembled = this.prettyFormatFFL(2, firstVar);
	this.insertConstants();
};
FFLFormatter.prototype.walk = function (visit) {
	this.extractHeader();
	this.extractConstants();
	this.extractComments();
	this.removeWhite();
	this.extractVars();
	var firstVar = this.register.lastRowIndex();
	var firstRow = this.vars[firstVar];
	firstRow[0] = firstRow[0].replace(/^\s*root\s*/gi, &apos;variable root &apos;).trim();

	firstRow.push(&apos;root&apos;, firstVar, null, null, null, null, 0, []);
	this.walkTree(visit, firstVar, 1);
};
FFLFormatter.prototype.walkTree = function (visit, parentId, depth) {
	var self = this;
	var parts = this.vars[parentId][0].trim().split(&apos;;&apos;);
	var children = 0;
	if (parts[parts.length - 1] === &apos;&apos;) {
		parts.length--;
	} else {
		var temp = parts[parts.length - 1];
		parts.length--;
		temp.replace(/((?!( variable | tuple )).)+/gm, function ($1) {
			var refIdStartIndex = $1.indexOf(&apos;___&apos;);
			var varDesc = $1.substring(0, refIdStartIndex - 1);
			var tuple = varDesc.startsWith(&apos;tuple&apos;);
			var referIdx = varDesc.toLowerCase().indexOf(&apos;refers to&apos;);
			var referstoVariableName = referIdx != -1 ? varDesc.substring(referIdx + 10) : null;
			var varname = tuple ? referIdx === -1 ? varDesc.substring(6) : varDesc.substring(6, referIdx) : referIdx === -1 ? varDesc.substring(9) : varDesc.substring(9, referIdx);
			var modifier = varname.startsWith(&apos;+=&apos;) ? &apos;+=&apos; : varname.startsWith(&apos;+&apos;) ? &apos;+&apos; : varname.startsWith(&apos;=&apos;) ? &apos;=&apos; : varname.startsWith(&apos;-&apos;) ? &apos;-&apos; : null;
			var name = varname.substring(modifier ? modifier.length : 0).trim();
			var varRefIndex = parseInt($1.substring(refIdStartIndex + 3));

			var variable = self.vars[varRefIndex];
			variable.push(name, varRefIndex, modifier, parentId, tuple, referstoVariableName, children++, []);

			self.vars[parentId][10].push(variable);
			self.walkTree(visit, varRefIndex, depth + 1);
			return &apos;&apos;;
		});
	}
	visit(parentId, parts);
};

FFLFormatter.prototype.prettyFormatFFL = function (depth, index) {
	var self = this;
	var indent = this.indents[depth];
	var variable = this.vars[index][0].trim();
	var parts = variable.split(&apos;;&apos;);
	var varparts = [];
	if (parts[parts.length - 1] === &apos;&apos;) {
		parts.length--;
	} else {
		var temp = parts[parts.length - 1];
		parts.length--;
		temp.replace(/((?!( variable | tuple )).)+/gm, function ($1) {
			var refId = $1.indexOf(&apos;___&apos;);
			varparts.push(indent + $1.substring(0, refId - 1) + &apos;\n&apos; + indent + &apos;{\n&apos; + self.prettyFormatFFL(depth + 1, parseInt($1.substring(refId + 3))) + &apos;\n&apos; + indent + &apos;}&apos;);
			return &apos;&apos;;
		});
	}
	var lb = &apos;;\n&apos;;
	var r;
	if (parts.length === 0) {
		if (varparts.length === 0) {
			r = &apos;&apos;;
		} else {
			r = varparts.join(&apos;\n&apos;);
		}
	} else {
		if (varparts.length === 0) {
			r = indent + parts.join(lb + indent) + &apos;;&apos;;
		} else {
			r = indent + parts.join(lb + indent) + &apos;;\n&apos; + (varparts.length &gt; 0 ? varparts.join(&apos;\n&apos;) : &apos;;&apos;);
		}
	}
	return r;
};
var formulaMapping = { inputRequired: &apos;required&apos; };
FFLFormatter.prototype.lookupConstant = function (index) {
	return this.constants[parseInt(index.substring(2))].replace(/&apos;/g, &apos;\\\&apos;&apos;).replace(/(?:\\r\\n|\\r|\\n)/g, &apos;[br]&apos;);
};
FFLFormatter.prototype.parseProperties = function (resolve_parent_name) {
	var register = this.register;
	if (resolve_parent_name) register.addColumn(&apos;parent_name&apos;);
	var index = register.getIndex(&apos;i&apos;);
	var formatter = this;
	this.walk(function (v, raw_properties) {
		for (var i = 0; i &lt; raw_properties.length; i++) {
			var p = raw_properties[i];
			var p_seperator_index = p.indexOf(&apos;:&apos;);
			var key = p.substring(0, p_seperator_index).trim();
			key = formulaMapping[key] || key;
			register.addColumn(key);
			var value = p.substring(p_seperator_index + 1).trim();

			if (value.startsWith(&apos;__&apos;)) value = formatter.lookupConstant(value);
			register.value(v, key, value);
		}
		if (resolve_parent_name) {
			var parent = register.i[v][register.schemaIndexes.parentId];
			if (parent != null) register.value(v, &apos;parent_name&apos;, register.i[parent][register.schemaIndexes.name]);
		}
	});
};
FFLFormatter.prototype.toString = function () {
	this.buildTree();
	return this.header + &apos;{\n&apos; + this.reassembled + &apos;\n}&apos;;
};

function Factory() {
	this.on = false;
}

exports.Formatter = FFLFormatter;
exports.FFLFormatter = new Factory();</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
