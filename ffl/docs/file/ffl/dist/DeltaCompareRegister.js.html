<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">ffl/dist/DeltaCompareRegister.js | ffl-pack</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="core package converting ffl"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="ffl-pack"><meta property="twitter:description" content="core package converting ffl"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/DeltaCompareRegister.js~DeltaCompareRegister.html">DeltaCompareRegister</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/Register.js~Register.html">Register</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/ffl/RegisterToJSON.js~RegisterToJSON.html">RegisterToJSON</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-RegisterToFFL">RegisterToFFL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">ffl/dist/DeltaCompareRegister.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

Object.defineProperty(exports, &quot;__esModule&quot;, {
	value: true
});
exports.default = undefined;

var _stringify = require(&apos;babel-runtime/core-js/json/stringify&apos;);

var _stringify2 = _interopRequireDefault(_stringify);

var _slicedToArray2 = require(&apos;babel-runtime/helpers/slicedToArray&apos;);

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _getIterator2 = require(&apos;babel-runtime/core-js/get-iterator&apos;);

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _keys = require(&apos;babel-runtime/core-js/object/keys&apos;);

var _keys2 = _interopRequireDefault(_keys);

var _set = require(&apos;babel-runtime/core-js/set&apos;);

var _set2 = _interopRequireDefault(_set);

var _toConsumableArray2 = require(&apos;babel-runtime/helpers/toConsumableArray&apos;);

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _classCallCheck2 = require(&apos;babel-runtime/helpers/classCallCheck&apos;);

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require(&apos;babel-runtime/helpers/createClass&apos;);

var _createClass3 = _interopRequireDefault(_createClass2);

require(&apos;array.equals&apos;);

function _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { default: obj }; }

var DeltaCompareRegister = function () {
	function DeltaCompareRegister(source_register, target_register) {
		var _this = this;

		(0, _classCallCheck3.default)(this, DeltaCompareRegister);
		this.source_to_target_property_map = [];
		this.target_to_source_property_map = [];
		this.updates = [];
		this.inserts = [];
		this.deletes = [];
		this.changes = 0;

		this.collect = function () {
			return [].concat((0, _toConsumableArray3.default)(_this.updates), (0, _toConsumableArray3.default)(_this.inserts), (0, _toConsumableArray3.default)(_this.deletes));
		};

		this.map = function (stream) {
			return _this.collect().map(stream);
		};

		this.forEach = function (stream) {
			return _this.collect().forEach(stream);
		};

		this.source_register = source_register;
		this.target_register = target_register;
	}

	(0, _createClass3.default)(DeltaCompareRegister, [{
		key: &apos;addChange&apos;,
		value: function addChange(changeType, property_name, var_name, value) {
			this[changeType].push([changeType, var_name, property_name, value]);
			this.changes++;
		}
	}, {
		key: &apos;compare&apos;,
		value: function compare() {
			this.buildSchema();
			this.checkInserts();
			this.checkDeletes();
			return this;
		}
	}, {
		key: &apos;buildSchema&apos;,
		value: function buildSchema() {
			this.source_schema = this.source_register.schema.slice();
			this.target_schema = this.target_register.schema.slice();
			var max_schema_length = Math.max(this.source_schema.length, this.target_schema.length);
			var source_schema = this.source_register.schemaIndexes,
			    target_schema = this.target_register.schemaIndexes;
			this.source_schema.length = max_schema_length;
			this.target_schema.length = max_schema_length;

			for (var i = 0; i &lt; max_schema_length; i++) {
				this.source_to_target_property_map[source_schema[this.source_schema[i]]] = target_schema[this.source_schema[i]];
				this.target_to_source_property_map[target_schema[this.target_schema[i]]] = source_schema[this.target_schema[i]];
			}
		}
	}, {
		key: &apos;checkInserts&apos;,
		value: function checkInserts() {
			var indexes = this.target_register.schemaIndexes;
			var hidden_keys = new _set2.default([indexes.parentId, indexes.index, indexes.children]);
			var source_variables = this.source_register.getIndex(&apos;name&apos;);
			var target_variables = this.target_register.getIndex(&apos;name&apos;);

			var target_variable_names = (0, _keys2.default)(target_variables);
			var _iteratorNormalCompletion = true;
			var _didIteratorError = false;
			var _iteratorError = undefined;

			try {
				for (var _iterator = (0, _getIterator3.default)(target_variable_names), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
					var variable_name = _step.value;

					var source_variable = source_variables[variable_name],
					    target_variable = target_variables[variable_name];
					if (!source_variable) {
						for (var target_property_index = 3; target_property_index &lt; target_variable.length; target_property_index++) {
							var target_property = target_variable[target_property_index];
							if (hidden_keys.has(target_property_index) || target_property == null) continue;
							this.addChange(&apos;inserts&apos;, this.target_schema[target_property_index], variable_name, target_property);
						}
					} else {
						for (var _target_property_index = 3; _target_property_index &lt; target_variable.length; _target_property_index++) {
							if (hidden_keys.has(_target_property_index)) continue;
							var sourceProperty = source_variable[this.target_to_source_property_map[_target_property_index]];
							var targetProperty = target_variable[_target_property_index];
							if (sourceProperty == null &amp;&amp; targetProperty != null) {
								this.addChange(&apos;inserts&apos;, this.target_schema[_target_property_index], variable_name, targetProperty);
							} else if (sourceProperty !== targetProperty &amp;&amp; targetProperty != null &amp;&amp; !Array.isArray(sourceProperty)) {
								this.addChange(&apos;updates&apos;, this.target_schema[_target_property_index], variable_name, targetProperty);
							}
						}
					}
				}
			} catch (err) {
				_didIteratorError = true;
				_iteratorError = err;
			} finally {
				try {
					if (!_iteratorNormalCompletion &amp;&amp; _iterator.return) {
						_iterator.return();
					}
				} finally {
					if (_didIteratorError) {
						throw _iteratorError;
					}
				}
			}
		}
	}, {
		key: &apos;checkDeletes&apos;,
		value: function checkDeletes() {
			var _this2 = this;

			var source_variables = this.source_register.getIndex(&apos;name&apos;);
			var target_variables = this.target_register.getIndex(&apos;name&apos;);

			var source_variable_names = (0, _keys2.default)(source_variables);
			var indexes = this.source_register.schemaIndexes;
			var props = this.source_schema.filter(function (val, i) {
				return i &gt; 3 &amp;&amp; i !== indexes.parentId &amp;&amp; i !== indexes.index &amp;&amp; i !== indexes.children;
			}).map(function (property_name) {
				return [indexes[property_name], property_name];
			});

			var _loop = function _loop(variable_name) {
				var source_variable = source_variables[variable_name];
				var target_variable = target_variables[variable_name];
				props.forEach(function (_ref) {
					var _ref2 = (0, _slicedToArray3.default)(_ref, 2),
					    source_variable_property_index = _ref2[0],
					    source_variable_property_name = _ref2[1];

					var source_property = source_variable[source_variable_property_index];
					if (!target_variable) {
						if (source_property != null) _this2.addChange(&apos;deletes&apos;, source_variable_property_name, variable_name, null);
					} else {
						var target_property = target_variable[_this2.source_to_target_property_map[source_variable_property_index]];
						if (target_property == null &amp;&amp; source_property != null) {
							_this2.addChange(&apos;deletes&apos;, source_variable_property_name, variable_name, null);
						}
					}
				});
			};

			var _iteratorNormalCompletion2 = true;
			var _didIteratorError2 = false;
			var _iteratorError2 = undefined;

			try {
				for (var _iterator2 = (0, _getIterator3.default)(source_variable_names), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
					var variable_name = _step2.value;

					_loop(variable_name);
				}
			} catch (err) {
				_didIteratorError2 = true;
				_iteratorError2 = err;
			} finally {
				try {
					if (!_iteratorNormalCompletion2 &amp;&amp; _iterator2.return) {
						_iterator2.return();
					}
				} finally {
					if (_didIteratorError2) {
						throw _iteratorError2;
					}
				}
			}
		}
	}, {
		key: &apos;toString&apos;,
		value: function toString() {
			var diff = this.map(function (change_set) {
				return change_set.map(function (change) {
					return change.filter(Boolean).join(&apos;;&apos;);
				}).join(&apos;\n&apos;);
			});
			return [&apos;Changes:&apos; + this.changes, (0, _stringify2.default)(this.target_register.schemaIndexes), diff.filter(Boolean).join(&apos;\n&apos;)].join(&apos;\n&apos;);
		}
	}]);
	return DeltaCompareRegister;
}();

exports.default = DeltaCompareRegister;</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
